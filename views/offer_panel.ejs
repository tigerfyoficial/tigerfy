<%- include('partials/visual_hottrack') %>

<div class="tf-offer">
  <!-- breadcrumb + header minimal -->
  <nav class="tf-bc">
    <a href="/ofertas">Minhas Ofertas</a> <span>›</span> <span><%= offer.name %></span>
  </nav>

  <header class="tf-head">
    <div>
      <h1><%= offer.name %></h1>
      <p>ID: <%= offer.id %></p>
    </div>
    <div class="tf-status <%= offer.status %>">
      <%= offer.status === 'ativo' ? 'Ativo' : (offer.status === 'incompleto' ? 'Incompleto' : 'Erro') %>
    </div>
  </header>

  <!-- bot identity compacto -->
  <section class="tf-id">
    <form method="POST" action="/ofertas/<%= offer.id %>/token" class="tf-id-grid">
      <div class="tf-field">
        <label>Username (sem @)</label>
        <input type="text" name="telegramUsername" value="<%= (offer.telegramUsername||'').replace(/^@/,'') %>" placeholder="seu_bot_exemplo_bot">
      </div>
      <div class="tf-field">
        <label>Token do Bot</label>
        <input type="text" name="botToken" value="<%= offer.botToken||'' %>" placeholder="123:AAAA...">
      </div>
      <button class="tf-btn tf-btn-primary">Salvar</button>
    </form>
  </section>

  <!-- STEPS - fluxo vertical e minimal -->
  <main class="tf-steps">

    <!-- ========== STEP 1: Copy principal ========== -->
    <section class="tf-step" id="step-copy">
      <div class="tf-step-head">
        <div>
          <h3>STEP 1 — Copy Principal do Bot</h3>
          <p>Mensagem principal enviada no <code>/start</code>.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#copyMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="copy">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body">
        <div class="tf-field">
          <label>Mensagem</label>
          <textarea id="copyText" placeholder="Escreva a mensagem de boas-vindas, CTAs, etc."></textarea>
        </div>

        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="copyMedia" type="url" placeholder="https://t.me/...">
        </div>

        <div class="tf-step-footer">
          <div class="tf-inline">
            <div class="tf-field small">
              <label>Entregável (link)</label>
              <input id="copyDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
            </div>

            <div class="tf-field xsmall">
              <label>Auto-deletar (seg)</label>
              <input id="copyDelSec" type="number" min="0" placeholder="0 = não deletar">
            </div>

            <div class="tf-field xsmall">
              <label>Apagar ao próximo passo</label>
              <label class="tf-switch">
                <input id="copyDelNext" type="checkbox"><span></span>
              </label>
            </div>

            <div class="tf-field xsmall">
              <label>Apagar ao novo /start</label>
              <label class="tf-switch">
                <input id="copyDelStart" type="checkbox"><span></span>
              </label>
            </div>

            <div class="tf-field track">
              <label>Traqueamento</label>
              <div class="tf-track">
                <label><input type="radio" name="copyTrack" value="fb" checked><i>Facebook Pixel</i></label>
                <label><input type="radio" name="copyTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
                <label><input type="radio" name="copyTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
              </div>
            </div>
          </div>

          <div class="tf-cloaker">
            <div>
              <strong>Cloaker de Copy (em breve)</strong>
              <p class="muted">Impede clonagem automática; adiciona caracteres aleatórios se tentarem copiar suas mensagens.</p>
            </div>
            <label class="tf-switch">
              <input id="copyCloak" type="checkbox" disabled><span></span>
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== STEP 2: Botão CTA (opcional) ========== -->
    <section class="tf-step" id="step-cta">
      <div class="tf-step-head">
        <div>
          <h3>STEP 2 — Botão de CTA (opcional)</h3>
          <p>Exibe um botão adicional na mensagem principal.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#ctaMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="cta">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body grid2">
        <div class="tf-field">
          <label>Nome do botão</label>
          <input id="ctaName" type="text" placeholder="QUERO MINHA VAGA">
        </div>
        <div class="tf-field">
          <label>Link (opcional)</label>
          <input id="ctaLink" type="url" placeholder="https://...">
        </div>
        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="ctaMedia" type="url" placeholder="https://t.me/...">
        </div>
      </div>

      <div class="tf-step-footer">
        <div class="tf-inline">
          <div class="tf-field small">
            <label>Entregável (link)</label>
            <input id="ctaDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
          </div>
          <div class="tf-field xsmall">
            <label>Auto-deletar (seg)</label>
            <input id="ctaDelSec" type="number" min="0" placeholder="0">
          </div>
          <div class="tf-field track">
            <label>Traqueamento</label>
            <div class="tf-track">
              <label><input type="radio" name="ctaTrack" value="fb" checked><i>Facebook Pixel</i></label>
              <label><input type="radio" name="ctaTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
              <label><input type="radio" name="ctaTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== STEP 3: Orderbump ========== -->
    <section class="tf-step" id="step-ob">
      <div class="tf-step-head">
        <div>
          <h3>STEP 3 — Orderbump (ilimitados)</h3>
          <p>Cards minimalistas com título, copy e mídia.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-primary" data-add-ob>+ Adicionar Orderbump</button>
        </div>
      </div>

      <div class="tf-ob-list" id="obList">
        <!-- itens são injetados via JS (mock) -->
      </div>
    </section>

    <!-- ========== STEP 4: Mensagem do PIX ========== -->
    <section class="tf-step" id="step-pix">
      <div class="tf-step-head">
        <div>
          <h3>STEP 4 — Mensagem do PIX</h3>
          <p>Inclua a variável obrigatória <code>((pix))</code> para copiar/colar automático.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#pixMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="pix">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body">
        <div class="tf-field">
          <label>Mensagem (deve conter <code>((pix))</code>)</label>
          <textarea id="pixText" placeholder="Ex.: Pague agora usando o código: ((pix))"></textarea>
        </div>
        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="pixMedia" type="url" placeholder="https://t.me/...">
        </div>

        <div class="tf-step-footer">
          <div class="tf-inline">
            <div class="tf-field small">
              <label>Entregável (link)</label>
              <input id="pixDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
            </div>
            <div class="tf-field xsmall">
              <label>Auto-deletar (seg)</label>
              <input id="pixDelSec" type="number" min="0" placeholder="0">
            </div>
            <div class="tf-field track">
              <label>Traqueamento</label>
              <div class="tf-track">
                <label><input type="radio" name="pixTrack" value="fb" checked><i>Facebook Pixel</i></label>
                <label><input type="radio" name="pixTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
                <label><input type="radio" name="pixTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== STEP 5: Upsell ========== -->
    <section class="tf-step" id="step-upsell">
      <div class="tf-step-head">
        <div>
          <h3>STEP 5 — Upsell</h3>
          <p>Oferta premium após a compra.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#upMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="upsell">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body grid2">
        <div class="tf-field">
          <label>Título</label>
          <input id="upTitle" type="text" placeholder="Oferta Premium X">
        </div>
        <div class="tf-field">
          <label>Valor (opcional)</label>
          <input id="upPrice" type="text" placeholder="R$ 29,90">
        </div>
        <div class="tf-field">
          <label>Copy</label>
          <textarea id="upCopy" placeholder="Benefícios, urgência, CTA..."></textarea>
        </div>
        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="upMedia" type="url" placeholder="https://t.me/...">
        </div>
      </div>

      <div class="tf-step-footer">
        <div class="tf-inline">
          <div class="tf-field small">
            <label>Entregável (link)</label>
            <input id="upDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
          </div>
          <div class="tf-field xsmall">
            <label>Auto-deletar (seg)</label>
            <input id="upDelSec" type="number" min="0" placeholder="0">
          </div>
          <div class="tf-field track">
            <label>Traqueamento</label>
            <div class="tf-track">
              <label><input type="radio" name="upTrack" value="fb" checked><i>Facebook Pixel</i></label>
              <label><input type="radio" name="upTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
              <label><input type="radio" name="upTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== STEP 6: Downsell ========== -->
    <section class="tf-step" id="step-downsell">
      <div class="tf-step-head">
        <div>
          <h3>STEP 6 — Downsell</h3>
          <p>Oferta alternativa com preço reduzido.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#downMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="downsell">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body grid2">
        <div class="tf-field">
          <label>Título</label>
          <input id="downTitle" type="text" placeholder="Oferta Alternativa Y">
        </div>
        <div class="tf-field">
          <label>Valor (opcional)</label>
          <input id="downPrice" type="text" placeholder="R$ 19,90">
        </div>
        <div class="tf-field">
          <label>Copy</label>
          <textarea id="downCopy" placeholder="Benefícios, condição, CTA..."></textarea>
        </div>
        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="downMedia" type="url" placeholder="https://t.me/...">
        </div>
      </div>

      <div class="tf-step-footer">
        <div class="tf-inline">
          <div class="tf-field small">
            <label>Entregável (link)</label>
            <input id="downDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
          </div>
          <div class="tf-field xsmall">
            <label>Auto-deletar (seg)</label>
            <input id="downDelSec" type="number" min="0" placeholder="0">
          </div>
          <div class="tf-field track">
            <label>Traqueamento</label>
            <div class="tf-track">
              <label><input type="radio" name="downTrack" value="fb" checked><i>Facebook Pixel</i></label>
              <label><input type="radio" name="downTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
              <label><input type="radio" name="downTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== STEP 7: Disparo / Follow-up ========== -->
    <section class="tf-step" id="step-follow">
      <div class="tf-step-head">
        <div>
          <h3>STEP 7 — Disparo / Follow-up</h3>
          <p>Agendamentos, condições e mensagens por segmento.</p>
        </div>
        <div class="tf-step-actions">
          <button class="tf-btn tf-btn-ghost" data-insert-media="#fupMedia">Inserir mídia (Telegram)</button>
          <button class="tf-btn tf-btn-primary" data-save="follow">Salvar</button>
        </div>
      </div>

      <div class="tf-step-body">
        <div class="tf-inline">
          <div class="tf-field small">
            <label>Agendamento</label>
            <select id="fupWhen">
              <option value="1h">1 hora</option>
              <option value="6h">6 horas</option>
              <option value="24h" selected>24 horas</option>
              <option value="3d">3 dias</option>
            </select>
          </div>
          <div class="tf-field small">
            <label>Condição</label>
            <select id="fupCond">
              <option value="nao_pagou" selected>Não pagou</option>
              <option value="abandonou">Abandonou</option>
              <option value="pagou">Pagou</option>
            </select>
          </div>
        </div>

        <div class="tf-field">
          <label>Copy</label>
          <textarea id="fupCopy" placeholder="Mensagem de follow-up..."></textarea>
        </div>
        <div class="tf-field">
          <label>Link de mídia (opcional)</label>
          <input id="fupMedia" type="url" placeholder="https://t.me/...">
        </div>

        <div class="tf-step-footer">
          <div class="tf-inline">
            <div class="tf-field small">
              <label>Entregável (link)</label>
              <input id="fupDeliver" type="url" placeholder="https://exemplo.com/obrigado?...">
            </div>
            <div class="tf-field xsmall">
              <label>Auto-deletar (seg)</label>
              <input id="fupDelSec" type="number" min="0" placeholder="0">
            </div>
            <div class="tf-field track">
              <label>Traqueamento</label>
              <div class="tf-track">
                <label><input type="radio" name="fupTrack" value="fb" checked><i>Facebook Pixel</i></label>
                <label><input type="radio" name="fupTrack" value="utm_fb"><i>UTMify + Facebook</i></label>
                <label><input type="radio" name="fupTrack" value="utm_utm"><i>UTMify + UTMify</i></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <div class="tf-bottom">
    <a class="tf-btn tf-btn-secondary" href="/ofertas">Voltar</a>
  </div>
</div>

<style>
  :root{
    --gold:#ffcc00; --gold2:#d4a100; --bg:#0b0b0b; --card:rgba(12,12,12,.78);
    --muted:#a9a9a9; --line:rgba(255,204,0,.12); --line2:rgba(255,255,255,.10);
    --shadow:0 10px 40px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.03) inset;
    --glow:0 0 24px rgba(255,204,0,.10);
  }

  .tf-offer{max-width:1100px;margin:0 auto;padding:56px 24px 90px;color:#fff}
  .tf-bc{display:flex;gap:8px;color:#bbb;margin-bottom:12px}
  .tf-bc a{color:#ddd;text-decoration:none}
  .tf-bc a:hover{color:#fff}

  .tf-head{display:flex;justify-content:space-between;align-items:end;margin-bottom:18px}
  .tf-head h1{margin:0;color:var(--gold);font-size:1.9rem}
  .tf-head p{margin:4px 0 0;color:#888}
  .tf-status{padding:6px 12px;border-radius:999px;border:1px solid var(--line)}
  .tf-status.ativo{background:rgba(0,255,120,.14);color:#51ff9e;border-color:rgba(0,255,120,.32)}
  .tf-status.incompleto{background:rgba(255,204,0,.12);color:#ffd86a}
  .tf-status.erro{background:rgba(255,0,80,.14);color:#ff7aa4}

  .tf-id{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow),var(--glow);padding:14px;margin-bottom:18px}
  .tf-id-grid{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:end}

  .tf-field label{display:block;margin-bottom:6px;font-size:.9rem;color:#eaeaea}
  .tf-field input,.tf-field textarea,.tf-field select{
    width:100%;border-radius:12px;border:1px solid var(--line2);
    background:rgba(255,255,255,.03);color:#fff;padding:11px 12px;outline:none;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)
  }
  .tf-field textarea{min-height:130px;resize:vertical}
  .tf-field input:focus,.tf-field textarea:focus,.tf-field select:focus{
    border-color:var(--gold); box-shadow:0 0 0 1px rgba(255,204,0,.25), inset 0 0 0 1px rgba(255,204,0,.06)
  }
  .tf-field.small{min-width:280px}
  .tf-field.xsmall{min-width:180px}
  .tf-field.track{min-width:340px}

  .tf-btn{border:1px solid var(--line2);background:transparent;color:#eee;padding:10px 16px;border-radius:12px;cursor:pointer}
  .tf-btn:hover{border-color:rgba(255,255,255,.28)}
  .tf-btn-primary{border:none;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#1a1300;font-weight:700;box-shadow:0 0 14px rgba(255,204,0,.35)}
  .tf-btn-secondary{background:rgba(255,255,255,.06);text-decoration:none}
  .tf-btn-ghost{background:transparent;border:1px solid var(--line);color:#e9e9e9}

  .tf-steps{display:flex;flex-direction:column;gap:16px}
  .tf-step{
    background:radial-gradient(1200px 300px at 20% -10%,rgba(255,204,0,.06),transparent 45%) , var(--card);
    border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow),var(--glow);padding:16px 16px 12px
  }
  .tf-step-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .tf-step-head h3{margin:0;color:var(--gold);font-size:1.05rem;letter-spacing:.2px}
  .tf-step-head p{margin:4px 0 0;color:#bdbdbd}
  .tf-step-actions{display:flex;gap:10px}
  .tf-step-body{display:flex;flex-direction:column;gap:12px}
  .tf-step-body.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .tf-step-footer{border-top:1px dashed rgba(255,255,255,.10);margin-top:6px;padding-top:12px}
  .tf-inline{display:flex;flex-wrap:wrap;gap:12px;align-items:end}

  /* tracking segmented */
  .tf-track{display:flex;gap:8px;background:rgba(255,255,255,.04);padding:6px;border-radius:12px;border:1px solid var(--line2)}
  .tf-track label{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;cursor:pointer}
  .tf-track input{appearance:none;width:14px;height:14px;border:1px solid rgba(255,255,255,.6);border-radius:50%}
  .tf-track input:checked{background:var(--gold);border-color:var(--gold)}
  .tf-track i{font-style:normal;color:#e8e8e8}

  /* switch */
  .tf-switch{position:relative;display:inline-block;width:46px;height:26px}
  .tf-switch input{display:none}
  .tf-switch span{position:absolute;inset:0;background:#2b2b2b;border-radius:999px;transition:.2s;border:1px solid var(--line2)}
  .tf-switch span:after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#bfbfbf;transition:.2s}
  .tf-switch input:checked+span{background:var(--gold)}
  .tf-switch input:checked+span:after{left:23px;background:#1a1300}

  /* orderbump mini cards */
  .tf-ob-list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .tf-ob{background:rgba(255,255,255,.03);border:1px solid var(--line2);border-radius:16px;padding:12px}
  .tf-ob h4{margin:0 0 8px;color:#f1f1f1}
  .tf-ob .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tf-ob .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  .tf-cloaker{margin-top:10px;border:1px dashed rgba(255,255,255,.10);border-radius:14px;padding:10px;display:flex;align-items:center;justify-content:space-between}
  .muted{color:#9e9e9e}

  .tf-bottom{display:flex;justify-content:flex-end;margin-top:18px}

  @media (max-width:1000px){
    .tf-id-grid{grid-template-columns:1fr}
    .tf-step-body.grid2{grid-template-columns:1fr}
    .tf-ob-list{grid-template-columns:1fr}
  }
</style>

<script>
  // normaliza username sem @
  document.querySelectorAll('input[name="telegramUsername"]').forEach(i=>{
    i.addEventListener('blur',()=> i.value = i.value.replace(/^@+/,''))
  });

  // mock de "Inserir mídia" (cola no input alvo)
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-insert-media]');
    if(!btn) return;
    const target = document.querySelector(btn.dataset.insertMedia);
    if(!target) return;
    const url = prompt('Cole o link da mídia do Telegram:');
    if(url) target.value = url;
  });

  // validação PIX ((pix))
  function hasPixVar(t){ return /\(\(pix\)\)/i.test(t); }

  // mock "Salvar"
  document.addEventListener('click', (e)=>{
    const s = e.target.closest('[data-save]');
    if(!s) return;
    const step = s.dataset.save;

    if(step==='pix'){
      const txt = (document.getElementById('pixText')?.value||'').trim();
      if(!hasPixVar(txt)){
        alert('A mensagem do PIX deve conter a variável ((pix)).');
        return;
      }
    }
    // aqui você chama fetch('/api/...', {method:'POST', body:...})
    s.disabled = true;
    const prev = s.textContent;
    s.textContent = 'Salvo ✓';
    setTimeout(()=>{ s.disabled=false; s.textContent=prev; },900);
  });

  // Orderbump minimal
  const obList = document.getElementById('obList');
  function addOB(){
    const idx = (obList.querySelectorAll('.tf-ob').length + 1);
    const el = document.createElement('div');
    el.className='tf-ob';
    el.innerHTML=`
      <h4>Orderbump #${idx}</h4>
      <div class="row">
        <div class="tf-field"><label>Título</label><input type="text" placeholder="Bump ${idx}"></div>
        <div class="tf-field"><label>Mídia (link Telegram)</label><input type="url" placeholder="https://t.me/..."></div>
      </div>
      <div class="tf-field"><label>Copy</label><textarea placeholder="Copy do bump..."></textarea></div>
      <div class="tf-inline">
        <div class="tf-field small"><label>Entregável (link)</label><input type="url" placeholder="https://..."></div>
        <div class="tf-field xsmall"><label>Auto-deletar (seg)</label><input type="number" min="0" placeholder="0"></div>
        <div class="tf-field track">
          <label>Traqueamento</label>
          <div class="tf-track">
            <label><input type="radio" name="obTrack_${idx}" value="fb" checked><i>Facebook Pixel</i></label>
            <label><input type="radio" name="obTrack_${idx}" value="utm_fb"><i>UTMify + Facebook</i></label>
            <label><input type="radio" name="obTrack_${idx}" value="utm_utm"><i>UTMify + UTMify</i></label>
          </div>
        </div>
      </div>
      <div class="bar">
        <button class="tf-btn tf-btn-ghost" data-remove>Remover</button>
        <button class="tf-btn tf-btn-primary" data-save="ob">Salvar</button>
      </div>`;
    obList.appendChild(el);
  }
  document.querySelector('[data-add-ob]')?.addEventListener('click', addOB);
  obList?.addEventListener('click',(e)=>{
    if(e.target.closest('[data-remove]')){
      e.target.closest('.tf-ob')?.remove();
    }
    if(e.target.closest('[data-save="ob"]')){
      const btn = e.target.closest('button');
      btn.disabled=true; const t=btn.textContent; btn.textContent='Salvo ✓';
      setTimeout(()=>{btn.disabled=false;btn.textContent=t;},900);
    }
  });

  // inicia com um bump exemplo (vazio) para UX
  addOB();
</script>
