<%- include('partials/visual_hottrack') %>

<div class="offer-panel-container">
  <div class="tf-offer-panel">
    <nav class="tf-breadcrumb" id="tfBreadcrumb"></nav>

    <header class="tf-header">
      <div class="tf-header-left">
        <h1 class="tf-offer-title" id="offerTitle">
          <%= (currentStep && (currentStep.name || ('Etapa ' + (currentStep.stepNo || '')))) || (offer?.name || 'Nome da Oferta') %>
        </h1>
      </div>
      <div class="tf-header-right">
        <button type="button" class="tf-btn tf-btn-primary" id="btnSaveAll">Salvar Alterações</button>
      </div>
    </header>

    <!-- PILLS -->
    <div class="tf-pills-wrap">
      <div class="tf-tabs tf-tabs-main">
        <button class="tab active" data-tab="principal">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="14" width="7" height="7" rx="2"></rect><rect x="3" y="14" width="7" height="7" rx="2"></rect></svg>
          Principal
        </button>

        <button class="tab" data-tab="contingencia">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path></svg>
          Blindagem de Bots
        </button>

        <button class="tab" data-tab="tracking">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15A1.65 1.65 0 0 0 21 13.35 8 8 0 0 0 12 4a8 8 0 0 0-8 9.35A1.65 1.65 0 0 0 5.6 15"></path></svg>
          Traqueamento
        </button>

        <button class="tab" data-tab="relatorios">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M19 17V7"></path><path d="M13 17V3"></path><path d="M7 17v-7"></path></svg>
          Fluxo de Relatórios
        </button>

        <button class="tab" id="tabEtapas" data-tab="etapas">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3l9 4.5-9 4.5L3 7.5 12 3z"></path>
            <path d="M21 12l-9 4.5L3 12"></path>
            <path d="M21 16.5l-9 4.5-9-4.5"></path>
          </svg>
          Etapas
        </button>
      </div>

      <!-- SUBTABS DA ABA PRINCIPAL -->
      <div class="tf-subtabs" id="subtabs-principal">
        <button class="subtab active" data-subtab="front">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h8"></path><path d="M17 8h.01"></path><path d="M19 4v6h6"></path></svg>
          Front
        </button>

        <button class="subtab" data-subtab="orderbump" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M6 6h15l-1.5 9h-12z"></path><path d="M6 6l-1-3H2"></path><circle cx="9" cy="20" r="1"></circle><circle cx="18" cy="20" r="1"></circle><path d="M12 10h4"></path></svg>
          OrderBump
        </button>

        <button class="subtab" data-subtab="upsell" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"></path></svg>
          Upsell
        </button>

        <button class="subtab" data-subtab="downsell" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"> <path d="M3 7l6 6 4-4 8 8"></path></svg>
         Downsell 
        </button>

        <button class="subtab" data-subtab="pix">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
          Mensagem PIX
        </button>

        <button class="subtab" data-subtab="disparos" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
          Disparos
        </button>
      </div>
    </div>

    <!-- CONTEÚDO RENDERIZADO -->
    <!-- FRONT (Principal) — substituir o bloco antigo por este -->
<section id="tfFront" class="tf-front-grid">
  <!-- COLUNA ESQUERDA -->
  <div class="tf-col-left">

    <!-- CARD 1 — VSL -->
    <article class="tf-card">
      <header class="tf-card-head">
        <!-- ícone VSL (tela com play) -->
        <span class="tf-ico tf-ico-vsl" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="5" width="18" height="14" rx="2"></rect>
            <polygon points="10,9 16,12 10,15"></polygon>
          </svg>
        </span>
        <h3>VSL</h3>
      </header>

      <label class="tf-field-label">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2"></path>
          <path d="M22 12h-4"></path>
          <path d="M12 2v4"></path>
        </svg>
        Link da VSL Principal (t.me…)
      </label>
      <input id="front_vsl_link" type="url" class="tf-input"
             placeholder="https://t.me/seu_bot?start=..."
             autocomplete="off">
    </article>

    <!-- CARD 2 — Copy da VSL -->
    <article class="tf-card">
      <header class="tf-card-head">
        <!-- ícone documento/texto -->
        <span class="tf-ico" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <path d="M14 2v6h6"></path>
            <path d="M16 13H8"></path>
            <path d="M16 17H8"></path>
            <path d="M10 9H8"></path>
          </svg>
        </span>
        <h3>Copy da VSL Principal</h3>
      </header>

      <textarea id="front_vsl_copy" class="tf-textarea" rows="5"
                placeholder="Escreva a copy da VSL (mínimo visual, até 5 linhas confortáveis)…"></textarea>
    </article>

    <!-- CARD 3 — CTA opcional -->
    <article class="tf-card">
      <header class="tf-card-head">
        <!-- ícone CTA (cursor/bolt) -->
        <span class="tf-ico" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"></path>
          </svg>
        </span>
        <h3>Botão de CTA para Planos (opcional)</h3>
      </header>

      <div class="tf-switch-line">
        <label class="tf-switch">
          <input type="checkbox" id="front_cta_enabled">
          <span class="slider"></span>
        </label>
        <span>Ativado</span>
      </div>

      <label class="tf-field-label">Nome do Botão</label>
      <input id="front_cta_label" type="text" class="tf-input" placeholder="Ex.: Obter Vaga" disabled>
    </article>
  </div>

  <!-- COLUNA DIREITA (CARD 4 — Planos) -->
  <aside class="tf-col-right">
    <article class="tf-card">
      <header class="tf-card-head">
        <span class="tf-ico" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="4" rx="1"></rect>
            <rect x="3" y="10" width="18" height="4" rx="1"></rect>
            <rect x="3" y="16" width="18" height="4" rx="1"></rect>
          </svg>
        </span>
        <h3>Planos</h3>
        <button type="button" id="btnAddPlan" class="btn-primary btn-xs">Novo Plano</button>
      </header>

      <p class="tf-hint">Nenhum plano ainda. Clique em “Novo Plano”.<br>Máximo de 10 planos. Adição inline, sem mini tela.</p>
      <div id="plansList" class="tf-plans-list"></div>
    </article>
  </aside>
</section>

  </div>
</div>

<!-- MODAL ETAPAS -->
<div class="tf-steps-overlay" id="stepsUnifiedModal" hidden>
  <div class="tf-steps-dialog tf-steps-dialog--create-theme" role="dialog" aria-modal="true">
    <div class="tf-steps-head tf-steps-head--center">
      <h3>Gerenciar Etapas da Oferta</h3>
      <p class="tf-steps-sub">Crie, selecione e organize as etapas desta oferta. As alterações só são aplicadas ao clicar em <strong>Salvar mudanças</strong>.</p>
      <button type="button" class="tf-steps-close" id="btnCloseStepsUnified" aria-label="Fechar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="tf-steps-body tf-steps-body--compact">
      <div class="tf-steps-toolbar tf-steps-toolbar--tight">
        <button type="button" class="btn-secondary btn-small" id="btnAddStepUnified" title="Adicionar nova etapa">
          <span class="tf-icon-plus">＋</span>
          Criar Etapa
        </button>
        <small class="tf-hint tf-toolbar-hint">Clique em <strong>Salvar Mudanças</strong> para aplicar.</small>
      </div>

      <ul class="tf-steps-list" id="tfStepsUnifiedList" aria-label="Lista de Etapas"></ul>
    </div>

    <div class="tf-steps-actions tf-steps-actions--create-theme">
      <button type="button" class="btn-secondary" id="btnCancelStepsUnified">Cancelar</button>
      <button type="button" class="btn-primary" id="btnSaveStepsUnified">Salvar Mudanças</button>
    </div>
  </div>
</div>

<style>
  :root{
    --panel:rgba(255,255,255,0.04);
    --panel-strong:rgba(255,255,255,0.06);
    --border:rgba(255,255,255,0.12);
    --muted:#b8b8b8;
    --text:#ffffff;
    --accent:#ffcc00;
    --accent-dim:#d4a100;
    --shadow:0 8px 24px rgba(0,0,0,0.45);
    --pills-width: 980px;
    --radius: 14px;
  }

  .offer-panel-container{ width:100%; max-width:1200px; margin-left:auto; margin-right:auto; }
  .offer-panel-container .tf-offer-panel{ padding:60px 80px 100px 80px; }

  .tf-offer-panel{ color:var(--text); padding:60px 80px 100px 130px; max-width:1200px; margin:0 auto; }
  .tf-breadcrumb{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem; margin-bottom:10px; }
  .tf-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; }
  .tf-offer-title{ margin:0; font-size:1.8rem; letter-spacing:.3px; background:linear-gradient(90deg,#fff,#d8d8d8); -webkit-background-clip:text; background-clip:text; color:transparent; }

  .tf-btn{ appearance:none; border:1px solid var(--border); background:var(--panel-strong); color:#eee; padding:9px 14px; border-radius:var(--radius); cursor:pointer; font-weight:600; box-shadow:var(--shadow); transition:.18s ease; }
  .tf-btn:hover{ border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.09); }
  .tf-btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent-dim)); color:#171300; border:1px solid rgba(255,204,0,0.35); box-shadow:0 6px 22px rgba(255,204,0,0.25); }

  .tf-pills-wrap{ max-width:var(--pills-width); margin:16px auto 8px; }
  .tf-tabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  .tf-subtabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }

  .tf-tabs .tab{ display:inline-flex; align-items:center; gap:8px; padding:9px 14px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dedede; font-weight:600; font-size:.92rem; height:38px; transition:.18s ease; }
  .tf-tabs .tab.active{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.22); color:#fff; }
  .tf-subtabs .subtab{ display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dcdcdc; font-weight:600; font-size:.9rem; }
  .tf-subtabs .subtab.active{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.22); color:#fff; }

  .tf-content{ margin-top:14px; }
  .front-grid{
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:16px;
    min-height:360px;
  }
  @media (max-width: 1100px){
    .front-grid{ grid-template-columns: 1fr; }
  }
  .tf-card{
    border:1px dashed rgba(255,255,255,0.12);
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    box-shadow:var(--shadow);
    padding:14px;
  }

  .tf-section-title{
    margin:0 0 10px 0;
    font-weight:800;
    color:#ffcc00;
    display:flex; align-items:center; gap:8px;
  }
  .tf-field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
  .tf-label{ font-size:.92rem; color:#dcdcdc; display:flex; align-items:center; gap:8px; }
  .tf-input,
  .tf-textarea{
    width:100%;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.06);
    color:#fff;
    outline:none;
    font-size:.98rem;
    padding:10px 12px;
    transition:border-color .2s, box-shadow .2s;
  }
  .tf-textarea{ resize:vertical; min-height:120px; max-height:360px; }
  .tf-input:focus, .tf-textarea:focus{ border-color:#ffcc00; box-shadow:0 0 0 2px rgba(255,204,0,0.28); }

  .tf-switch{ display:inline-flex; align-items:center; gap:10px; user-select:none; }
  .tf-switch input{ display:none; }
  .tf-switch .track{
    width:44px; height:24px; border-radius:999px;
    background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.18);
    position:relative; transition:.18s ease;
  }
  .tf-switch .thumb{
    width:18px; height:18px; border-radius:999px; background:#fff; position:absolute; top:2px; left:2px; transition:.18s ease;
  }
  .tf-switch input:checked + .track{ background:linear-gradient(90deg,#ffcc00,#d4a100); border-color:rgba(255,204,0,0.45); }
  .tf-switch input:checked + .track .thumb{ left:24px; background:#171300; }

  .plans-card .plans-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;
  }
  .plan-row{
    display:grid;
    grid-template-columns: 1fr 120px 36px;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
  }
  .plan-row .kill{ height:38px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.08); color:#fff; cursor:pointer; }
  .plan-row .kill:hover{ background:rgba(255,255,255,0.12); }
  .muted{ color:#b8b8b8; font-size:.9rem; }

  /* ====== Modal de Etapas (alinhado e sem “Atual”) ====== */
  .tf-steps-overlay[hidden]{ display:none !important; }
  .tf-steps-overlay{ position:fixed; inset:0; z-index:10000; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); backdrop-filter: blur(10px); }
  .tf-steps-dialog{ width:min(720px, calc(100vw - 40px)); border-radius:20px; border:1px solid rgba(255,255,255,0.16); background:rgba(0,0,0,0.78); box-shadow:0 0 40px rgba(0,0,0,0.6); overflow:hidden; }
  .tf-steps-head{ padding:18px 20px; border-bottom:1px solid rgba(255,255,255,0.08); position:relative; text-align:center; }
  .tf-steps-head h3{ margin:0; font-size:1.2rem; color:#ffcc00; font-weight:800; }
  .tf-steps-sub{ margin:8px 0 0; color:#cfcfcf; font-size:.92rem; }
  .tf-steps-close{ position:absolute; right:12px; top:12px; border:none; background:transparent; color:#fff; cursor:pointer; opacity:.8; }
  .tf-steps-body{ padding:12px 16px; }
  .tf-steps-toolbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .tf-steps-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }

  /* Linha alinhada: arrastar | Nº | input | Acessar | Excluir */
  .tf-step-item{
    display:grid;
    grid-template-columns: 22px 32px 1fr auto auto;
    gap:10px;
    align-items:center;
    padding:10px;
    border:1px solid rgba(255,255,255,0.12);
    border-radius:12px;
    background:rgba(255,255,255,0.05);
  }
  .tf-drag-handle{ width:20px; color:#bbb; cursor:grab; display:flex; align-items:center; justify-content:center; }
  .tf-step-no{
    width:32px; height:32px; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; color:#ffcc00; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10);
  }
  .tf-step-name{ width:100%; padding:9px 10px; height:38px; border-radius:10px; border:1px solid rgba(255,255,255,0.22); background:rgba(255,255,255,0.06); color:#fff; outline:none; }
  .tf-actions-inline{ display:flex; align-items:center; gap:10px; }
  .tf-btn-ghost{ height:38px; border:1px solid rgba(255,255,255,0.18); background:transparent; color:#fff; border-radius:10px; padding:0 12px; cursor:pointer; white-space:nowrap; }
  .tf-btn-ghost.tf-access-btn{ background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300; border-color:rgba(255,204,0,0.45); }
  .tf-step-btn.danger{ height:38px; border:1px solid rgba(255,64,96,0.25); background:rgba(255,64,96,0.14); color:#ffb3c2; border-radius:10px; padding:0 12px; cursor:pointer; white-space:nowrap; }

  .tf-steps-actions{ display:flex; justify-content:flex-end; gap:12px; padding:16px; border-top:1px solid rgba(255,255,255,0.08); }
  .tf-steps-empty{ padding:10px; color:#cfcfcf; text-align:center; border:1px dashed rgba(255,255,255,0.16); border-radius:10px; }

  .btn-small{ padding:8px 12px; border:none; border-radius:10px; background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300; font-weight:700; cursor:pointer; }
  .btn-secondary{ border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer; background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,0,0.10); transition:.18s ease; }
  .btn-primary{ border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer; background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300; box-shadow:0 0 10px rgba(255,204,0,0.35); }
/* ===== Principal > Front (apenas) ===== */
.tf-front-grid{
  display:grid;
  grid-template-columns: 1fr 420px;
  gap:18px;
  margin-top:12px;
}
.tf-col-left{ display:flex; flex-direction:column; gap:14px; }
.tf-col-right{ display:flex; flex-direction:column; gap:14px; }

.tf-card{
  background: rgba(0,0,0,0.70);
  border:1px solid rgba(255,204,0,0.12);  /* SOLID: remove pontilhado */
  border-radius:16px;
  padding:14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.35);
}

.tf-card-head{
  display:flex; align-items:center; gap:10px; margin-bottom:10px;
  padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.08);
}
.tf-card-head h3{ margin:0; font-size:1.05rem; font-weight:800; color:#ffcc00; }
.tf-ico{ display:inline-flex; align-items:center; justify-content:center; color:#ffcc00; }
.tf-ico-vsl{ filter: drop-shadow(0 0 6px rgba(255,204,0,0.25)); }

.tf-field-label{
  display:flex; gap:8px; align-items:center;
  font-size:.92rem; color:#cfcfcf; margin-bottom:6px;
}

.tf-input, .tf-textarea{
  width:100%; border-radius:12px; outline:none;
  border:1px solid rgba(255,255,255,0.22);
  background:rgba(255,255,255,0.06);
  color:#fff; padding:10px 12px; font-size:.95rem;
  transition:border-color .2s, box-shadow .2s;
}
.tf-input:focus, .tf-textarea:focus{
  border-color:#ffcc00; box-shadow:0 0 0 2px rgba(255,204,0,0.28);
}

/* Switch CTA */
.tf-switch-line{ display:flex; align-items:center; gap:10px; margin:2px 0 10px; }
.tf-switch{ position:relative; width:42px; height:24px; display:inline-block; }
.tf-switch input{ display:none; }
.tf-switch .slider{
  position:absolute; inset:0; background:rgba(255,255,255,0.14);
  border:1px solid rgba(255,255,255,0.22);
  border-radius:999px; transition:.18s ease;
}
.tf-switch .slider:before{
  content:""; position:absolute; height:18px; width:18px; left:3px; top:2px;
  background:#fff; border-radius:50%; transition:.18s ease;
}
.tf-switch input:checked + .slider{
  background:linear-gradient(90deg,#ffcc00,#d4a100);
  border-color:rgba(255,204,0,0.45);
}
.tf-switch input:checked + .slider:before{ transform:translateX(18px); }

.btn-xs{ padding:8px 12px; font-size:.85rem; border-radius:10px; }

/* Planos (placeholder simples por enquanto) */
.tf-hint{ color:#cfcfcf; font-size:.92rem; }
.tf-plans-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }

/* Deixe o subtab Front com mesmo destaque do Principal quando ativo */
.tf-subtabs .subtab.active{
  background:rgba(255,255,255,0.10);
  border-color:rgba(255,255,255,0.22);
  color:#fff;
  box-shadow:0 0 18px rgba(255,204,0,0.18);
}
@media (max-width: 1100px){
  .tf-front-grid{ grid-template-columns: 1fr; }
}

/* ===== Aurum Fusion — apenas Principal > Front ===== */
.tf-front-grid { isolation: isolate; }

/* Cards com borda gradiente + brilho suave */
.tf-front-grid .tf-card{
  position: relative;
  border: 1px solid transparent;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04)) padding-box,
    linear-gradient(120deg, rgba(255,204,0,0.32), rgba(255,204,0,0.06) 35%, rgba(255,204,0,0.32)) border-box;
  box-shadow:
    0 10px 26px rgba(0,0,0,0.45),
    inset 0 1px 0 rgba(255,255,255,0.08);
  overflow: hidden;
}
.tf-front-grid .tf-card::after{
  content:"";
  position:absolute; inset:0; pointer-events:none; border-radius:16px;
  box-shadow: inset 0 0 40px rgba(255,204,0,0.06);
}
.tf-front-grid .tf-card::before{
  /* brilho que segue o mouse (ver JS) */
  content:"";
  position:absolute; inset:-2px; border-radius:18px; z-index:0; pointer-events:none;
  background: radial-gradient(140px 80px at var(--mx, 50%) var(--my, -10%),
              rgba(255,204,0,0.28), transparent 60%);
  filter: blur(14px);
  opacity:.0; transition: opacity .25s ease;
}
.tf-front-grid .tf-card:hover::before{ opacity:.9; }

/* Cabeçalho com chip dourado no ícone e linha fina */
.tf-front-grid .tf-card-head{
  position: relative; z-index:1;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding-bottom: 8px;
}
.tf-front-grid .tf-card-head .tf-ico{
  width:30px; height:30px; border-radius:12px;
  background: linear-gradient(180deg, rgba(255,204,0,0.20), rgba(0,0,0,0));
  border:1px solid rgba(255,204,0,0.38);
  box-shadow: inset 0 10px 22px rgba(255,204,0,0.18), 0 0 18px rgba(255,204,0,0.16);
  display:inline-flex; align-items:center; justify-content:center;
}
.tf-front-grid .tf-card-head h3{
  letter-spacing:.2px; text-shadow:0 0 16px rgba(255,204,0,0.16);
}

/* Inputs “glass” premium */
.tf-front-grid .tf-input,
.tf-front-grid .tf-textarea{
  background: rgba(10,10,10,0.55);
  backdrop-filter: blur(6px);
  border:1px solid rgba(255,255,255,0.16);
  box-shadow: inset 0 0 0 1px rgba(255,204,0,0);
}
.tf-front-grid .tf-input:focus,
.tf-front-grid .tf-textarea:focus{
  border-color: rgba(255,204,0,0.45);
  box-shadow: 0 0 0 3px rgba(255,204,0,0.16), inset 0 0 0 1px rgba(255,204,0,0.25);
}

/* Switch com brilho */
.tf-front-grid .tf-switch .slider{
  background: rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.22);
}
.tf-front-grid .tf-switch input:checked + .slider{
  background: linear-gradient(90deg,#ffcc00,#d4a100);
  border-color: rgba(255,204,0,0.46);
  box-shadow: 0 0 0 2px rgba(255,204,0,0.18);
}

/* Botão “Novo Plano” glam sem afetar o resto do site */
.tf-front-grid .btn-primary.btn-xs{
  border:1px solid rgba(255,204,0,0.38);
  box-shadow:
    0 0 18px rgba(255,204,0,0.28),
    inset 0 1px 0 rgba(255,255,255,0.35);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.tf-front-grid .btn-primary.btn-xs:hover{
  transform: translateY(-1px);
  filter: brightness(1.06);
  box-shadow:
    0 0 22px rgba(255,204,0,0.40),
    inset 0 1px 0 rgba(255,255,255,0.42);
}

/* Micro grade pontilhada invisível (sutil) apenas no Front */
.tf-front-grid .tf-card{
  background-image:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04)),
    radial-gradient(1px 1px at 10px 10px, rgba(255,204,0,0.06) 1px, transparent 1px);
  background-size:
    auto auto,
    24px 24px;
  background-repeat: no-repeat, repeat;
  background-clip: padding-box, border-box;
}

/* Placeholder mais legível */
.tf-front-grid ::placeholder{ color: rgba(255,255,255,0.55); }

/* Mantém destaque do subtab Front igual ao “Principal” */
.tf-subtabs .subtab.active{
  background: rgba(255,255,255,0.10);
  border-color: rgba(255,255,255,0.22);
  color:#fff;
  box-shadow: 0 0 18px rgba(255,204,0,0.18);
}

/* ============================
   TIGERFY MONOGOLD — UNIFICAÇÃO VISUAL (só estilização)
   Escopo: tela do painel da oferta
   ============================ */

.offer-panel-container .tf-offer-panel{
  --tg-bg:        rgba(12,12,12,0.88);
  --tg-surface:   rgba(20,20,20,0.72);
  --tg-surface-2: rgba(16,16,16,0.62);
  --tg-border:    rgba(255,255,255,0.12);
  --tg-border-hi: rgba(255,204,0,0.42);
  --tg-gold:      #ffcc00;
  --tg-gold-2:    #d4a100;
  --tg-text:      #ffffff;
  --tg-muted:     #b6b6b6;
  --tg-radius:    16px;
}

/* ---------- PILLS (tabs/subtabs) - padronizadas ---------- */
.offer-panel-container .tf-tabs .tab,
.offer-panel-container .tf-subtabs .subtab{
  background: var(--tg-surface-2) !important;
  border: 1px solid var(--tg-border) !important;
  color: var(--tg-text);
  height: 38px;
  padding: 9px 14px;
  border-radius: 999px;
  box-shadow: none !important;
}
.offer-panel-container .tf-tabs .tab.active,
.offer-panel-container .tf-subtabs .subtab.active{
  background: linear-gradient(180deg, rgba(255,204,0,0.12), rgba(255,204,0,0.08)) !important;
  border-color: var(--tg-border-hi) !important;
  box-shadow: 0 0 0 1px rgba(255,204,0,0.18) inset, 0 0 22px rgba(255,204,0,0.14) !important;
  color: #fff !important;
}

/* ---------- CARDS (esquerda e direita) ---------- */
.offer-panel-container .tf-front-grid .tf-card,
.offer-panel-container .tf-card{
  position: relative;
  border-radius: var(--tg-radius);
  background: var(--tg-surface);
  border: 1px solid var(--tg-border);
  box-shadow: 0 10px 26px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
  backdrop-filter: blur(6px) saturate(110%);
  overflow: hidden;
}

/* remove padrões antigos/dash/bolinhas */
.offer-panel-container .tf-front-grid .tf-card{ background-image: none; }
.offer-panel-container .tf-front-grid .tf-card::after,
.offer-panel-container .tf-front-grid .tf-card::before{ opacity:0 !important; }

/* Cabeçalho do card */
.offer-panel-container .tf-card-head{
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.offer-panel-container .tf-card-head h3{
  margin:0; letter-spacing:.2px;
  color: var(--tg-text);
  text-shadow: 0 0 8px rgba(255,204,0,0.14);
}
.offer-panel-container .tf-card-head .tf-ico{
  width:30px;height:30px;border-radius:12px;
  display:inline-flex;align-items:center;justify-content:center;
  background: transparent;
  border:1px solid var(--tg-border-hi);
  box-shadow: inset 0 6px 16px rgba(255,204,0,0.14);
}

/* ---------- INPUTS/TEXTAREAS ---------- */
.offer-panel-container .tf-input,
.offer-panel-container .tf-textarea{
  background: rgba(0,0,0,0.40) !important;
  border: 1px solid rgba(255,255,255,0.16) !important;
  color: var(--tg-text) !important;
  box-shadow: inset 0 0 0 1px rgba(255,204,0,0) !important;
}
.offer-panel-container .tf-input:focus,
.offer-panel-container .tf-textarea:focus{
  border-color: var(--tg-border-hi) !important;
  box-shadow: 0 0 0 3px rgba(255,204,0,0.16), inset 0 0 0 1px rgba(255,204,0,0.25) !important;
}
.offer-panel-container ::placeholder{ color: rgba(255,255,255,0.55) !important; }

/* ---------- SWITCH CTA ---------- */
.offer-panel-container .tf-switch .slider{
  background: rgba(255,255,255,0.12) !important;
  border: 1px solid rgba(255,255,255,0.22) !important;
}
.offer-panel-container .tf-switch input:checked + .slider{
  background: linear-gradient(90deg, var(--tg-gold), var(--tg-gold-2)) !important;
  border-color: var(--tg-border-hi) !important;
  box-shadow: 0 0 0 2px rgba(255,204,0,0.18) !important;
}

/* ---------- BOTÕES ---------- */
.offer-panel-container .btn-primary,
.offer-panel-container .tf-btn-primary{
  background: linear-gradient(90deg, var(--tg-gold), var(--tg-gold-2)) !important;
  color: #1a1300 !important;
  border: 1px solid var(--tg-border-hi) !important;
  box-shadow: 0 0 12px rgba(255,204,0,0.35), inset 0 1px 0 rgba(255,255,255,0.35) !important;
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
}
.offer-panel-container .btn-primary:hover,
.offer-panel-container .tf-btn-primary:hover{
  transform: translateY(-1px);
  filter: brightness(1.06);
  box-shadow: 0 0 18px rgba(255,204,0,0.42), inset 0 1px 0 rgba(255,255,255,0.42) !important;
}

/* ---------- TITULOS/BREADCRUMB (apenas cor) ---------- */
.offer-panel-container .tf-offer-title{ color:#fff !important; -webkit-text-fill-color: initial; }

/* ---------- ESPAÇAMENTO PADRÃO ENTRE CARDS ESQUERDA ---------- */
.offer-panel-container .tf-front-grid .tf-card + .tf-card{ margin-top: 12px; }

/* ---------- PLANOS (card da direita) harmonizado ---------- */
.offer-panel-container .tf-plans,
.offer-panel-container .tf-right-col .tf-card{
  border:1px solid var(--tg-border);
  background: var(--tg-surface);
  box-shadow: 0 10px 26px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
}

/* ---------- PILLS ICONS equilíbrio ---------- */
.offer-panel-container .tf-tabs svg,
.offer-panel-container .tf-subtabs svg{ opacity:.9; }

</style>

<script>
/* efeito visual — não altera nenhuma função */
(function(){
  const cards = document.querySelectorAll('.tf-front-grid .tf-card');
  cards.forEach(card=>{
    card.addEventListener('pointermove', (e)=>{
      const r = card.getBoundingClientRect();
      const x = ((e.clientX - r.left) / r.width) * 100;
      const y = ((e.clientY - r.top) / r.height) * 100;
      card.style.setProperty('--mx', x + '%');
      card.style.setProperty('--my', y + '%');
    });
    card.addEventListener('pointerleave', ()=>{
      card.style.removeProperty('--mx');
      card.style.removeProperty('--my');
    });
  });
})();
</script>

<script>
(function(){
  window.tfDraftSettings = window.tfDraftSettings || {};
  const S = window.tfDraftSettings;
  function setFront(k,v){ S.front = S.front || {}; S.front[k]=v; }

  const elLink = document.getElementById('front_vsl_link');
  const elCopy = document.getElementById('front_vsl_copy');
  const elCtaOn = document.getElementById('front_cta_enabled');
  const elCtaLbl = document.getElementById('front_cta_label');

  // Prefill a partir da etapa atual, se existir
  try{
    const cur = (window.currentStep && window.currentStep.settings) ? window.currentStep.settings : {};
    if (cur.front){
      if (cur.front.vsl_link) elLink.value = cur.front.vsl_link;
      if (cur.front.vsl_copy) elCopy.value = cur.front.vsl_copy;
      if (typeof cur.front.cta_enabled === 'boolean'){ elCtaOn.checked = cur.front.cta_enabled; elCtaLbl.disabled = !elCtaOn.checked; }
      if (cur.front.cta_label) elCtaLbl.value = cur.front.cta_label;
    }
  }catch(_){}

  // Bind
  elLink && elLink.addEventListener('input', e => setFront('vsl_link', e.target.value));
  elCopy && elCopy.addEventListener('input', e => setFront('vsl_copy', e.target.value));
  if (elCtaOn){
    elCtaOn.addEventListener('change', () => {
      elCtaLbl.disabled = !elCtaOn.checked;
      setFront('cta_enabled', elCtaOn.checked);
    });
  }
  elCtaLbl && elCtaLbl.addEventListener('input', e => setFront('cta_label', e.target.value));
})();
</script>

<script>
(function(){
  var offer = <%- JSON.stringify(offer || null) %>;
  var steps = <%- JSON.stringify(steps || []) %>;
  var currentStep = <%- JSON.stringify(currentStep || null) %>;

  function escapeHtml(s){ return (s || "").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function stepLabel(s){ return (s && (s.name || ('Etapa ' + (s.stepNo || '')))) || ''; }

  var params = new URLSearchParams(location.search);
  var hasStepParam = params.has('stepId') && currentStep && currentStep.id;
  var isBaseView = !hasStepParam;

  var content = document.getElementById('tfContentArea');

  function updateTitleAndBreadcrumb(){
    var bc = document.getElementById('tfBreadcrumb');
    var h1 = document.getElementById('offerTitle');
    if (!bc || !h1) return;

    var offerName = (offer && offer.name) ? offer.name : 'Nome da Oferta';
    var offerHref = offer ? ("/ofertas/painel/" + offer.id) : "/ofertas";

    var items = [];
    items.push('<a href="/ofertas">Minhas Ofertas</a>');
    items.push('<span>›</span>');
    items.push('<a href="'+ offerHref +'">'+ escapeHtml(offerName) +'</a>');

    if (!isBaseView && currentStep && currentStep.id){
      items.push('<span>›</span>');
      items.push('<span>'+ escapeHtml(stepLabel(currentStep)) +'</span>');
      h1.textContent = stepLabel(currentStep);
    } else {
      h1.textContent = offerName;
    }

    bc.innerHTML = items.join('');
  }
  updateTitleAndBreadcrumb();

  var mainTabs = document.querySelectorAll('.tf-tabs-main .tab');
  var subTabsWrap = document.getElementById('subtabs-principal');
  var currentSubtab = 'front';

  mainTabs.forEach(function(btn){
    btn.addEventListener('click', function(e){
      var t = btn.dataset.tab;
      if (t === 'etapas'){ e.preventDefault(); openStepsModal(); return; }
      mainTabs.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');

      if (t === 'principal'){
        setBaseView(true);
        if (subTabsWrap) subTabsWrap.style.display = 'flex';
      } else {
        if (subTabsWrap) subTabsWrap.style.display = 'none';
        renderPlaceholder(t);
      }
    });
  });

  function setBaseView(on){
    isBaseView = !!on;
    var p = new URLSearchParams(location.search);
    if (isBaseView && p.has('stepId')){
      p.delete('stepId');
      history.replaceState(null, '', location.pathname + (p.toString() ? ('?' + p.toString()) : ''));
    }
    updateTitleAndBreadcrumb();
    renderFront();
  }

  (function(){
    var subTabs = document.querySelectorAll('#subtabs-principal .subtab');
    subTabs.forEach(function(btn){
      btn.addEventListener('click', function(){
        subTabs.forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        currentSubtab = btn.dataset.subtab || 'front';
        if (currentSubtab === 'front') renderFront();
        else renderPlaceholder(currentSubtab);
      });
    });
  })();

  window.tfDraftSettings = window.tfDraftSettings || {};
  if (!window.tfDraftSettings.front){
    window.tfDraftSettings.front = {
      vsl_url: '',
      vsl_copy: '',
      cta_enabled: false,
      cta_label: '',
      plans: []
    };
  }

  function iconLink(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l1.92-1.92a5 5 0 0 0-7.07-7.07l-1.5 1.5"></path><path d="M14 11a5 5 0 0 0-7.54-.54L4.54 12.38a5 5 0 0 0 7.07 7.07l1.5-1.5"></path></svg>'; }
  function iconText(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"></path><path d="M4 12h10"></path><path d="M4 18h14"></path></svg>'; }
  function iconBolt(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"/></svg>'; }
  function iconCoins(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5v6c0 1.7 4 3 9 3s9-1.3 9-3V5"></path><path d="M3 11v6c0 1.7 4 3 9 3s9-1.3 9-3v-6"></path></svg>'; }
  function iconTrash(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6M14 11v6"></path><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg>'; }

  function renderPlaceholder(tag){
    content.innerHTML = '<div class="tf-card" style="min-height:360px;display:flex;align-items:center;justify-content:center;"><span class="muted">Conteúdo de <b>'+escapeHtml(tag)+'</b> será adicionado futuramente.</span></div>';
  }

  function renderFront(){
    var s = window.tfDraftSettings.front;
    content.innerHTML = `
      <div class="front-grid">
        <div class="tf-card">
          <h3 class="tf-section-title">${iconLink()} VSL</h3>
          <div class="tf-field">
            <label class="tf-label">${iconLink()} Link da VSL Principal (t.me...)</label>
            <input id="vsl_url" class="tf-input" type="text" placeholder="https://t.me/seu_bot?start=..." value="${escapeHtml(s.vsl_url)}">
          </div>

          <div class="tf-field">
            <label class="tf-label">${iconText()} Copy da VSL Principal</label>
            <textarea id="vsl_copy" class="tf-textarea" rows="5" placeholder="Escreva a copy da VSL (mínimo visual, até 5 linhas confortáveis)...">${escapeHtml(s.vsl_copy)}</textarea>
          </div>

          <h3 class="tf-section-title" style="margin-top:14px">${iconBolt()} Botão de CTA para Planos (opcional)</h3>
          <div class="tf-field">
            <label class="tf-switch">
              <input id="cta_enabled" type="checkbox" ${s.cta_enabled ? 'checked' : ''}>
              <span class="track"><span class="thumb"></span></span>
              <span>Ativado</span>
            </label>
          </div>
          <div class="tf-field">
            <label class="tf-label">Nome do Botão</label>
            <input id="cta_label" class="tf-input" type="text" placeholder="Ex.: Obter Vaga" value="${escapeHtml(s.cta_label)}" ${s.cta_enabled ? '' : 'disabled'}>
          </div>
        </div>

        <div class="tf-card plans-card">
          <div class="plans-head">
            <h3 class="tf-section-title" style="margin:0">${iconCoins()} Planos</h3>
            <button type="button" class="btn-primary btn-small" id="btnAddPlan">Novo Plano</button>
          </div>
          <div id="plansWrap"></div>
          <p class="muted" id="plansHint" style="margin-top:6px;">Máximo de 10 planos. Adição inline, sem mini tela.</p>
        </div>
      </div>
    `;

    document.getElementById('vsl_url').addEventListener('input', function(e){
      window.tfDraftSettings.front.vsl_url = e.target.value.trim();
    });
    document.getElementById('vsl_copy').addEventListener('input', function(e){
      window.tfDraftSettings.front.vsl_copy = e.target.value;
    });
    document.getElementById('cta_enabled').addEventListener('change', function(e){
      var on = !!e.target.checked;
      window.tfDraftSettings.front.cta_enabled = on;
      var lab = document.getElementById('cta_label');
      lab.disabled = !on;
      if (!on) lab.value = '';
      window.tfDraftSettings.front.cta_label = lab.value.trim();
    });
    document.getElementById('cta_label').addEventListener('input', function(e){
      window.tfDraftSettings.front.cta_label = e.target.value.trim();
    });

    var wrap = document.getElementById('plansWrap');
    function planRowTpl(item, idx){
      var n = escapeHtml(item.name || '');
      var p = escapeHtml(item.price || '');
      return `
        <div class="plan-row" data-idx="${idx}">
          <input class="tf-input plan-name" type="text" placeholder="Nome do Plano" value="${n}">
          <input class="tf-input plan-price" type="text" placeholder="Valor" value="${p}">
          <button type="button" class="kill" title="Remover">${iconTrash()}</button>
        </div>
      `;
    }
    function renderPlans(){
      var list = window.tfDraftSettings.front.plans || [];
      if (!Array.isArray(list)) list = [];
      wrap.innerHTML = list.map((it,i)=>planRowTpl(it,i)).join('') || '<div class="muted">Nenhum plano ainda. Clique em “Novo Plano”.</div>';

      wrap.querySelectorAll('.plan-row').forEach(function(row){
        var i = parseInt(row.dataset.idx,10);
        row.querySelector('.plan-name').addEventListener('input', function(ev){
          window.tfDraftSettings.front.plans[i].name = ev.target.value;
        });
        row.querySelector('.plan-price').addEventListener('input', function(ev){
          window.tfDraftSettings.front.plans[i].price = ev.target.value;
        });
        row.querySelector('.kill').addEventListener('click', function(){
          window.tfDraftSettings.front.plans.splice(i,1);
          renderPlans();
        });
      });
    }
    document.getElementById('btnAddPlan').addEventListener('click', function(){
      var list = window.tfDraftSettings.front.plans;
      if (list.length >= 10) return;
      list.push({ name:'', price:'' });
      renderPlans();
    });
    renderPlans();
  }

  if (isBaseView){ renderFront(); } else { renderPlaceholder('etapa'); }

  (function(){
    var tab = document.getElementById('tabEtapas');
    if (!tab) return;
    tab.addEventListener('click', function(e){
      e.preventDefault();
      openStepsModal();
    });
  })();

  function showToast(type, text){
    var host = document.createElement('div');
    host.style.position='fixed'; host.style.top='20px'; host.style.right='20px';
    host.style.zIndex='4000'; host.style.display='flex'; host.style.flexDirection='column'; host.style.gap='10px';
    var card = document.createElement('div');
    card.style.padding='10px 14px'; card.style.borderRadius='12px';
    card.style.border='1px solid rgba(255,204,0,0.35)';
    card.style.boxShadow='0 10px 30px rgba(0,0,0,0.45)';
    card.style.background = (type==='error') ? 'linear-gradient(90deg,#2a0000,#3a0000)' : 'linear-gradient(90deg,#ffcc00,#d4a100)';
    card.style.color = (type==='error') ? '#ffd5d5' : '#171300';
    card.style.fontWeight='800'; card.style.letterSpacing='.3px';
    var row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center';
    var icon = document.createElement('span'); icon.style.marginRight='8px'; icon.textContent = (type==='error') ? '⚠️' : '✔️';
    var txt = document.createElement('span'); txt.textContent = text || (type==='error' ? 'Falha' : 'Sucesso');
    row.appendChild(icon); row.appendChild(txt); card.appendChild(row); host.appendChild(card); document.body.appendChild(host);
    setTimeout(function(){ host.remove(); }, 2300);
  }

  var saveBtn = document.getElementById('btnSaveAll');
  function flashSaved(btn){
    if (!btn) return;
    var prev = btn.textContent;
    btn.textContent='Salvo!';
    setTimeout(function(){ btn.textContent = prev; }, 1100);
  }
  if (saveBtn){
    saveBtn.addEventListener('click', async function(){
      if (!offer) { showToast('error','Oferta inválida.'); return; }
      if (isBaseView || !currentStep){
        flashSaved(saveBtn);
        showToast('success','Configurações salvas (oferta base).');
        return;
      }
      var draft = (window.tfDraftSettings && typeof window.tfDraftSettings === 'object') ? window.tfDraftSettings : {};
      try{
        const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(currentStep.id)}/save`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ settings: draft })
        });
        const js = await r.json(); if (!js || !js.ok) throw new Error('save_failed');
        flashSaved(saveBtn); showToast('success','Configurações salvas com sucesso.');
      }catch(e){ console.error(e); showToast('error','Não foi possível salvar.'); }
    });
  }

  var modal    = document.getElementById('stepsUnifiedModal');
  var btnClose = document.getElementById('btnCloseStepsUnified');
  var btnCancel= document.getElementById('btnCancelStepsUnified');
  var btnSave  = document.getElementById('btnSaveStepsUnified');
  var btnAdd   = document.getElementById('btnAddStepUnified');
  var listEl   = document.getElementById('tfStepsUnifiedList');

  function openStepsModal(){ hydrateListFromServer(); modal.removeAttribute('hidden'); }
  function closeStepsModal(){ modal.setAttribute('hidden',''); }

  btnClose?.addEventListener('click', closeStepsModal);
  btnCancel?.addEventListener('click', closeStepsModal);
  modal?.addEventListener('click', function(e){ if (e.target===modal) closeStepsModal(); });

  function clearEmptyHint(){
    var el = document.getElementById('tfStepsEmpty'); if (el) el.remove();
  }
  function renderEmptyHint(){
    if (listEl.querySelector('.tf-step-item')) return;
    if (document.getElementById('tfStepsEmpty')) return;
    var li = document.createElement('li'); li.id='tfStepsEmpty'; li.className='tf-steps-empty';
    li.textContent = 'Nenhuma etapa criada ainda. Clique em “Criar Etapa” para adicionar.';
    listEl.appendChild(li);
  }

  function hydrateListFromServer(){
    listEl.innerHTML = '';
    var ordered = steps.slice().sort(function(a,b){ return (a.stepNo||0)-(b.stepNo||0); });
    if (!ordered.length) { renderEmptyHint(); return; }
    ordered.forEach(function(s){
      addRow({ id:s.id, name:s.name, isCurrent:(s.settings && s.settings.is_current) || (currentStep && currentStep.id===s.id) });
    });
  }

  function addRow(opts){
    clearEmptyHint();

    var li = document.createElement('li'); li.className='tf-step-item';
    if (opts.id) li.dataset.id = opts.id; else li.dataset.new='1';

    var handle = document.createElement('div');
    handle.className='tf-drag-handle';
    handle.setAttribute('draggable','true');
    handle.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><circle cx="6" cy="5" r="1.3"/><circle cx="10" cy="5" r="1.3"/><circle cx="14" cy="5" r="1.3"/><circle cx="6" cy="10" r="1.3"/><circle cx="10" cy="10" r="1.3"/><circle cx="14" cy="10" r="1.3"/></svg>';

    var no = document.createElement('span'); no.className='tf-step-no'; no.textContent = listEl.querySelectorAll('.tf-step-item').length + 1;

    var input = document.createElement('input');
    input.className='tf-step-name'; input.type='text';
    input.placeholder='Ex: Etapa X, Upsell VIP';
    input.value = opts.name || '';
    input.dataset.oldName = opts.name || '';

    var btnAccess = document.createElement('button');
    btnAccess.type='button';
    btnAccess.className='tf-btn-ghost tf-access-btn';
    btnAccess.textContent='Acessar Etapa';
    btnAccess.addEventListener('click', function(){
      var sid = li.dataset.id || null;
      if (!sid){ showToast('error','Salve mudanças para acessar esta etapa.'); return; }
      document.getElementById('stepsUnifiedModal')?.setAttribute('hidden','');
      window.location.href = `/ofertas/painel/${offer.id}?stepId=${encodeURIComponent(sid)}`;
    });

    var delBtn = document.createElement('button');
    delBtn.className='tf-step-btn danger';
    delBtn.textContent='Excluir';
    delBtn.title='Excluir etapa';
    delBtn.addEventListener('click', function(){
      var overlay = document.createElement('div'); overlay.className='tf-steps-overlay'; overlay.style.zIndex='11000';
      var box = document.createElement('div'); box.className='tf-steps-dialog tf-steps-dialog--create-theme'; box.style.maxWidth='460px';
      box.innerHTML = '<div class="tf-steps-head tf-steps-head--center"><h3>Excluir etapa?</h3></div>' +
        '<div class="tf-steps-body tf-steps-body--compact"><p>Tem certeza que deseja excluir <strong>'+ escapeHtml(input.value || 'Etapa') +'</strong>? Essa ação não pode ser desfeita.</p></div>' +
        '<div class="tf-steps-actions tf-steps-actions--create-theme">' +
        '<button type="button" class="btn-secondary" id="cxCancel">Cancelar</button>' +
        '<button type="button" class="btn-primary" id="cxDelete">Excluir etapa</button>' +
        '</div>';
      overlay.appendChild(box); document.body.appendChild(overlay);

      function closeCx(){ overlay.remove(); }
      box.querySelector('#cxCancel').addEventListener('click', closeCx);
      overlay.addEventListener('click', function(e){ if (e.target === overlay) closeCx(); });

      box.querySelector('#cxDelete').addEventListener('click', async function(){
        if (!li.dataset.id){
          li.remove();
          recomputeNos();
          if (!listEl.querySelector('.tf-step-item')) renderEmptyHint();
          showToast('success','Etapa removida.');
          closeCx();
          return;
        }

        try{
          const stepId = li.dataset.id;
          const resp = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(stepId)}`, {
            method:'DELETE'
          });
          const js = await resp.json().catch(()=>null);
          if (!resp.ok || !js?.ok) throw new Error(js?.error || 'delete_failed');

          li.remove();
          recomputeNos();
          if (!listEl.querySelector('.tf-step-item')) renderEmptyHint();

          steps = steps.filter(s => s.id !== stepId);
          if (currentStep && currentStep.id === stepId){
            currentStep = null;
            setBaseView(true);
          }

          showToast('success','Etapa excluída com sucesso.');
        } catch (e){
          console.error(e);
          showToast('error','Não foi possível excluir.');
        } finally {
          closeCx();
        }
      });
    });

    li.appendChild(handle);
    li.appendChild(no);
    li.appendChild(input);
    li.appendChild(btnAccess);
    li.appendChild(delBtn);
    listEl.appendChild(li);

    initDragFor(handle, li);
    if (!opts.id){ setTimeout(function(){ input.focus(); }, 0); }
  }

  var dragContext = { draggingLi: null };
  function initDragFor(handle, li){
    handle.addEventListener('dragstart', function(e){
      dragContext.draggingLi = li;
      li.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain','drag'); } catch(_) {}
    });
    handle.addEventListener('dragend', function(){
      if (dragContext.draggingLi){ dragContext.draggingLi.classList.remove('dragging'); dragContext.draggingLi = null; }
      recomputeNos();
    });
  }
  listEl?.addEventListener('dragover', function(e){
    if (!dragContext.draggingLi) return;
    e.preventDefault();
    const after = getDragAfterElement(listEl, e.clientY);
    if (after == null){ listEl.appendChild(dragContext.draggingLi); }
    else { listEl.insertBefore(dragContext.draggingLi, after); }
  });
  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.tf-step-item:not(.dragging)')];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset){ return { offset, element: child }; }
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
  function recomputeNos(){
    var i = 0;
    Array.from(listEl.children).forEach(function(li){
      if (!li.classList.contains('tf-step-item')) return;
      var no = li.querySelector('.tf-step-no'); if (no) no.textContent = (++i);
    });
  }

  document.getElementById('btnAddStepUnified')?.addEventListener('click', function(){
    addRow({ name:'', isCurrent:false });
    recomputeNos();
  });

  var saveModalBtn = document.getElementById('btnSaveStepsUnified');
  if (saveModalBtn){
    saveModalBtn.addEventListener('click', async function(){
      if (!offer) { showToast('error','Oferta inválida.'); return; }

      var creates = [];
      var updates = [];
      var deletes = [];

      Array.from(listEl.children).forEach(function(li){
        if (!li.classList.contains('tf-step-item')) return;

        var id   = li.dataset.id || null;
        var isNew= !id;
        var del  = li.dataset.deleted === '1';
        var name = (li.querySelector('.tf-step-name')?.value || '').trim();
        var old  = (li.querySelector('.tf-step-name')?.dataset.oldName || '').trim();

        if (isNew && !del){
          if (name) creates.push({ name: name });
          return;
        }
        if (isNew && del){ return; }
        if (!isNew && del){
          deletes.push({ id });
          return;
        }
        if (!isNew && name && name !== old){
          updates.push({ id, name });
        }
      });

      var payload = { create: creates, update: updates, delete: deletes };

      saveModalBtn.disabled = true;
      saveModalBtn.textContent = 'Salvando…';
      try{
        const resp = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/batch`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const js = await resp.json();
        if (!resp.ok || !js?.ok) throw new Error(js?.error || 'batch_failed');

        if (Array.isArray(js.steps)){
          steps = js.steps.map(function(s){
            return {
              id: s.id,
              offerId: s.offer_id,
              name: s.name,
              stepNo: s.step_no,
              settings: s.settings || {},
              createdAt: s.created_at,
              updatedAt: s.updated_at
            };
          });
        }

        hydrateListFromServer();
        showToast('success','Etapas salvas com sucesso.');
      }catch(e){
        console.error(e);
        showToast('error','Falha ao salvar mudanças.');
      }finally{
        saveModalBtn.disabled = false;
        saveModalBtn.textContent = 'Salvar Mudanças';
      }
    });
  }
})();
</script>
