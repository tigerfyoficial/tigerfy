<!-- ============ MODAL CENTRAL: GERENCIAR ETAPAS DA OFERTA ============ -->
<div class="tf-steps2-overlay" id="tfSteps2Modal" hidden aria-hidden="true">
  <div class="tf-steps2-dialog" role="dialog" aria-modal="true" aria-labelledby="tfSteps2Title">
    <header class="tf-steps2-head">
      <div>
        <h3 id="tfSteps2Title">Gerenciar Etapas da Oferta</h3>
        <p class="tf-steps2-sub">Crie, selecione e organize as etapas desta oferta.</p>
      </div>
      <button type="button" class="tf-steps2-close" id="tfSteps2Close" aria-label="Fechar">✕</button>
    </header>

    <section class="tf-steps2-info">
      <div class="tf-steps2-left">
        <button type="button" class="tf-btn tf-btn-small" id="tfSteps2Add">＋ Nova etapa</button>
      </div>
      <small class="tf-steps2-hint">As alterações só entram no painel ao clicar em <strong>Salvar mudanças</strong>.</small>
    </section>

    <section class="tf-steps2-body">
      <ul class="tf-steps2-list" id="tfSteps2List" aria-label="Lista de Etapas"></ul>
    </section>

    <footer class="tf-steps2-actions">
      <button type="button" class="tf-btn" id="tfSteps2Cancel">Cancelar</button>
      <button type="button" class="tf-btn tf-btn-primary" id="tfSteps2Save">Salvar mudanças</button>
    </footer>
  </div>
</div>

<!-- ============ MINI CONFIRM (usa o mesmo overlay) ============ -->
<template id="tfSteps2ConfirmTpl">
  <div class="tf-steps2-confirm">
    <div class="tf-steps2-confirm-card">
      <h4>Excluir etapa?</h4>
      <p class="tf-steps2-confirm-text">Tem certeza que deseja excluir <strong class="nm">esta etapa</strong>? Essa ação não pode ser desfeita.</p>
      <div class="tf-steps2-confirm-actions">
        <button type="button" class="tf-btn tf-btn-ghost js-cancel">Cancelar</button>
        <button type="button" class="tf-btn tf-btn-primary js-delete">Excluir etapa</button>
      </div>
    </div>
  </div>
</template>

<style>
  .tf-steps2-overlay[hidden]{ display:none !important; }
  .tf-steps2-overlay{
    position:fixed; inset:0; z-index:3000;
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.48);
    backdrop-filter: blur(8px);
  }
  .tf-steps2-dialog{
    width:min(880px, calc(100vw - 32px));
    max-height:min(78vh, 760px);
    display:flex; flex-direction:column;
    background:
      radial-gradient(1200px 280px at 50% -180px, rgba(255,204,0,0.10), transparent),
      linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.14);
    border-radius:18px;
    box-shadow:
      0 26px 70px rgba(0,0,0,0.55),
      inset 0 0 0 1px rgba(255,255,255,0.06);
    transform: translateY(8px) scale(.985);
    opacity:.98;
    animation: tfSteps2In .18s ease-out forwards;
  }
  @keyframes tfSteps2In { to{ transform: translateY(0) scale(1); opacity:1; } }

  .tf-steps2-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:8px;
    padding:16px 16px 8px 16px;
  }
  .tf-steps2-head h3{ margin:0; font-size:1.1rem; letter-spacing:.2px; }
  .tf-steps2-sub{ margin:6px 0 0 0; color:#d8d8d8; font-size:.92rem; }
  .tf-steps2-close{
    appearance:none; cursor:pointer;
    width:36px; height:36px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06); color:#eee;
    transition:.16s ease;
  }
  .tf-steps2-close:hover{ background: rgba(255,255,255,0.10); }

  .tf-steps2-info{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:6px 16px 10px 16px; border-bottom:1px solid rgba(255,255,255,0.12);
  }
  .tf-steps2-left{ display:flex; align-items:center; gap:8px; }
  .tf-btn{
    appearance:none; border:1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06); color:#eee;
    padding:9px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    transition:.16s ease;
  }
  .tf-btn:hover{ background: rgba(255,255,255,0.10); }
  .tf-btn-small{ padding:7px 12px; border-radius:999px; font-size:.9rem; }
  .tf-btn-primary{
    background: linear-gradient(90deg, #ffcc00, #d4a100);
    color:#181100; border:1px solid rgba(255,204,0,0.35);
    box-shadow: 0 8px 26px rgba(255,204,0,0.25);
  }
  .tf-btn-ghost{ background:transparent; border-color:transparent; box-shadow:none; color:#eee; }
  .tf-steps2-hint{ color:#d2d2d2; }

  .tf-steps2-body{ padding:10px 14px; overflow:auto; }
  .tf-steps2-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }

  .tf-steps2-item{
    display:grid;
    grid-template-columns:56px 30px 1fr 140px 110px;
    align-items:center; gap:10px;
    padding:10px 12px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border:1px solid rgba(255,255,255,0.14);
    box-shadow: 0 10px 26px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.04);
    transition: transform .08s ease, background .14s ease, border-color .14s ease, opacity .14s ease;
  }
  .tf-steps2-item:hover{ background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05)); border-color: rgba(255,255,255,0.2); transform: translateY(-1px); }
  .tf-steps2-item.dragging{ opacity:.6; }
  .tf-steps2-index{
    display:inline-flex; align-items:center; justify-content:center;
    width:42px; height:30px; border-radius:999px;
    background: rgba(255,255,255,0.09); border:1px solid rgba(255,255,255,0.18); color:#fff; font-weight:800;
  }
  .tf-steps2-handle{
    cursor:grab; user-select:none; display:flex; align-items:center; justify-content:center;
    width:30px; height:30px; border-radius:10px;
    background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.16);
  }
  .tf-steps2-handle:active{ cursor:grabbing; }
  .tf-steps2-name{
    width:100%; padding:8px 10px; border-radius:10px;
    background: rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.16);
  }
  .tf-steps2-name:focus{ border-color: rgba(255,204,0,0.6); box-shadow: 0 0 0 2px rgba(255,204,0,0.20); outline: none; }

  .tf-steps2-actions{ display:flex; align-items:center; gap:6px; justify-content:flex-start; }
  .tf-steps2-del{ border-color: rgba(255, 75, 75, .35) !important; background: linear-gradient(90deg, #3a0000, #2a0000) !important; color:#ffdada !important; }
  .tf-steps2-del:hover{ filter: brightness(1.06); }

  .tf-steps2-radio{ display:inline-flex; align-items:center; gap:8px; justify-content:flex-end; }
  .tf-steps2-radio input[type="radio"]{
    appearance:none; width:18px; height:18px; border-radius:999px;
    border:1px solid rgba(255,255,255,0.24); background:rgba(255,255,255,0.06);
    box-shadow: inset 0 0 0 2px rgba(0,0,0,0.3); position:relative; cursor:pointer; transition:.16s;
  }
  .tf-steps2-radio input[type="radio"]::after{
    content:""; position:absolute; inset:3px; border-radius:999px; background:transparent; transition:.16s;
  }
  .tf-steps2-radio input[type="radio"]:checked{
    border-color: rgba(255,204,0,0.7); box-shadow: 0 0 0 2px rgba(255,204,0,0.15), inset 0 0 0 2px rgba(0,0,0,0.2);
  }
  .tf-steps2-radio input[type="radio"]:checked::after{
    background:linear-gradient(90deg, #ffcc00, #d4a100);
  }
  .tf-steps2-radio span{ color:#eaeaea; font-weight:800; letter-spacing:.2px; }

  .tf-steps2-actions,
  .tf-steps2-ghost{ }
  .tf-steps2-actions{
    display:flex; justify-content:flex-end; align-items:center; gap:8px;
    padding:12px 14px 16px 14px; border-top:1px solid rgba(255,255,255,0.12);
  }

  .tf-steps2-confirm{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:3100;
  }
  .tf-steps2-confirm-card{
    width:min(480px, calc(100vw - 40px));
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.16); border-radius:14px; padding:16px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    animation: tfSteps2In .18s ease-out forwards;
  }
  .tf-steps2-confirm-card h4{ margin:0 0 8px 0; }
  .tf-steps2-confirm-text{ margin:0 0 12px 0; color:#e8e8e8; }
  .tf-steps2-confirm-actions{ display:flex; justify-content:flex-end; gap:8px; }

  .tf-steps2-toast{
    position:fixed; top:18px; right:18px; z-index:3200;
    padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
    border:1px solid rgba(255,204,0,0.35);
    background: linear-gradient(90deg,#ffcc00,#d4a100); color:#171300;
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    transform: translateY(-10px) scale(.98); opacity:0;
    transition: transform .16s ease, opacity .16s ease;
  }
  .tf-steps2-toast.error{
    background: linear-gradient(90deg,#370000,#4a0000); color:#ffd5d5; border-color: rgba(255,100,100,.35);
  }
  .tf-steps2-toast.show{ transform: translateY(0) scale(1); opacity:1; }

  @keyframes tfSteps2Pulse {
    0% { box-shadow: 0 0 0 0 rgba(255,204,0,0.35); transform: translateY(0) scale(1); }
    60% { box-shadow: 0 0 24px 8px rgba(255,204,0,0.24); transform: translateY(-1px) scale(1.01); }
    100% { box-shadow: 0 0 0 0 rgba(255,204,0,0.0); transform: translateY(0) scale(1); }
  }
  .tf-steps2-saved { animation: tfSteps2Pulse .5s ease-out 1; }
</style>

<script>
(function(){
  // ====== Estado inicial vindo do servidor (já existentes na página) ======
  const Ctx = (window.__TigerFyCtx && typeof window.__TigerFyCtx === 'object') ? window.__TigerFyCtx : {};
  let OFFER = Ctx.offer || window.offer || null;
  let STEPS = (Ctx.steps || window.steps || []);
  let CURRENT = Ctx.currentStep || window.currentStep || null;

  // ====== Elementos do modal ======
  const modal   = document.getElementById('tfSteps2Modal');
  const btnX    = document.getElementById('tfSteps2Close');
  const btnAdd  = document.getElementById('tfSteps2Add');
  const btnSave = document.getElementById('tfSteps2Save');
  const btnCanc = document.getElementById('tfSteps2Cancel');
  const listEl  = document.getElementById('tfSteps2List');

  // ====== Abrir modal pelo botão existente de "Etapas" sem mudar layout ======
  document.querySelectorAll('#tabEtapas, #btnEtapas, [data-open-steps]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
  });

  // API pública (se quiser abrir por script)
  window.TigerFyEtapas = { open, close };

  function open(ctxOffer, ctxSteps, ctxCurrent){
    OFFER   = ctxOffer   || OFFER;
    STEPS   = ctxSteps   || STEPS;
    CURRENT = ctxCurrent || CURRENT;
    renderList();
    bodyLock(true);
    modal.hidden = false;
    modal.setAttribute('aria-hidden','false');
  }
  function close(){
    modal.hidden = true;
    modal.setAttribute('aria-hidden','true');
    bodyLock(false);
  }

  // ====== UX helpers ======
  function bodyLock(lock){
    const h = document.documentElement;
    if (lock){ h.style.overflow='hidden'; document.body.style.overflow='hidden'; }
    else { h.style.overflow=''; document.body.style.overflow=''; }
  }
  function showToast(msg, isErr){
    const t = document.createElement('div');
    t.className = 'tf-steps2-toast' + (isErr ? ' error' : '');
    t.textContent = msg;
    document.body.appendChild(t);
    requestAnimationFrame(()=> t.classList.add('show'));
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 160); }, 2300);
  }

  // ====== Render da lista ======
  function renderList(){
    listEl.innerHTML = '';
    const arr = (STEPS || []).map(s => ({
      id: s.id,
      name: s.name || '',
      stepNo: s.stepNo ?? s.step_no ?? 0,
      isCurrent: CURRENT && CURRENT.id === s.id
    })).sort((a,b)=> (a.stepNo||0) - (b.stepNo||0));

    for (const s of arr) addRow(s);

    // se não houver etapas, encoraja criar a primeira
    if (!arr.length) addRow({ id:null, name:'', stepNo:1, isCurrent:false });
  }

  function addRow({id, name, stepNo, isCurrent}){
    const li = document.createElement('li');
    li.className = 'tf-steps2-item';
    if (id) li.dataset.id = id; else li.dataset.new = '1';

    const colIdx = document.createElement('div');
    colIdx.className = 'tf-steps2-index';
    colIdx.textContent = stepNo || listEl.children.length + 1;

    const handle = document.createElement('div');
    handle.className = 'tf-steps2-handle';
    handle.title = 'Arraste para reordenar';
    handle.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6M9 12h6M9 6h6"/></svg>';

    const input = document.createElement('input');
    input.type='text'; input.className='tf-steps2-name';
    input.placeholder='Nova etapa'; input.value = name || '';
    input.dataset.oldName = name || '';

    const actions = document.createElement('div');
    actions.className = 'tf-steps2-actions';
    const btnDel = document.createElement('button');
    btnDel.type='button'; btnDel.className='tf-btn tf-steps2-del'; btnDel.textContent='Excluir';
    if (Number(stepNo) === 1 && id) btnDel.disabled = true; // opcional: proteger Etapa 1 persistida
    btnDel.addEventListener('click', ()=> askDelete(li, input.value || 'Etapa'));
    actions.appendChild(btnDel);

    const radioWrap = document.createElement('label');
    radioWrap.className = 'tf-steps2-radio';
    const rb = document.createElement('input');
    rb.type='radio'; rb.name='tfStepsCurrent'; rb.checked = !!isCurrent;
    const rbLbl = document.createElement('span'); rbLbl.textContent = 'Atual';
    radioWrap.appendChild(rb); radioWrap.appendChild(rbLbl);

    li.appendChild(colIdx);
    li.appendChild(handle);
    li.appendChild(input);
    li.appendChild(actions);
    li.appendChild(radioWrap);

    listEl.appendChild(li);
    enableDnD(li);
  }

  function recomputeIndexes(){
    Array.from(listEl.children).forEach((li, i)=>{
      const el = li.querySelector('.tf-steps2-index');
      if (el) el.textContent = i+1;
    });
  }

  // ====== Drag & Drop (sem lib) ======
  let dragging = null;
  function enableDnD(li){
    li.draggable = true;
    li.addEventListener('dragstart', (e)=>{ dragging = li; li.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    li.addEventListener('dragend',   ()=>{ dragging = null; li.classList.remove('dragging'); recomputeIndexes(); });
    li.addEventListener('dragover',  (e)=>{
      e.preventDefault();
      const t = li;
      if (!dragging || dragging===t) return;
      const r = t.getBoundingClientRect();
      const before = (e.clientY - r.top) < (r.height/2);
      if (before) listEl.insertBefore(dragging, t);
      else listEl.insertBefore(dragging, t.nextSibling);
    });
  }

  // ====== Confirm de exclusão (marca para excluir; persiste no salvar) ======
  function askDelete(li, name){
    const tpl = document.getElementById('tfSteps2ConfirmTpl');
    const frag = tpl.content.cloneNode(true);
    const layer = frag.querySelector('.tf-steps2-confirm');
    const nm = frag.querySelector('.nm'); nm.textContent = name;
    const bCancel = frag.querySelector('.js-cancel');
    const bDelete = frag.querySelector('.js-delete');

    function closeC(){ layer.remove(); }
    bCancel.addEventListener('click', closeC);
    layer.addEventListener('click', (e)=>{ if (e.target===layer) closeC(); });
    bDelete.addEventListener('click', ()=>{
      li.dataset.toDelete = '1';
      li.style.opacity = .38;
      li.style.filter = 'grayscale(35%)';
      closeC();
    });

    modal.appendChild(layer);
  }

  // ====== Ações de topo ======
  btnAdd.addEventListener('click', ()=>{
    addRow({ id:null, name:'', stepNo:listEl.children.length+1, isCurrent:false });
    recomputeIndexes();
  });

  // Fechar
  btnX.addEventListener('click', close);
  btnCanc.addEventListener('click', close);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) close(); });

  // ====== Persistência (ajuste só os endpoints se precisar) ======
  function setSaving(on){
    if (on){
      btnSave.disabled = true;
      if (!btnSave.dataset._txt) btnSave.dataset._txt = btnSave.textContent;
      btnSave.textContent = 'Salvando…';
    } else {
      btnSave.disabled = false;
      btnSave.textContent = btnSave.dataset._txt || 'Salvar mudanças';
    }
  }

  async function apiCreate(name){
    // EXISTENTE: cria uma etapa
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name: String(name||'').trim() })
    });
    const js = await r.json();
    if (!js || !js.ok || !js.step) throw new Error('create_failed');
    return js.step; // { id, name, stepNo, ... }
  }
  async function apiRename(id, name){
    // fallback: usa a rota de save que você já tem para atualizar o nome
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/${encodeURIComponent(id)}/save`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name: String(name||'').trim() })
    });
    const js = await r.json();
    if (!js || !js.ok || !js.step) throw new Error('rename_failed');
    return js.step;
  }
  async function apiDelete(id){
    // se sua rota DELETE existir, ótimo; caso contrário, ajusta aqui
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/${encodeURIComponent(id)}`,{ method:'DELETE' });
    const js = await r.json().catch(()=> ({}));
    if (!js || js.ok !== true) throw new Error('delete_failed');
    return true;
  }
  async function apiReorder(orderIds){
    // rota canônica de reorder (array na ordem final)
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/reorder`,{
      method:'PUT', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ order: orderIds })
    });
    const js = await r.json();
    if (!js || js.ok !== true) throw new Error('reorder_failed');
    return true;
  }

  btnSave.addEventListener('click', async ()=>{
    try{
      setSaving(true);

      const rows = Array.from(listEl.children);
      const toCreate = [];
      const toRename = [];
      const toDelete = [];
      let selectedIdMarker = null;

      // coleta operações
      for (const li of rows){
        const id = li.dataset.id || null;
        const isNew = !id && li.dataset.new === '1';
        const del = li.dataset.toDelete === '1';
        const input = li.querySelector('.tf-steps2-name');
        const rb = li.querySelector('input[type="radio"]');
        const name = (input?.value || '').trim();
        const old  = (input?.dataset.oldName || '').trim();

        if (rb && rb.checked){
          selectedIdMarker = id || '__select_new__'; // se for novo, resolvemos depois
        }
        if (isNew && !del && name) toCreate.push({ li, name });
        if (!isNew && del) toDelete.push(id);
        if (!isNew && !del && name && name !== old) toRename.push({ id, name });
      }

      // criar novos (sequencial para manter ordem visual)
      const liToStep = new Map(); // li -> {id,...}
      for (const item of toCreate){
        const step = await apiCreate(item.name);
        item.li.dataset.id = step.id;
        item.li.dataset.new = '';
        const input = item.li.querySelector('.tf-steps2-name');
        if (input) input.dataset.oldName = step.name || item.name;
        liToStep.set(item.li, step);
        if (selectedIdMarker === '__select_new__' && !window.__tfSelectResolved){
          window.__tfSelectResolved = true;
          selectedIdMarker = step.id;
        }
      }

      // renomear
      for (const op of toRename){
        await apiRename(op.id, op.name);
      }

      // excluir marcados
      for (const id of toDelete){
        await apiDelete(id);
      }

      // reordenar (só ids não deletados, na ordem visual)
      const orderIds = Array.from(listEl.children)
        .filter(li => li.dataset.toDelete !== '1')
        .map(li => li.dataset.id)
        .filter(Boolean);
      if (orderIds.length) await apiReorder(orderIds);

      // feedback + redireção para etapa atual se houver
      btnSave.classList.add('tf-steps2-saved');
      setTimeout(()=> btnSave.classList.remove('tf-steps2-saved'), 600);
      showToast('Etapas salvas com sucesso.');
      close();

      if (selectedIdMarker && selectedIdMarker !== '__select_new__'){
        window.location.href = `/ofertas/painel/${encodeURIComponent(OFFER.id)}?stepId=${encodeURIComponent(selectedIdMarker)}`;
      } else {
        window.location.href = `/ofertas/painel/${encodeURIComponent(OFFER.id)}`;
      }
    } catch(err){
      console.error(err);
      showToast('Falha ao salvar mudanças.', true);
    } finally {
      setSaving(false);
    }
  });
})();
</script>
