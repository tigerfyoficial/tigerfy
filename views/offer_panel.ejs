<!-- ================== GERENCIAR ETAPAS — MODAL SIMPLES (TigerFy) ================== -->
<div id="tfSteps2Modal" class="tf-steps2-overlay" hidden aria-hidden="true" role="dialog" aria-labelledby="tfSteps2Title">
  <div class="tf-steps2-card">
    <header class="tf-steps2-header">
      <h3 id="tfSteps2Title">Gerenciar Etapas da Oferta</h3>
      <button type="button" class="tf-steps2-close" id="tfSteps2Close" aria-label="Fechar">✕</button>
    </header>

    <div class="tf-steps2-toolbar">
      <button type="button" class="tf-btn tf-btn--ghost" id="tfSteps2Add">+ Nova etapa</button>
      <small class="tf-steps2-hint">As alterações só são aplicadas ao painel ao clicar em <b>Salvar</b>.</small>
    </div>

    <ul class="tf-steps2-list" id="tfSteps2List" aria-label="Etapas"></ul>

    <footer class="tf-steps2-footer">
      <button type="button" class="tf-btn" id="tfSteps2Cancel">Cancelar</button>
      <button type="button" class="tf-btn tf-btn--gold" id="tfSteps2Save">Salvar</button>
    </footer>
  </div>
</div>

<style>
  /* ====== Isolado: não interfere no tema global ====== */
  .tf-steps2-overlay[hidden]{ display:none !important; }
  .tf-steps2-overlay{
    position:fixed; inset:0; z-index:3000;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); backdrop-filter:blur(2px);
  }
  .tf-steps2-card{
    width:min(560px,calc(100vw - 32px));
    max-height:min(78vh,720px);
    display:flex; flex-direction:column;
    background:#111; border:1px solid rgba(255,204,0,.18);
    border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.6);
    overflow:hidden;
  }
  .tf-steps2-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  .tf-steps2-header h3{ margin:0; font-size:1rem; }
  .tf-steps2-close{
    appearance:none; border:0; background:transparent; color:#ddd; cursor:pointer; font-size:18px;
  }
  .tf-steps2-toolbar{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.06);
  }
  .tf-steps2-hint{ color:#bbb }
  .tf-steps2-list{
    list-style:none; margin:0; padding:10px 12px; display:flex; flex-direction:column; gap:8px; overflow:auto;
  }
  .tf-step-row{
    display:grid; grid-template-columns:36px 1fr 84px 86px; gap:8px; align-items:center;
    background:#151515; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px;
  }
  .tf-step-row.is-del{ opacity:.45; filter:grayscale(40%); }
  .tf-step-idx{
    display:flex; align-items:center; justify-content:center; height:28px; border-radius:999px;
    background:#1b1b1b; border:1px solid rgba(255,255,255,.08); font-weight:700; color:#fff;
  }
  .tf-step-name{
    width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.10);
    background:#1a1a1a; color:#fff;
  }
  .tf-step-current{ display:flex; align-items:center; gap:6px; justify-content:center; color:#eee; }
  .tf-step-current input{ accent-color:#ffcc00; }

  .tf-btn{
    appearance:none; cursor:pointer; border:1px solid rgba(255,255,255,.14);
    background:#1b1b1b; color:#eee; padding:8px 12px; border-radius:10px; font-weight:700;
  }
  .tf-btn--ghost{ background:transparent; }
  .tf-btn--red{ border-color:rgba(255,80,80,.35); color:#ffdede; background:#2a0000; }
  .tf-btn--gold{
    border-color:rgba(255,204,0,.45);
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300;
  }
  .tf-steps2-footer{
    display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid rgba(255,255,255,.08);
  }
</style>

<script>
(function(){
  "use strict";

  // ==== Contexto do painel (não altera nada fora do modal) ====
  const Ctx = (window.__TigerFyCtx && typeof window.__TigerFyCtx === 'object') ? window.__TigerFyCtx : {};
  let OFFER   = Ctx.offer || window.offer || null;
  let STEPS   = (Ctx.steps || window.steps || []) || [];
  let CURRENT = Ctx.currentStep || window.currentStep || null;

  // ==== Elements ====
  const modal   = document.getElementById('tfSteps2Modal');
  const btnX    = document.getElementById('tfSteps2Close');
  const btnAdd  = document.getElementById('tfSteps2Add');
  const btnSave = document.getElementById('tfSteps2Save');
  const btnCanc = document.getElementById('tfSteps2Cancel');
  const listEl  = document.getElementById('tfSteps2List');

  // ==== API pública para a pill "Etapas" existente ====
  window.TigerFyEtapas = {
    open(ctxOffer, ctxSteps, ctxCurrent){
      OFFER   = ctxOffer   || OFFER;
      STEPS   = ctxSteps   || STEPS;
      CURRENT = ctxCurrent || CURRENT;
      renderList();
      openModal();
    },
    close: closeModal
  };

  // Abre via botão/pill já existente (#tabEtapas), se houver
  const openBtn = document.getElementById('tabEtapas');
  if (openBtn){
    openBtn.addEventListener('click', function(e){ e.preventDefault(); window.TigerFyEtapas.open(); });
  }

  // ==== Modal helpers ====
  function lockBody(on){ document.documentElement.style.overflow = on ? 'hidden' : ''; document.body.style.overflow = on ? 'hidden' : ''; }
  function openModal(){ modal.hidden=false; modal.setAttribute('aria-hidden','false'); lockBody(true); }
  function closeModal(){ modal.hidden=true;  modal.setAttribute('aria-hidden','true');  lockBody(false); }

  btnX && btnX.addEventListener('click', closeModal);
  btnCanc && btnCanc.addEventListener('click', closeModal);
  modal && modal.addEventListener('click', (e)=>{ if (e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && modal.getAttribute('aria-hidden')==='false') closeModal(); });

  // ==== Render da lista ====
  function renderList(){
    listEl.innerHTML = '';
    const ordered = (STEPS || []).slice().sort((a,b)=> (a.stepNo||a.step_no||0) - (b.stepNo||b.step_no||0));
    if (!ordered.length){
      // inicia com uma linha vazia amigável
      addRow({ name:'', stepNo:1, isCurrent:false });
      return;
    }
    ordered.forEach(s => addRow({ id:s.id, name:s.name, stepNo:s.stepNo || s.step_no, isCurrent: CURRENT && CURRENT.id===s.id }));
    recomputeIndexes();
  }

  function addRow(opts){
    const li = document.createElement('li');
    li.className = 'tf-step-row';
    if (opts.id) li.dataset.id = opts.id; else li.dataset.new = '1';

    const idx = document.createElement('div');
    idx.className = 'tf-step-idx';
    idx.textContent = opts.stepNo || (listEl.children.length + 1);

    const name = document.createElement('input');
    name.type='text'; name.className='tf-step-name';
    name.placeholder='Nova etapa';
    name.value = opts.name || '';
    name.dataset.oldName = opts.name || '';

    const currentWrap = document.createElement('label');
    currentWrap.className = 'tf-step-current';
    const rb = document.createElement('input');
    rb.type='radio'; rb.name='tfSteps2Current'; rb.checked = !!opts.isCurrent;
    currentWrap.appendChild(rb);
    currentWrap.appendChild(document.createTextNode('Atual'));

    const del = document.createElement('button');
    del.type='button'; del.className='tf-btn tf-btn--red'; del.textContent='Excluir';
    del.addEventListener('click', ()=>{
      if (confirm('Excluir esta etapa?')) {
        li.dataset.toDelete = '1';
        li.classList.add('is-del');
        // se estava marcada como atual, desmarca
        if (rb.checked) rb.checked = false;
      }
    });

    li.appendChild(idx);
    li.appendChild(name);
    li.appendChild(currentWrap);
    li.appendChild(del);

    listEl.appendChild(li);
  }

  function recomputeIndexes(){
    Array.from(listEl.children).forEach((li,i)=>{
      const b = li.querySelector('.tf-step-idx');
      if (b) b.textContent = i+1;
    });
  }

  btnAdd && btnAdd.addEventListener('click', ()=>{ addRow({ name:'', stepNo:listEl.children.length+1 }); recomputeIndexes(); });

  // ==== Persistência (mesma lógica/rotas já usadas) ====
  function setSaving(on){
    if (!btnSave) return;
    if (on){ btnSave.disabled=true; if(!btnSave.dataset._t) btnSave.dataset._t=btnSave.textContent; btnSave.textContent='Salvando…'; }
    else { btnSave.disabled=false; btnSave.textContent=btnSave.dataset._t || 'Salvar'; }
  }

  async function apiBatchCreate(names){
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/batch`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ names })
    });
    const js = await r.json(); if (!js || !js.ok) throw new Error('batch_failed'); return js.steps || [];
  }
  async function apiRename(id, name){
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/${encodeURIComponent(id)}/rename`,{
      method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name })
    });
    const js = await r.json(); if (!js || !js.ok) throw new Error('rename_failed'); return js.step || null;
  }
  async function apiDelete(id){
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/${encodeURIComponent(id)}`,{ method:'DELETE' });
    const js = await r.json(); if (!js || !js.ok) throw new Error('delete_failed'); return true;
  }
  async function apiReorder(orderIds){
    const r = await fetch(`/ofertas/${encodeURIComponent(OFFER.id)}/etapas/reorder`,{
      method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order: orderIds })
    });
    const js = await r.json(); if (!js || !js.ok) throw new Error('reorder_failed'); return true;
  }

  btnSave && btnSave.addEventListener('click', async ()=>{
    try{
      setSaving(true);

      const rows = Array.from(listEl.children);
      const newNames = [];
      const renameOps = [];
      const deleteIds = [];
      let selectedId = null;
      let selectedIdResolved = false;

      for (const li of rows){
        const id    = li.dataset.id || null;
        const isNew = !id;
        const toDel = li.dataset.toDelete === '1';
        const nameEl= li.querySelector('.tf-step-name');
        const name  = (nameEl?.value || '').trim();
        const old   = (nameEl?.dataset.oldName || '').trim();
        const rb    = li.querySelector('input[type="radio"]');

        if (rb && rb.checked){ selectedId = id || '__will_select_new__'; }
        if (isNew && !toDel && name){ newNames.push(name); }
        if (!isNew && toDel){ deleteIds.push(id); }
        if (!isNew && !toDel && name && name !== old){ renameOps.push({ id, name }); }
      }

      if (newNames.length){
        const created = await apiBatchCreate(newNames); // [{id,name,stepNo}]
        let idx=0;
        for (const li of rows){
          if (!li.dataset.id && li.dataset.toDelete !== '1'){
            const c = created[idx++]; if (!c) continue;
            li.dataset.id = c.id;
            const nameEl = li.querySelector('.tf-step-name');
            if (nameEl) nameEl.dataset.oldName = c.name || nameEl.value || '';
            if (selectedId === '__will_select_new__' && !selectedIdResolved){
              selectedIdResolved = true; selectedId = c.id;
            }
          }
        }
      }

      for (const op of renameOps){ await apiRename(op.id, op.name); }
      for (const id of deleteIds){ await apiDelete(id); }

      // Reordenar conforme a ordem das linhas (não há drag aqui; mantém sequência atual)
      const orderIds = Array.from(listEl.children)
        .filter(li => li.dataset.toDelete !== '1')
        .map(li => li.dataset.id)
        .filter(Boolean);
      if (orderIds.length){ await apiReorder(orderIds); }

      // Fecha + navega respeitando etapa atual
      closeModal();
      if (selectedId && selectedId !== '__will_select_new__'){
        window.location.href = `/ofertas/painel/${encodeURIComponent(OFFER.id)}?stepId=${encodeURIComponent(selectedId)}`;
      } else {
        window.location.href = `/ofertas/painel/${encodeURIComponent(OFFER.id)}`;
      }
    }catch(err){
      console.error(err);
      alert('Falha ao salvar as etapas. Tente novamente.');
    }finally{
      setSaving(false);
    }
  });
})();
</script>
