/* offer_panel.js — TigerFy Premium (logic-only) */
(function boot(){
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", run);
  } else {
    run();
  }

  function run(){
    var offer = window.__offer || window.offer || null;
    var steps = (window.__steps || window.steps || []);
    var currentStep = window.__currentStep || window.currentStep || null;

    /* ---------- Utilities ---------- */
    function escapeHtml(s){ return (s || "").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function stepNumber(s){ return Number(s.stepNo || s.step_no || 0) || 0; }
    function nextStepNo(arr){
      if (!Array.isArray(arr) || !arr.length) return 1;
      var max = Math.max.apply(null, arr.map(stepNumber));
      return (isFinite(max) ? max : 0) + 1;
    }

    /* Toast premium (overlay discreto) */
    function showToast(type, text){
      var wrap = document.createElement("div");
      wrap.style.position="fixed"; wrap.style.inset="0";
      wrap.style.display="flex"; wrap.style.alignItems="center"; wrap.style.justifyContent="center";
      wrap.style.background="rgba(0,0,0,0.35)"; wrap.style.backdropFilter="blur(2px)";
      wrap.style.zIndex="2000"; wrap.style.opacity="0"; wrap.style.transition="opacity .16s ease";

      var card = document.createElement("div");
      card.style.padding="14px 18px"; card.style.borderRadius="12px";
      card.style.border="1px solid rgba(255,204,0,0.35)";
      card.style.boxShadow="0 10px 30px rgba(0,0,0,0.45)";
      card.style.background=(type==="error")?"linear-gradient(90deg,#2a0000,#3a0000)":"linear-gradient(90deg,#ffcc00,#d4a100)";
      card.style.color=(type==="error")?"#ffd5d5":"#171300";
      card.style.fontWeight="800"; card.style.letterSpacing=".3px";
      card.textContent=text || (type==="error"?"Falhou":"Salvo!");
      wrap.appendChild(card); document.body.appendChild(wrap);
      requestAnimationFrame(function(){ wrap.style.opacity="1"; });
      setTimeout(function(){
        wrap.style.opacity="0";
        setTimeout(function(){ wrap.remove(); }, 160);
      }, 1400);
    }
    window.TF = window.TF || {}; window.TF.showToast = showToast;

    /* Botão Salvar: loading + salvo */
    function setButtonLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        btn.disabled = true;
        if (!btn.dataset._txt) btn.dataset._txt = btn.textContent;
        btn.textContent = "Salvando…";
        btn.style.filter="brightness(1.02)";
        btn.style.boxShadow="0 6px 22px rgba(255,204,0,0.35)";
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset._txt || "Salvar Alterações";
        btn.style.filter=""; btn.style.boxShadow="";
      }
    }
    function flashSaved(btn){
      if (!btn) return;
      var old = btn.textContent;
      btn.textContent = "Salvo!";
      setTimeout(function(){ btn.textContent = btn.dataset._txt || old; }, 1100);
    }

    /* ---------- Breadcrumb e chip de etapa ---------- */
    try{
      var chipEl = document.getElementById("tfStepName");
      if (chipEl && currentStep) {
        chipEl.textContent = currentStep.name || ("Etapa " + (currentStep.stepNo || currentStep.step_no || ""));
        chipEl.style.textShadow = "0 0 10px rgba(255,204,0,0.12)"; // realce sutil da etapa atual
      }
    }catch(_){}

    (function buildBreadcrumb(){
      var bc = document.getElementById("tfBreadcrumb"); if(!bc) return;
      var offerName = (offer && offer.name) ? offer.name : "Nome da Oferta";
      var offerHref = offer ? ("/ofertas/painel/" + offer.id) : "/ofertas";
      var items = [];
      items.push('<a href="/ofertas">Minhas Ofertas</a>');
      items.push("<span>›</span>");
      items.push('<a href="'+ offerHref +'">'+ escapeHtml(offerName) +'</a>');
      if (currentStep && currentStep.id) {
        items.push("<span>›</span>");
        var stepUrl = offerHref + "?stepId=" + encodeURIComponent(currentStep.id);
        items.push('<a href="'+ stepUrl +'">'+ escapeHtml(currentStep.name || ("Etapa " + (currentStep.stepNo||currentStep.step_no||""))) +'</a>');
      }
      bc.innerHTML = items.join("");
    })();

    /* ---------- Tabs: subtabs só em "Principal" ---------- */
    var mainTabs = document.querySelectorAll(".tf-tabs .tab");
    var subTabsWrap = document.getElementById("subtabs-principal");
    mainTabs.forEach(function(btn){
      btn.addEventListener("click", function(){
        mainTabs.forEach(function(b){ b.classList.remove("active"); });
        btn.classList.add("active");
        var isPrincipal = btn.dataset.tab === "principal";
        if (subTabsWrap) subTabsWrap.style.display = isPrincipal ? "flex" : "none";
      });
    });
    if (subTabsWrap) subTabsWrap.style.display = "flex";

    /* ---------- UX: Popover de etapas no chip ---------- */
    (function stepsPopover(){
      var chipStrong = document.getElementById("tfStepName");
      var chipWrap = chipStrong ? chipStrong.closest(".tf-step-chip") : null;
      var pop = null, outsideClose = null;

      function stylePopover(el){
        el.style.position="absolute";
        el.style.background="linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.06))";
        el.style.border="1px solid rgba(255,255,255,0.16)";
        el.style.borderRadius="12px";
        el.style.boxShadow="0 18px 40px rgba(0,0,0,0.45)";
        el.style.backdropFilter="blur(6px)";
        el.style.minWidth="220px"; el.style.maxHeight="320px"; el.style.overflow="auto";
        el.style.zIndex="1500"; el.style.opacity="0"; el.style.transform="translateY(6px) scale(0.98)";
        el.style.transition="opacity .16s ease, transform .16s ease";
      }
      function styleItem(row){
        row.style.display="flex"; row.style.alignItems="center"; row.style.justifyContent="space-between";
        row.style.padding="10px 12px"; row.style.cursor="pointer"; row.style.userSelect="none";
        row.style.color="#eaeaea"; row.style.borderBottom="1px solid rgba(255,255,255,0.06)";
        row.addEventListener("mouseenter", function(){ row.style.background="rgba(255,255,255,0.06)"; });
        row.addEventListener("mouseleave", function(){ row.style.background="transparent"; });
      }
      function badge(){
        var b = document.createElement("span");
        b.textContent="Atual";
        b.style.fontSize=".78rem"; b.style.padding="3px 8px"; b.style.borderRadius="999px";
        b.style.border="1px solid rgba(255,204,0,0.35)";
        b.style.background="rgba(255,204,0,0.08)"; b.style.color="#ffdb4d";
        return b;
      }

      function openPop(){
        if (!chipWrap || !steps || !steps.length) return;
        if (pop) closePop();
        pop = document.createElement("div");
        stylePopover(pop);

        var rect = chipWrap.getBoundingClientRect();
        pop.style.top = (rect.bottom + window.scrollY + 8) + "px";
        pop.style.left = (rect.left + window.scrollX) + "px";

        steps.forEach(function(s){
          var row = document.createElement("div");
          styleItem(row);
          var label = document.createElement("span");
          label.textContent = s.name || ("Etapa " + (s.stepNo || s.step_no || ""));
          row.appendChild(label);
          if (currentStep && currentStep.id === s.id) row.appendChild(badge());
          row.addEventListener("click", function(){
            window.location.href = "/ofertas/painel/" + offer.id + "?stepId=" + encodeURIComponent(s.id);
          });
          pop.appendChild(row);
        });

        document.body.appendChild(pop);
        requestAnimationFrame(function(){
          pop.style.opacity="1"; pop.style.transform="translateY(0) scale(1)";
        });

        outsideClose = function(ev){
          if (!pop) return;
          if (!pop.contains(ev.target) && !chipWrap.contains(ev.target)) closePop();
        };
        document.addEventListener("mousedown", outsideClose);
        window.addEventListener("resize", closePop);
        window.addEventListener("scroll", closePop, true);
      }
      function closePop(){
        if (!pop) return;
        pop.style.opacity="0"; pop.style.transform="translateY(6px) scale(0.98)";
        setTimeout(function(){ if(pop){ pop.remove(); pop=null; } }, 160);
        document.removeEventListener("mousedown", outsideClose);
        window.removeEventListener("resize", closePop);
        window.removeEventListener("scroll", closePop, true);
      }

      if (chipWrap) chipWrap.addEventListener("click", function(){ if(pop) closePop(); else openPop(); });
    })();

    /* ---------- Modal “Nova etapa”: contraste/animar via JS (sem CSS novo) ---------- */
    (function stepModalLogic(){
      var modalBackdrop = document.getElementById("stepModal");
      var modal = modalBackdrop ? modalBackdrop.querySelector(".tf-modal") : null;
      var openBtn = document.getElementById("btnCreateStep");
      var closeBtn = document.getElementById("btnCloseModal");
      var cancelBtn = document.getElementById("btnCancelStep");
      var confirmBtn = document.getElementById("btnConfirmStep");
      var nameInput = document.getElementById("inpStepName");

      function applyBackdropOpenStyles(){
        modalBackdrop.style.opacity="0";
        modalBackdrop.style.transition="opacity .18s ease";
        modal.style.transform="translateY(8px) scale(.98)";
        modal.style.opacity="0";
        modal.style.transition="transform .18s ease, opacity .18s ease";
      }
      function openModal(){
        if(!modalBackdrop) return;
        var n = nextStepNo(steps);
        if (nameInput) nameInput.value = "Etapa " + n;

        modalBackdrop.removeAttribute("hidden");
        applyBackdropOpenStyles();
        requestAnimationFrame(function(){
          modalBackdrop.style.opacity="1";
          modal.style.transform="translateY(0) scale(1)";
          modal.style.opacity="1";
        });

        if (nameInput) nameInput.focus();
        document.addEventListener("keydown", escToClose);
        // radios highlight sutil
        var radios = document.querySelectorAll('input[name="dupMode"]');
        radios.forEach(function(r){
          r.addEventListener("change", function(){
            document.querySelectorAll(".tf-radio").forEach(function(lbl){
              lbl.style.background="transparent";
              lbl.style.borderColor="";
              var span = lbl.querySelector("span"); if(span) span.style.textShadow="";
            });
            var p = r.closest(".tf-radio");
            if (p){
              p.style.background="rgba(255,255,255,0.05)";
              p.style.borderColor="rgba(255,204,0,0.35)";
              var s = p.querySelector("span"); if(s) s.style.textShadow="0 0 10px rgba(255,204,0,0.18)";
            }
          });
        });
      }
      function closeModal(){
        if(!modalBackdrop) return;
        modalBackdrop.style.opacity="0";
        modal.style.transform="translateY(8px) scale(.98)";
        modal.style.opacity="0";
        setTimeout(function(){
          modalBackdrop.setAttribute("hidden","");
          document.removeEventListener("keydown", escToClose);
        }, 180);
      }
      function escToClose(e){ if (e.key === "Escape") closeModal(); }

      if (openBtn) openBtn.addEventListener("click", openModal);
      if (closeBtn) closeBtn.addEventListener("click", closeModal);
      if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
      if (modalBackdrop){
        modalBackdrop.addEventListener("click", function(e){ if(e.target === modalBackdrop) closeModal(); });
      }

      if (confirmBtn){
        confirmBtn.addEventListener("click", async function(){
          var dupVal = document.querySelector('input[name="dupMode"]:checked')?.value || "0";
          var stepName = (nameInput?.value || "").trim();
          if (!stepName) stepName = "Etapa " + nextStepNo(steps);

          try{
            var r = await fetch("/ofertas/" + encodeURIComponent(offer.id) + "/etapas", {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({
                name: stepName,
                duplicate: dupVal === "1",
                fromStepId: (dupVal === "1" && currentStep && currentStep.id) ? currentStep.id : null
              })
            });
            var js = await r.json();
            if (!js || !js.ok) throw new Error("create_failed");
            window.location.href = "/ofertas/painel/" + offer.id + "?stepId=" + encodeURIComponent(js.step.id);
          }catch(e){
            console.error(e);
            showToast("error","Não foi possível criar a etapa.");
          }
        });
      }
    })();

    /* ---------- Salvar Alterações: loading + toast + fallback de rota ---------- */
    (function saveLogic(){
      var saveBtn = document.getElementById("btnSaveAll");
      if (!saveBtn) return;

      saveBtn.addEventListener("click", async function(){
        var draftSettings = (window.tfDraftSettings && typeof window.tfDraftSettings === "object")
          ? window.tfDraftSettings
          : {};

        try{
          setButtonLoading(saveBtn, true);

          /* Tenta PATCH padrão */
          var ok = false, resp, js;
          try{
            resp = await fetch("/ofertas/" + encodeURIComponent(offer.id) + "/etapas/" + encodeURIComponent(currentStep.id), {
              method:"PATCH",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ settings: draftSettings })
            });
            js = await resp.json();
            ok = !!(js && js.ok);
          }catch(_){ ok = false; }

          /* Fallback para POST /save se o PATCH não existir no server atual */
          if (!ok){
            resp = await fetch("/ofertas/" + encodeURIComponent(offer.id) + "/etapas/" + encodeURIComponent(currentStep.id) + "/save", {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ settings: draftSettings })
            });
            js = await resp.json();
            ok = !!(js && js.ok);
          }

          if (!ok) throw new Error("save_failed");

          flashSaved(saveBtn);
          showToast("success","Etapa salva com sucesso.");
        }catch(e){
          console.error(e);
          showToast("error","Não foi possível salvar. Tente novamente.");
        }finally{
          setButtonLoading(saveBtn, false);
        }
      });
    })();
  }
})();
