<%- include('partials/visual_hottrack') %>

<div class="offer-panel-container">
  <div class="tf-offer-panel">
    <nav class="tf-breadcrumb" id="tfBreadcrumb"></nav>

    <header class="tf-header">
      <div class="tf-header-left">
        <h1 class="tf-offer-title" id="offerTitle">
          <%= (currentStep && (currentStep.name || ('Etapa ' + (currentStep.stepNo || '')))) || (offer?.name || 'Nome da Oferta') %>
        </h1>
      </div>
      <div class="tf-header-right">
        <button type="button" class="tf-btn tf-btn-primary" id="btnSaveAll">Salvar Alterações</button>
      </div>
    </header>

    <div class="tf-pills-wrap">
      <div class="tf-tabs tf-tabs-main">
        <button class="tab active" data-tab="principal">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="14" width="7" height="7" rx="2"></rect><rect x="3" y="14" width="7" height="7" rx="2"></rect></svg>
          Principal
        </button>

        <button class="tab" data-tab="contingencia">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path></svg>
          Blindagem de Bots
        </button>

        <button class="tab" data-tab="tracking">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15A1.65 1.65 0 0 0 21 13.35 8 8 0 0 0 12 4a8 8 0 0 0-8 9.35A1.65 1.65 0 0 0 5.6 15"></path></svg>
          Traqueamento
        </button>

        <button class="tab" data-tab="relatorios">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M19 17V7"></path><path d="M13 17V3"></path><path d="M7 17v-7"></path></svg>
          Fluxo de Relatórios
        </button>

        <button class="tab" id="tabEtapas" data-tab="etapas">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3l9 4.5-9 4.5L3 7.5 12 3z"></path>
            <path d="M21 12l-9 4.5L3 12"></path>
            <path d="M21 16.5l-9 4.5-9-4.5"></path>
          </svg>
          Etapas
        </button>
      </div>

      <div class="tf-subtabs" id="subtabs-principal">
        <button class="subtab active" data-subtab="front">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h8"></path><path d="M17 8h.01"></path><path d="M19 4v6h6"></path></svg>
          Front
        </button>

        <button class="subtab" data-subtab="orderbump" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M6 6h15l-1.5 9h-12z"></path><path d="M6 6l-1-3H2"></path><circle cx="9" cy="20" r="1"></circle><circle cx="18" cy="20" r="1"></circle><path d="M12 10h4"></path></svg>
          OrderBump
        </button>

        <button class="subtab" data-subtab="upsell" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"></path></svg>
          Upsell
        </button>

        <button class="subtab" data-subtab="downsell" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"> <path d="M3 7l6 6 4-4 8 8"></path></svg>
         Downsell 
        </button>

        <button class="subtab" data-subtab="pix">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
          Mensagem PIX
        </button>

        <button class="subtab" data-subtab="disparos" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
          Disparos
        </button>
      </div>
    </div>

<!-- ===== PRINCIPAL / FRONT — v5 (compact/premium + rules modal unificado) ===== -->
<section class="tf-front-v5" data-content="front">
  <div class="tf-front-grid">
    <!-- CARD 1 — VSL & Mídia principal -->
    <div class="tfx5-card">
      <header class="tfx5-head">
        <div>
          <h3>VSL & Mídia principal do Front</h3>
          <p class="sub">Configure a mídia principal e quando ela será exibida.</p>
        </div>
        <button type="button" class="ghost xs" id="btnAddMedia">+ Adicionar mídia</button>
      </header>

      <div class="tfx5-body">
        <div class="mlist" id="frontMediaList"><!-- linhas via JS --></div>
      </div>
    </div>

    <!-- CARD 2 — Copy da VSL -->
    <div class="tfx5-card">
      <header class="tfx5-head">
        <div>
          <h3>Copy da VSL</h3>
          <p class="sub">Mensagem principal exibida junto à VSL.</p>
        </div>
        <button type="button" class="ghost xs" data-open-rules="vsl">Regras</button>
      </header>

      <div class="tfx5-body">
        <textarea id="front_vsl_copy" name="front_vsl_copy" class="inp textarea s-compact" rows="3" placeholder="Descreva aqui a copy da sua VSL..."></textarea>

        <label class="toggle mt6">
          <input type="checkbox" id="vslDeleteToggle">
          <span>Apagar mensagem da VSL</span>
        </label>
      </div>
    </div>

    <!-- CARD 3 — Botão de CTA (opcional) -->
    <div class="tfx5-card">
      <header class="tfx5-head">
        <div>
          <h3>Botão de CTA (opcional)</h3>
          <p class="sub">Define o botão principal do front.</p>
        </div>
        <div class="seg">
          <button class="seg-btn is-active" type="button" data-cta-enable="yes">Sim</button>
          <button class="seg-btn" type="button" data-cta-enable="no">Não</button>
        </div>
      </header>

      <div class="tfx5-body" id="ctaFields">
        <div class="grid2 gap8">
          <div class="col">
            <label class="lbl">Texto do botão</label>
            <input class="inp" name="front_cta_text" placeholder="Ex.: Quero minha vaga, Acessar conteúdo VIP..." />
          </div>
          <div class="col">
            <label class="lbl">URL da VSL</label>
            <input class="inp" name="front_cta_url" placeholder="https://..." />
          </div>
        </div>

        <div class="row align-center gap8 mt6">
          <label class="toggle">
            <input type="checkbox" id="ctaDeleteToggle">
            <span>Apagar mensagem do CTA</span>
          </label>
          <button type="button" class="ghost xs" data-open-rules="cta">Regras</button>
        </div>
      </div>
    </div>

    <!-- CARD 4 — Planos exibidos no Front -->
    <div class="tfx5-card tfx5-card--plans">
      <header class="tfx5-head">
        <div>
          <h3>Planos exibidos no Front</h3>
          <p class="sub">Organize e reordene os planos exibidos.</p>
        </div>
        <button type="button" class="ghost xs" id="btnAddPlan">+ Adicionar plano</button>
      </header>

      <div class="tfx5-body">
        <!-- Copy antes dos planos -->
        <div class="copy-before">
          <div class="row">
            <label class="lbl">Copy antes dos planos</label>
            <textarea class="inp textarea s-compact" rows="2" name="front_plans_intro" placeholder="Mensagem curta antes dos botões de plano..."></textarea>
          </div>
          <div class="row align-center gap8 mt4">
            <label class="toggle">
              <input type="checkbox" id="plansIntroEnable">
              <span>Enviar essa copy?</span>
            </label>
            <button type="button" class="ghost xs" data-open-rules="plansIntro">Regras</button>
          </div>
        </div>

        <!-- Lista de planos -->
        <div class="plist" id="frontPlansList"><!-- linhas via JS --></div>
      </div>
    </div>
  </div>
</section>

<!-- ===== Mini-Modal Unificado de Regras ===== -->
<div class="tfx5-rules-overlay" id="rulesOverlay" hidden>
  <div class="tfx5-rules-dialog" role="dialog" aria-modal="true">
    <header class="r-head">
      <h4 id="rulesTitle">Regras</h4>
      <button type="button" class="iconbtn" id="rulesClose" aria-label="Fechar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </header>

    <div class="r-body">
      <label class="chip"><input type="checkbox" data-rule="noDelete"><span>Não apagar</span></label>
      <label class="chip"><input type="checkbox" data-rule="afterNextBtn"><span>Apagar após clique no próximo botão</span></label>
      <label class="chip r-seconds">
        <input type="checkbox" data-rule="afterSeconds"><span>Apagar após X segundos</span>
        <input type="text" class="inp xs" data-rule="secondsVal" placeholder="ex.: 5s">
      </label>
      <label class="chip"><input type="checkbox" data-rule="delAfterStart"><span>Apagar após próximo /start</span></label>
    </div>

    <footer class="r-actions">
      <button type="button" class="ghost xs" id="rulesClear">Limpar regras</button>
      <div class="spacer"></div>
      <button type="button" class="btn-secondary btn-small" id="rulesCancel">Cancelar</button>
      <button type="button" class="btn-primary btn-small" id="rulesApply">Aplicar regras</button>
    </footer>
  </div>
</div>

  </div>
</div>

<!-- MODAL -->
<div class="tf-steps-overlay" id="stepsUnifiedModal" hidden>
  <div class="tf-steps-dialog tf-steps-dialog--create-theme" role="dialog" aria-modal="true">
    <div class="tf-steps-head tf-steps-head--center">
      <h3>Gerenciar Etapas da Oferta</h3>
      <p class="tf-steps-sub">Crie, selecione e organize as etapas desta oferta. As alterações só são aplicadas ao clicar em <strong>Salvar mudanças</strong>.</p>
      <button type="button" class="tf-steps-close" id="btnCloseStepsUnified" aria-label="Fechar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="tf-steps-body tf-steps-body--compact">
      <div class="tf-steps-toolbar tf-steps-toolbar--tight">
        <button type="button" class="btn-secondary btn-small" id="btnAddStepUnified" title="Adicionar nova etapa">
          <span class="tf-icon-plus">＋</span>
          Criar Etapa
        </button>
        <small class="tf-hint tf-toolbar-hint">Clique em <strong>Salvar Mudanças</strong> para aplicar.</small>
      </div>

      <ul class="tf-steps-list" id="tfStepsUnifiedList" aria-label="Lista de Etapas"></ul>
    </div>

    <div class="tf-steps-actions tf-steps-actions--create-theme">
      <button type="button" class="btn-secondary" id="btnCancelStepsUnified">Cancelar</button>
      <button type="button" class="btn-primary" id="btnSaveStepsUnified">Salvar Mudanças</button>
    </div>
  </div>
</div>

<style>
  :root{
    --panel:rgba(255,255,255,0.04);
    --panel-strong:rgba(255,255,255,0.06);
    --border:rgba(255,255,255,0.12);
    --muted:#b8b8b8;
    --text:#ffffff;
    --accent:#ffcc00;
    --accent-dim:#d4a100;
    --shadow:0 8px 24px rgba(0,0,0,0.45);
    --pills-width: 980px;
    --radius: 14px;
  }

  .offer-panel-container{ width:100%; max-width:1200px; margin-left:auto; margin-right:auto; }
  .offer-panel-container .tf-offer-panel{ padding:60px 80px 100px 80px; }

  .tf-offer-panel{ color:var(--text); padding:60px 80px 100px 130px; max-width:1200px; margin:0 auto; }
  .tf-breadcrumb{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem; margin-bottom:10px; }
  .tf-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; }
  .tf-offer-title{ margin:0; font-size:1.8rem; letter-spacing:.3px; background:linear-gradient(90deg,#fff,#d8d8d8); -webkit-background-clip:text; background-clip:text; color:transparent; }

  .tf-btn{ appearance:none; border:1px solid var(--border); background:var(--panel-strong); color:#eee; padding:9px 14px; border-radius:var(--radius); cursor:pointer; font-weight:600; box-shadow:var(--shadow); transition:.18s ease; }
  .tf-btn:hover{ border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.09); }
  .tf-btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent-dim)); color:#171300; border:1px solid rgba(255,204,0,0.35); box-shadow:0 6px 22px rgba(255,204,0,0.25); }

  .tf-pills-wrap{ max-width:var(--pills-width); margin:16px auto 8px; }
  .tf-tabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  .tf-subtabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }

  .tf-tabs .tab{ display:inline-flex; align-items:center; gap:8px; padding:9px 14px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dedede; font-weight:600; font-size:.92rem; height:38px; transition:.18s ease; }
  .tf-tabs .tab.active{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.22); color:#fff; }
  .tf-subtabs .subtab{ display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dcdcdc; font-weight:600; font-size:.9rem; }

  .tf-content-placeholder{
    min-height:360px; border:1px dashed rgba(255,255,255,0.12); border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    box-shadow:var(--shadow); margin-top:14px;
  }

  .btn-primary, .btn-secondary{
    border:none; border-radius:10px; padding:10px 22px;
    font-weight:600; cursor:pointer; text-decoration:none;
    font-size:.95rem; display:inline-flex; align-items:center; justify-content:center;
  }
  .btn-small{ height:34px; padding:8px 14px; font-size:.9rem; border-radius:10px; }
  .btn-primary{
    background:linear-gradient(90deg,#ffcc00,#d4a100);
    color:#1a1300;
    box-shadow:0 0 16px rgba(255,204,0,0.45);
    border:1px solid rgba(255,204,0,0.35);
    transition:.18s ease;
  }
  .btn-secondary{
    background:rgba(255,255,255,0.12);
    color:#fff;
    border:1px solid rgba(255,255,255,0.10);
    transition:.18s ease;
  }
  .btn-secondary:hover{ background:rgba(255,255,255,0.18); }

  .tf-steps-overlay[hidden]{ display:none !important; }
  .tf-steps-overlay{
    position:fixed; inset:0; z-index:3000;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.55);
    backdrop-filter: blur(10px);
  }
  .tf-steps-dialog{
    width:min(760px, calc(100vw - 40px));
    max-height:min(70vh, 680px);
    overflow:hidden;
    border-radius:20px;
    border:1px solid rgba(255,204,0,0.16);
    box-shadow:0 0 40px rgba(0,0,0,0.6);
    background:rgba(0,0,0,0.78);
    transform: translateY(8px) scale(0.985);
    animation: tfStepsIn .18s ease-out forwards;
  }
  @keyframes tfStepsIn { to { transform: translateY(0) scale(1); } }

  .tf-steps-head{ position:relative; padding:22px 22px 12px 22px; border-bottom:1px solid rgba(255,255,255,0.08); }
  .tf-steps-head--center h3{ text-align:center; }
  .tf-steps-head h3{ margin:0; font-size:1.35rem; font-weight:800; color:#ffcc00; }
  .tf-steps-sub{ color:#b4b4b4; margin:8px 0 0 0; font-size:.95rem; text-align:center; }
  .tf-steps-close{
    position:absolute; top:12px; right:12px;
    width:36px; height:36px; border-radius:999px;
    border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.06); color:#eee;
    display:inline-flex; align-items:center; justify-content:center; padding:0; line-height:1; cursor:pointer;
    transition:.18s ease;
  }
  .tf-steps-close:hover{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.20); }

  .tf-steps-body{ padding:16px 18px; }
  .tf-steps-toolbar{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  .tf-toolbar-hint{ margin-left:auto; color:#c9c9c9; font-size:.9rem; }

  .tf-steps-list{
    list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:12px;
    max-height:48vh; overflow:auto;
  }

  .tf-step-item{
    display:grid;
    grid-template-columns: 32px 42px 1fr auto auto;
    align-items:center; gap:12px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.10);
    transition:.18s ease;
  }
  .tf-step-item:hover{ border-color:rgba(255,204,0,0.45); background:rgba(255,255,255,0.10); }
  .tf-step-item.is-current{
    border-color:#ffcc00;
    background:radial-gradient(circle at top left,#fff7bf,#ffcc00 45%,#8a5a16 100%);
    color:#111;
    box-shadow:0 0 18px rgba(255,204,0,0.55);
  }

  .tf-drag-handle{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(255,255,255,0.06);
    cursor:grab; user-select:none; transition:.16s ease;
  }
  .tf-drag-handle:hover{ background:rgba(255,255,255,0.10); }
  .tf-drag-handle:active{ cursor:grabbing; }
  .tf-drag-handle svg{ width:14px; height:14px; opacity:.85; }

  .tf-step-no{
    display:inline-flex; align-items:center; justify-content:center;
    width:40px; height:28px; border-radius:999px;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.14);
    font-weight:800; color:#fff;
  }
  .tf-step-item.is-current .tf-step-no{ background:rgba(0,0,0,0.12); border-color:rgba(0,0,0,0.18); color:#111; }

  .tf-step-name{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.06);
    color:#fff; outline:none; font-size:.95rem;
    transition:border-color .2s, box-shadow .2s;
  }
  .tf-step-name::placeholder{ color:rgba(255,255,255,0.65); }
  .tf-step-name:focus{ border-color:#ffcc00; box-shadow:0 0 0 2px rgba(255,204,0,0.28); }
  .tf-step-item.is-current .tf-step-name{ color:#111; }

  .tf-actions-inline{ display:flex; align-items:center; gap:8px; }

  .tf-btn-ghost{
    padding:8px 14px; border-radius:10px; height:36px;
    background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.10);
    font-weight:700; transition:.18s ease;
  }
  .tf-btn-ghost:hover{ background:rgba(255,255,255,0.18); }
  .tf-step-item.is-current .tf-btn-ghost{ background:rgba(0,0,0,0.06); color:#111; border-color:rgba(0,0,0,0.12); }

  .tf-badge, .tf-badge.visible, .tf-badge.current { display:none !important; }

  .tf-step-btn{
    padding:8px 12px; border-radius:10px; height:36px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(255,255,255,0.06);
    color:#eee; transition:.16s ease;
  }
  .tf-step-btn:hover{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.20); }
  .tf-step-btn.danger{ border-color: rgba(255, 85, 85, .35); background: linear-gradient(90deg, #320000, #250000); color:#ffdada; }
  .tf-step-btn.danger:hover{ filter:brightness(1.05); }

  .tf-select-radio{ display:none !important; }

  .tf-steps-actions{ display:flex; justify-content:flex-end; gap:12px; padding:16px 18px 18px 18px; border-top:1px solid rgba(255,255,255,0.08); }

  .tf-steps-actions .btn-primary:hover{
    filter: brightness(1.06);
    box-shadow: 0 0 22px rgba(255,204,0,.55), 0 8px 28px rgba(255,204,0,.22);
  }

  .tf-steps-empty{
    padding:16px; border:1px dashed rgba(255,255,255,0.18); border-radius:12px;
    color:#cfcfcf; text-align:center; background:rgba(255,255,255,0.03);
  }

  .tf-steps-menu{
    position:fixed; z-index:3500; background:rgba(0,0,0,.86);
    border:1px solid rgba(255,255,255,.12); border-radius:12px; box-shadow:var(--shadow);
    padding:6px; min-width:220px; backdrop-filter: blur(10px);
  }
  .tf-steps-menu button{
    display:block; width:100%; text-align:left; padding:8px 12px; background:transparent;
    color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;
  }
  .tf-steps-menu button:hover{ background:rgba(255,255,255,.08); }

  .tf-step-item.is-current .tf-access-btn{
    background: rgba(0,0,0,0.22);
    color: #fff;
    border: 1px solid rgba(255,204,0,0.55);
    box-shadow: 0 0 0 1px rgba(255,204,0,0.25), 0 6px 18px rgba(255,204,0,0.18);
  }
  .tf-step-item.is-current .tf-access-btn:hover{
    filter: brightness(1.05);
    box-shadow: 0 0 0 1px rgba(255,204,0,0.35), 0 8px 24px rgba(255,204,0,0.24);
  }

  @keyframes tfPulseGlow {
    0% { box-shadow: 0 0 0 0 rgba(255,204,0,0.35); transform: translateY(0) scale(1); }
    60% { box-shadow: 0 0 24px 8px rgba(255,204,0,0.24); transform: translateY(-1px) scale(1.01); }
    100% { box-shadow: 0 0 0 0 rgba(255,204,0,0.0); transform: translateY(0) scale(1); }
  }
  .tf-pulse-once { animation: tfPulseGlow .5s ease-out 1; }

  @media (max-width: 980px){
    .offer-panel-container{ padding: 0 12px; }
    .tf-offer-panel{ padding:40px 18px 80px 18px; }
    .tf-pills-wrap{ max-width: calc(100% - 24px); }
    .tf-steps-dialog{ width:calc(100vw - 28px); }
    .tf-step-item{ grid-template-columns: 28px 36px 1fr auto auto; }
  }
</style>

<style>
/* ===== v5 layout ===== */
.tf-front-v5{ padding:10px; border:1px solid rgba(255,255,255,0.12); border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02)); box-shadow:0 8px 24px rgba(0,0,0,0.45);}
.tf-front-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:1100px){ .tf-front-grid{ grid-template-columns:1fr; } }

.tfx5-card{ background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10);
  border-radius:16px; backdrop-filter:blur(8px); padding:12px; }
.tfx5-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
.tfx5-head h3{ margin:0; font-size:1.02rem; color:#ffcc00; letter-spacing:.2px; }
.tfx5-head .sub{ margin:2px 0 0; color:#b8b8b8; font-size:.86rem;}
.tfx5-body{ display:flex; flex-direction:column; gap:8px; }
.tfx5-card--plans{ grid-column:span 2; } /* ocupa linha toda quando houver espaço */

.lbl{ color:#e9e9e9; font-weight:700; font-size:.92rem; }
.inp{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.22); background:rgba(255,255,255,0.06); color:#fff; outline:none; font-size:.92rem; }
.inp:focus{ border-color:#ffcc00; box-shadow:0 0 0 2px rgba(255,204,0,0.26); }
.textarea.s-compact{ min-height:58px; resize:vertical; }
.inp.xs{ width:84px; padding:6px 8px; font-size:.86rem; }
.mt4{ margin-top:4px; } .mt6{ margin-top:6px; }

.toggle{ display:inline-flex; align-items:center; gap:8px; font-weight:700; color:#e9e9e9; }
.toggle input{ width:16px; height:16px; accent-color:#ffcc00; }

.ghost{ border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); color:#eee; padding:6px 10px; border-radius:10px; font-weight:700; height:30px; font-size:.86rem; }
.ghost:hover{ background:rgba(255,255,255,0.12); }
.btn-small{ height:34px; padding:8px 14px; font-size:.9rem; border-radius:10px; }

/* Segmented toggle CTA */
.seg{ display:inline-flex; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); border-radius:999px; }
.seg-btn{ border:0; padding:6px 12px; font-weight:800; color:#eaeaea; cursor:pointer; background:transparent; border-radius:999px; }
.seg-btn.is-active{ background:rgba(255,204,0,0.16); color:#fff; border:1px solid rgba(255,204,0,0.45); }

/* MÍDIAS */
.mlist{ display:flex; flex-direction:column; gap:6px; }
.media-line{
  display:grid; gap:6px; align-items:center;
  grid-template-columns:28px 150px 1fr minmax(220px, 360px) auto auto 28px;
  padding:8px; border-radius:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.10);
}
.drag{ width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); cursor:grab;}
.drag:active{ cursor:grabbing; }
.drag svg{ width:14px; height:14px; opacity:.85; }
.media-title{ color:#eaeaea; font-weight:800; font-size:.9rem; }
.pills{ display:flex; gap:6px; flex-wrap:wrap; }
.pill{
  padding:6px 10px; height:28px; border-radius:999px; cursor:pointer;
  border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); color:#eee; font-weight:700; font-size:.86rem;
}
.pill.is-active{ background:rgba(255,204,0,0.16); color:#fff; border-color:rgba(255,204,0,0.45); box-shadow:0 0 0 2px rgba(255,204,0,0.18) inset; }
.iconbtn{ width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); color:#eee; cursor:pointer; }
.iconbtn:hover{ background:rgba(255,255,255,0.12); }

/* PLANOS */
.plist{ display:flex; flex-direction:column; gap:6px; }
.plan-line{
  display:grid; gap:6px; align-items:center;
  grid-template-columns:28px 28px 1fr 120px auto 28px;
  padding:8px; border-radius:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.10);
}
.idx{ width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:10px; font-weight:800; font-size:.92rem; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); color:#fff; }

/* MODAL DE REGRAS */
.tfx5-rules-overlay[hidden]{ display:none !important; }
.tfx5-rules-overlay{ position:fixed; inset:0; z-index:3500; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); backdrop-filter: blur(10px); }
.tfx5-rules-dialog{ width:min(560px, calc(100vw - 32px)); border-radius:16px; border:1px solid rgba(255,204,0,0.18);
  background:rgba(0,0,0,0.82); box-shadow:0 10px 40px rgba(0,0,0,0.6); }
.r-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08); }
.r-head h4{ margin:0; color:#ffcc00; font-size:1rem; }
.r-body{ display:flex; gap:8px; flex-wrap:wrap; padding:10px; }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.07); color:#eee; font-weight:700; font-size:.86rem; }
.chip input{ width:16px; height:16px; accent-color:#ffcc00; }
.r-seconds .inp.xs{ width:72px; }
.r-actions{ display:flex; align-items:center; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,0.08); }
.r-actions .spacer{ flex:1; }

/* Responsivo */
@media (max-width:980px){
  .tfx5-card--plans{ grid-column:span 1; }
  .media-line{ grid-template-columns:28px 120px 1fr 1fr auto auto 28px; }
  .plan-line{ grid-template-columns:28px 28px 1fr 100px auto 28px; }
}
</style>

<script>
(function(){
  var offer = <%- JSON.stringify(offer || null) %>;
  var steps = <%- JSON.stringify(steps || []) %>;
  var currentStep = <%- JSON.stringify(currentStep || null) %>;

  function escapeHtml(s){ return (s || "").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function stepLabel(s){ return (s && (s.name || ('Etapa ' + (s.stepNo || '')))) || ''; }

  // --------- VIEW STATE (base da oferta vs etapa) ----------
  var params = new URLSearchParams(location.search);
  var hasStepParam = params.has('stepId') && currentStep && currentStep.id;
  var isBaseView = !hasStepParam; // se tem stepId na URL, estamos em "etapa"; ao clicar "Principal", mudamos para base.

  function updateTitleAndBreadcrumb(){
    var bc = document.getElementById('tfBreadcrumb');
    var h1 = document.getElementById('offerTitle');
    if (!bc || !h1) return;

    var offerName = (offer && offer.name) ? offer.name : 'Nome da Oferta';
    var offerHref = offer ? ("/ofertas/painel/" + offer.id) : "/ofertas";

    var items = [];
    items.push('<a href="/ofertas">Minhas Ofertas</a>');
    items.push('<span>›</span>');
    items.push('<a href="'+ offerHref +'">'+ escapeHtml(offerName) +'</a>');

    if (!isBaseView && currentStep && currentStep.id){
      items.push('<span>›</span>');
      items.push('<span>'+ escapeHtml(stepLabel(currentStep)) +'</span>');
      h1.textContent = stepLabel(currentStep);
    } else {
      h1.textContent = offerName;
    }

    bc.innerHTML = items.join('');
  }

  function setBaseView(on){
    isBaseView = !!on;
    var p = new URLSearchParams(location.search);
    if (isBaseView && p.has('stepId')){
      p.delete('stepId'); // remove o stepId da URL quando voltar para a visão base
      history.replaceState(null, '', location.pathname + (p.toString() ? ('?' + p.toString()) : ''));
    }
    updateTitleAndBreadcrumb();
  }

  updateTitleAndBreadcrumb();

  // Tabs
  var mainTabs = document.querySelectorAll('.tf-tabs-main .tab');
  var subTabsWrap = document.getElementById('subtabs-principal');
  mainTabs.forEach(function(btn){
    btn.addEventListener('click', function(e){
      var t = btn.dataset.tab;
      if (t === 'etapas') { e.preventDefault(); openStepsModal(); return; }

      mainTabs.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');

      if (t === 'principal'){ setBaseView(true); }
      if (subTabsWrap) subTabsWrap.style.display = (t === 'principal') ? 'flex' : 'none';
    });
  });
  if (subTabsWrap) subTabsWrap.style.display = 'flex';

  // Menu leve no botão "Etapas"
  (function(){
    var tab = document.getElementById('tabEtapas');
    if (!tab) return;
    var menu;
    function closeMenu(){ if(menu){ menu.remove(); menu=null; } }
    document.addEventListener('click', function(ev){ if(menu && !menu.contains(ev.target) && ev.target!==tab) closeMenu(); });
    tab.addEventListener('contextmenu', function(ev){
      ev.preventDefault();
      closeMenu();
      menu = document.createElement('div');
      menu.className = 'tf-steps-menu';
      menu.style.left = (ev.clientX + 4) + 'px';
      menu.style.top  = (ev.clientY + 4) + 'px';
      var b1 = document.createElement('button');
      b1.textContent = 'Gerenciar etapas';
      b1.addEventListener('click', function(){ closeMenu(); openStepsModal(); });
      var b2 = document.createElement('button');
      b2.textContent = 'Sem etapa (visão base da oferta)';
      b2.addEventListener('click', function(){
        closeMenu();
        setBaseView(true);
        if (offer && offer.id){
          window.location.href = '/ofertas/painel/' + offer.id;
        }
      });
      menu.appendChild(b1); menu.appendChild(b2);
      document.body.appendChild(menu);
    });
  })();

  // Toast
  function showToast(type, text){
    var host = document.createElement('div');
    host.style.position='fixed'; host.style.top='20px'; host.style.right='20px';
    host.style.zIndex='4000'; host.style.display='flex'; host.style.flexDirection='column'; host.style.gap='10px';
    var card = document.createElement('div');
    card.style.padding='10px 14px'; card.style.borderRadius='12px';
    card.style.border='1px solid rgba(255,204,0,0.35)';
    card.style.boxShadow='0 10px 30px rgba(0,0,0,0.45)';
    card.style.background = (type==='error') ? 'linear-gradient(90deg,#2a0000,#3a0000)' : 'linear-gradient(90deg,#ffcc00,#d4a100)';
    card.style.color = (type==='error') ? '#ffd5d5' : '#171300';
    card.style.fontWeight='800'; card.style.letterSpacing='.3px';
    card.style.transform='translateY(-10px) scale(.98)'; card.style.opacity='0';
    card.style.transition='transform .16s ease, opacity .16s ease';
    var icon = document.createElement('span'); icon.style.marginRight='8px'; icon.textContent = (type==='error') ? '⚠️' : '✔️';
    var txt = document.createElement('span'); txt.textContent = text || (type==='error' ? 'Falha' : 'Sucesso');
    var row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.appendChild(icon); row.appendChild(txt);
    card.appendChild(row); host.appendChild(card); document.body.appendChild(host);
    requestAnimationFrame(function(){ card.style.transform='translateY(0)'; card.style.opacity='1'; });
    setTimeout(function(){ card.style.transform='translateY(-10px)'; card.style.opacity='0'; setTimeout(function(){ host.remove(); }, 160); }, 2300);
  }

  // Botão "Salvar Alterações"
  var saveBtn = document.getElementById('btnSaveAll');
  function setBtnLoading(btn, on){
    if (!btn) return;
    if (on){ btn.disabled=true; if(!btn.dataset._txt) btn.dataset._txt=btn.textContent; btn.textContent='Salvando…'; btn.style.filter='brightness(1.03)'; btn.style.boxShadow='0 8px 26px rgba(255,204,0,0.35)'; }
    else { btn.disabled=false; btn.textContent = btn.dataset._txt || 'Salvar Alterações'; btn.style.filter=''; btn.style.boxShadow=''; }
  }
  function flashSaved(btn){
    if (!btn) return;
    btn.classList.remove('tf-pulse-once'); void btn.offsetWidth; btn.classList.add('tf-pulse-once');
    btn.textContent='Salvo!'; setTimeout(function(){ btn.textContent = btn.dataset._txt || 'Salvar Alterações'; }, 1100);
  }
  if (saveBtn){
    saveBtn.addEventListener('click', async function(){
      if (!offer) { showToast('error','Oferta inválida.'); return; }
      if (isBaseView || !currentStep) {
        flashSaved(saveBtn);
        showToast('success','Configurações salvas (oferta base).');
        return;
      }
      var draftSettings = (window.tfDraftSettings && typeof window.tfDraftSettings === 'object') ? window.tfDraftSettings : {};
      try{
        setBtnLoading(saveBtn,true);
        const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(currentStep.id)}/save`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ settings: draftSettings })
        });
        const js = await r.json(); if (!js || !js.ok) throw new Error('save_failed');
        flashSaved(saveBtn); showToast('success','Configurações salvas com sucesso.');
      }catch(e){ console.error(e); showToast('error','Não foi possível salvar.'); }
      finally{ setBtnLoading(saveBtn,false); }
    });
  }

  // ======== MODAL DE ETAPAS (lógica) ========
  var modal    = document.getElementById('stepsUnifiedModal');
  var btnClose = document.getElementById('btnCloseStepsUnified');
  var btnCancel= document.getElementById('btnCancelStepsUnified');
  var btnSave  = document.getElementById('btnSaveStepsUnified');
  var btnAdd   = document.getElementById('btnAddStepUnified');
  var listEl   = document.getElementById('tfStepsUnifiedList');

  var memSelectedId = null;       // id existente selecionado
  var memSelectedTmpKey = null;   // key de uma nova linha ainda sem id
  var tmpCounter = 0;

  function openStepsModal(){ hydrateListFromServer(); modal.removeAttribute('hidden'); }
  function closeStepsModal(){ modal.setAttribute('hidden',''); }

  if (btnClose) btnClose.addEventListener('click', closeStepsModal);
  if (btnCancel)btnCancel.addEventListener('click', closeStepsModal);
  if (modal){ modal.addEventListener('click', function(e){ if (e.target===modal) closeStepsModal(); }); }

  function clearEmptyHint(){
    var el = document.getElementById('tfStepsEmpty'); if (el) el.remove();
  }
  function renderEmptyHint(){
    if (listEl.querySelector('.tf-step-item')) return;
    if (document.getElementById('tfStepsEmpty')) return;
    var li = document.createElement('li'); li.id='tfStepsEmpty'; li.className='tf-steps-empty';
    li.textContent = 'Nenhuma etapa criada ainda. Clique em “Criar Etapa” para adicionar.';
    listEl.appendChild(li);
  }

  function hydrateListFromServer(){
    listEl.innerHTML = '';
    memSelectedId = null; memSelectedTmpKey = null;
    var ordered = steps.slice().sort(function(a,b){ return (a.stepNo||0)-(b.stepNo||0); });
    if (!ordered.length) { renderEmptyHint(); return; }
    ordered.forEach(function(s){
      addRow({ id:s.id, name:s.name, isCurrent:(s.settings && s.settings.is_current) || (currentStep && currentStep.id===s.id) });
    });
  }

  function addRow(opts){
    clearEmptyHint();

    var li = document.createElement('li'); li.className='tf-step-item';
    if (opts.id) li.dataset.id = opts.id; else li.dataset.new='1';
    if (opts.isCurrent) li.classList.add('is-current');

    var handle = document.createElement('div');
    handle.className='tf-drag-handle';
    handle.setAttribute('draggable','true');
    handle.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor"><circle cx="6" cy="5" r="1.3"/><circle cx="10" cy="5" r="1.3"/><circle cx="14" cy="5" r="1.3"/><circle cx="6" cy="10" r="1.3"/><circle cx="10" cy="10" r="1.3"/><circle cx="14" cy="10" r="1.3"/></svg>';

    var no = document.createElement('span'); no.className='tf-step-no'; no.textContent = listEl.querySelectorAll('.tf-step-item').length + 1;

    var input = document.createElement('input');
    input.className='tf-step-name'; input.type='text';
    input.placeholder='Ex: Etapa X, Upsell VIP';
    input.value = opts.name || ''; 
    input.dataset.oldName = opts.name || '';

    var actions = document.createElement('div'); actions.className='tf-actions-inline';

    var selectBtn = document.createElement('button'); 
    selectBtn.type='button'; 
    selectBtn.className='tf-btn-ghost'; 
    selectBtn.textContent = opts.isCurrent ? 'Acessar Etapa' : 'Selecionar Etapa';
    if (opts.isCurrent) selectBtn.classList.add('tf-access-btn');

    var badge = document.createElement('span'); badge.className = 'tf-badge' + (opts.isCurrent ? ' visible current' : '');
    badge.textContent='Atual';

    var radioWrap = document.createElement('label'); radioWrap.className='tf-select-radio';
    var radio = document.createElement('input'); radio.type='radio'; radio.name='tfStepCurrent';
    radio.checked = !!opts.isCurrent;
    radioWrap.appendChild(radio);

    // Selecionar/Acessar
    selectBtn.addEventListener('click', function(){
      if (selectBtn.textContent === 'Selecionar Etapa'){
        Array.from(listEl.children).forEach(function(row){
          if (!row.classList.contains('tf-step-item')) return;
          row.classList.remove('is-current');
          var b = row.querySelector('.tf-badge'); if (b){ b.classList.remove('visible','current'); }
          var r = row.querySelector('input[type="radio"]'); if (r){ r.checked = false; }
          var sb = row.querySelector('.tf-btn-ghost'); 
          if (sb){ sb.textContent='Selecionar Etapa'; sb.classList.remove('tf-access-btn'); }
        });
        li.classList.add('is-current');
        if (badge){ badge.classList.add('visible','current'); }
        radio.checked = true;
        selectBtn.textContent = 'Acessar Etapa';
        selectBtn.classList.add('tf-access-btn');

        if (li.dataset.id){ memSelectedId = li.dataset.id; memSelectedTmpKey = null; }
        else { memSelectedId = null; if (!li.dataset.key){ li.dataset.key = 'tmp-'+(++tmpCounter)+'-'+Date.now(); } memSelectedTmpKey = li.dataset.key; }

      } else {
        var sid = li.dataset.id || null;
        if (!sid){ showToast('error','Salve mudanças para acessar esta etapa.'); return; }
        document.getElementById('stepsUnifiedModal')?.setAttribute('hidden','');
        // ao acessar etapa, garantimos modo "etapa"
        var p = new URLSearchParams();
        p.set('stepId', sid);
        history.replaceState(null, '', location.pathname + '?' + p.toString());
        isBaseView = false;
        currentStep = { id: sid, name: input.value || null };
        updateTitleAndBreadcrumb();
        window.location.href = `/ofertas/painel/${offer.id}?stepId=${encodeURIComponent(sid)}`;
      }
    });

    actions.appendChild(selectBtn);
    actions.appendChild(badge);
    actions.appendChild(radioWrap);

    var delBtn = document.createElement('button'); 
    delBtn.className='tf-step-btn danger'; 
    delBtn.textContent='Excluir'; 
    delBtn.title='Excluir etapa';
    delBtn.addEventListener('click', function(){
      var overlay = document.createElement('div'); overlay.className='tf-steps-overlay'; overlay.style.zIndex='4001';
      var box = document.createElement('div'); box.className='tf-steps-dialog tf-steps-dialog--create-theme'; box.style.maxWidth='460px';
      box.innerHTML = '<div class="tf-steps-head tf-steps-head--center"><h3>Excluir etapa?</h3></div>' +
        '<div class="tf-steps-body tf-steps-body--compact"><p>Tem certeza que deseja excluir <strong>'+ escapeHtml(input.value || 'Etapa') +'</strong>? Essa ação não pode ser desfeita.</p></div>' +
        '<div class="tf-steps-actions tf-steps-actions--create-theme">' +
        '<button type="button" class="btn-secondary" id="cxCancel">Cancelar</button>' +
        '<button type="button" class="btn-primary" id="cxDelete">Excluir etapa</button>' +
        '</div>';
      overlay.appendChild(box); document.body.appendChild(overlay);

      function closeCx(){ overlay.remove(); }
      box.querySelector('#cxCancel').addEventListener('click', closeCx);
      overlay.addEventListener('click', function(e){ if (e.target === overlay) closeCx(); });

      box.querySelector('#cxDelete').addEventListener('click', async function(){
        if (!li.dataset.id){
          li.remove();
          recomputeNos();
          if (!listEl.querySelector('.tf-step-item')) renderEmptyHint();
          showToast('success','Etapa removida.');
          closeCx();
          return;
        }

        try{
          const stepId = li.dataset.id;
          const resp = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(stepId)}`, {
            method:'DELETE'
          });
          const js = await resp.json().catch(()=>null);
          if (!resp.ok || !js?.ok) throw new Error(js?.error || 'delete_failed');

          li.remove();
          recomputeNos();
          if (!listEl.querySelector('.tf-step-item')) renderEmptyHint();

          steps = steps.filter(s => s.id !== stepId);
          if (currentStep && currentStep.id === stepId){
            currentStep = null;
            setBaseView(true);
          }

          showToast('success','Etapa excluída com sucesso.');
        } catch (e){
          console.error(e);
          showToast('error','Não foi possível excluir.');
        } finally {
          closeCx();
        }
      });
    });

    li.appendChild(handle);
    li.appendChild(no);
    li.appendChild(input);
    li.appendChild(actions);
    li.appendChild(delBtn);
    listEl.appendChild(li);

    initDragFor(handle, li);
    if (!opts.id){ setTimeout(function(){ input.focus(); }, 0); }
  }

  // Drag
  var dragContext = { draggingLi: null };
  function initDragFor(handle, li){
    handle.addEventListener('dragstart', function(e){
      dragContext.draggingLi = li;
      li.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain','drag'); } catch(_) {}
    });
    handle.addEventListener('dragend', function(){
      if (dragContext.draggingLi){ dragContext.draggingLi.classList.remove('dragging'); dragContext.draggingLi = null; }
      recomputeNos();
    });
  }
  listEl.addEventListener('dragover', function(e){
    if (!dragContext.draggingLi) return;
    e.preventDefault();
    const after = getDragAfterElement(listEl, e.clientY);
    if (after == null){ listEl.appendChild(dragContext.draggingLi); }
    else { listEl.insertBefore(dragContext.draggingLi, after); }
  });
  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.tf-step-item:not(.dragging)')];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset){ return { offset, element: child }; }
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
  function recomputeNos(){
    var i = 0;
    Array.from(listEl.children).forEach(function(li){
      if (!li.classList.contains('tf-step-item')) return;
      var no = li.querySelector('.tf-step-no'); if (no) no.textContent = (++i);
    });
  }

  if (btnAdd){
    btnAdd.addEventListener('click', function(){
      addRow({ name:'', isCurrent:false });
      recomputeNos();
    });
  }

  // ====== Salvar Mudanças ======
  var saveModalBtn = document.getElementById('btnSaveStepsUnified');
  if (saveModalBtn){
    saveModalBtn.addEventListener('click', async function(){
      if (!offer) { showToast('error','Oferta inválida.'); return; }

      var creates = [];
      var updates = [];
      var deletes = [];
      var selectedId = null;
      var selectedIsTmp = false;

      var orderIds = [];

      Array.from(listEl.children).forEach(function(li){
        if (!li.classList.contains('tf-step-item')) return;

        var id   = li.dataset.id || null;
        var key  = li.dataset.key || null;
        var isNew= !id;
        var del  = li.dataset.deleted === '1';
        var name = (li.querySelector('.tf-step-name')?.value || '').trim();
        var old  = (li.querySelector('.tf-step-name')?.dataset.oldName || '').trim();
        var radio= li.querySelector('input[type="radio"]');

        if (!del){ orderIds.push(id || key || ''); }

        if (radio && radio.checked){
          if (id){ selectedId = id; }
          else { selectedIsTmp = true; }
        }

        if (isNew && !del){
          if (name) creates.push({ name: name });
          return;
        }
        if (isNew && del){ return; }
        if (!isNew && del){
          deletes.push({ id });
          return;
        }
        if (!isNew && name && name !== old){
          updates.push({ id, name });
        }
      });

      var payload = { create: creates, update: updates, delete: deletes };
      if (selectedId) payload.currentStepId = selectedId;

      saveModalBtn.disabled = true;
      saveModalBtn.textContent = 'Salvando…';
      try{
        const resp = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/batch`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const js = await resp.json();
        if (!resp.ok || !js?.ok) throw new Error(js?.error || 'batch_failed');

        if (Array.isArray(js.steps)){
          steps = js.steps.map(function(s){
            return {
              id: s.id,
              offerId: s.offer_id,
              name: s.name,
              stepNo: s.step_no,
              settings: s.settings || {},
              createdAt: s.created_at,
              updatedAt: s.updated_at
            };
          });
        }

        if (!selectedId && selectedIsTmp){
          var newest = null;
          steps.forEach(function(s){ if (!newest || (s.stepNo||0) > (newest.stepNo||0)) newest = s; });
          if (newest && newest.id){
            await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/batch`, {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ currentStepId: newest.id })
            });
            currentStep = newest;
            isBaseView = false;
          }
        } else if (selectedId){
          var cur = steps.find(function(s){ return s.id === selectedId; });
          if (cur){ currentStep = cur; isBaseView = false; }
        } else {
          currentStep = null;
          isBaseView = true;
        }

        updateTitleAndBreadcrumb();
        hydrateListFromServer();
        showToast('success','Etapas salvas com sucesso.');
      }catch(e){
        console.error(e);
        showToast('error','Falha ao salvar mudanças.');
      }finally{
        saveModalBtn.disabled = false;
        saveModalBtn.textContent = 'Salvar Mudanças';
      }
    });
  }
})();
</script>

<script>
/* ===== v5 JS — drag, adicionar linhas e modal de regras ===== */
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  /* ---------- Helpers ---------- */
  function makeDrag(){
    const h = document.createElement('div');
    h.className = 'drag';
    h.setAttribute('draggable','true');
    h.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor"><circle cx="6" cy="5" r="1.3"/><circle cx="10" cy="5" r="1.3"/><circle cx="14" cy="5" r="1.3"/><circle cx="6" cy="10" r="1.3"/><circle cx="10" cy="10" r="1.3"/><circle cx="14" cy="10" r="1.3"/></svg>';
    return h;
  }
  function makeTrash(){
    const b = document.createElement('button');
    b.type='button'; b.className='iconbtn'; b.title='Remover';
    b.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
    return b;
  }
  function initDrag(container, row, handle, onEnd){
    const ctx = { dragging:null };
    handle.addEventListener('dragstart', (e)=>{ ctx.dragging=row; row.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain','drag'); }catch(_){} });
    handle.addEventListener('dragend', ()=>{ if(ctx.dragging){ ctx.dragging.classList.remove('dragging'); ctx.dragging=null; onEnd && onEnd(); } });
    container.addEventListener('dragover', (e)=>{
      if (!ctx.dragging) return; e.preventDefault();
      const after = getAfter(container, e.clientY);
      if (after==null) container.appendChild(ctx.dragging); else container.insertBefore(ctx.dragging, after);
    });
    function getAfter(cont, y){
      const els = [...cont.children].filter(el=>!el.classList.contains('dragging'));
      return els.reduce((c, ch)=>{
        const box = ch.getBoundingClientRect();
        const off = y - box.top - box.height/2;
        return (off<0 && off>c.offset)?{offset:off, element:ch}:c;
      }, {offset:Number.NEGATIVE_INFINITY}).element;
    }
  }

  /* ---------- Modal de Regras (unificado) ---------- */
  const rules = { target:null, type:null, idx:null, state:{} };
  const overlay = $('#rulesOverlay');
  const titleEl = $('#rulesTitle');
  const btnClose = $('#rulesClose'), btnCancel=$('#rulesCancel'), btnApply=$('#rulesApply'), btnClear=$('#rulesClear');

  function openRules(opts){
    rules.target = opts.target || null;
    rules.type   = opts.type   || '';
    rules.idx    = opts.idx    || null;
    rules.state  = opts.state  || {};

    titleEl.textContent = opts.title || 'Regras';
    // reset UI
    $$('[data-rule]', overlay).forEach(i=>{
      if (i.type==='checkbox') i.checked = !!rules.state[i.dataset.rule];
      if (i.dataset.rule==='secondsVal') i.value = rules.state.secondsVal || '';
    });

    overlay.hidden = false;
  }
  function closeRules(){ overlay.hidden = true; }

  // Exclusividade "Não apagar"
  overlay.addEventListener('change', (e)=>{
    const t = e.target;
    if (!t.matches('[data-rule]')) return;
    if (t.dataset.rule==='noDelete' && t.checked){
      $$('input[type="checkbox"][data-rule]', overlay).forEach(ch=>{ if(ch!==t) ch.checked=false; });
    } else if (t.type==='checkbox' && t.checked){
      const noDel = overlay.querySelector('input[type="checkbox"][data-rule="noDelete"]');
      if (noDel) noDel.checked = false;
    }
  });

  btnClear.addEventListener('click', ()=>{
    $$('input[type="checkbox"][data-rule]', overlay).forEach(ch=>ch.checked=false);
    const sv = overlay.querySelector('[data-rule="secondsVal"]'); if (sv) sv.value='';
  });
  btnApply.addEventListener('click', ()=>{
    // coleta estado
    const state = {};
    $$('[data-rule]', overlay).forEach(i=>{
      if (i.type==='checkbox') state[i.dataset.rule] = i.checked;
      if (i.dataset.rule==='secondsVal') state.secondsVal = i.value.trim();
    });
    // propaga pro alvo (só guarda em dataset por enquanto)
    if (rules.target){
      rules.target.dataset.rules = JSON.stringify(state);
    }
    closeRules();
  });
  [btnCancel, btnClose].forEach(b=>b.addEventListener('click', closeRules));
  overlay.addEventListener('click', (e)=>{ if (e.target===overlay) closeRules(); });

  /* ---------- CARD 1 — Mídias ---------- */
  const mediaHost = $('#frontMediaList');
  const btnAddMedia = $('#btnAddMedia');

  function buildMedia(idx){
    const line = document.createElement('div');
    line.className='media-line'; line.dataset.idx=idx;

    const handle = makeDrag();

    const label = document.createElement('input');
    label.className='inp'; label.style.maxWidth='150px';
    label.name='front_media_label_'+idx; label.placeholder='Mídia '+idx;

    const url = document.createElement('input');
    url.className='inp'; url.name='front_media_url_'+idx; url.placeholder='URL da VSL (https://...)';

    const pills = document.createElement('div'); pills.className='pills'; pills.dataset.role='media-pos'; pills.dataset.idx=idx;
    const p1 = document.createElement('button'); p1.type='button'; p1.className='pill is-active'; p1.dataset.val='before'; p1.textContent='Antes da copy principal';
    const p2 = document.createElement('button'); p2.type='button'; p2.className='pill'; p2.dataset.val='after'; p2.textContent='Depois da copy principal';
    pills.appendChild(p1); pills.appendChild(p2);

    const hiddenPos = document.createElement('input');
    hiddenPos.type='hidden'; hiddenPos.name='front_media_pos_'+idx; hiddenPos.value='before';

    const delToggleWrap = document.createElement('label'); delToggleWrap.className='toggle';
    const delToggle = document.createElement('input'); delToggle.type='checkbox'; delToggle.dataset.role='media-del';
    delToggleWrap.appendChild(delToggle); delToggleWrap.appendChild(document.createTextNode('Apagar mensagem'));

    const rulesBtn = document.createElement('button');
    rulesBtn.type='button'; rulesBtn.className='ghost xs'; rulesBtn.textContent='Regras';
    rulesBtn.dataset.kind='media'; rulesBtn.dataset.idx=idx; rulesBtn.hidden = true;

    const del = makeTrash();

    pills.addEventListener('click', (e)=>{
      const b = e.target.closest('.pill'); if(!b) return;
      $$('.pill', pills).forEach(x=>x.classList.remove('is-active'));
      b.classList.add('is-active'); hiddenPos.value = b.dataset.val || 'before';
    });
    delToggle.addEventListener('change', ()=>{ rulesBtn.hidden = !delToggle.checked; });
    del.addEventListener('click', ()=>{ line.remove(); renumberMedia(); });

    rulesBtn.addEventListener('click', ()=>{
      openRules({
        target: rulesBtn,
        type: 'media',
        idx,
        title: 'Regras de apagar — Mídia ' + idx,
        state: rulesBtn.dataset.rules ? JSON.parse(rulesBtn.dataset.rules) : {}
      });
    });

    line.appendChild(handle);
    line.appendChild(label);
    line.appendChild(url);
    line.appendChild(pills);
    line.appendChild(delToggleWrap);
    line.appendChild(rulesBtn);
    line.appendChild(del);
    line.appendChild(hiddenPos);

    initDrag(mediaHost, line, handle, renumberMedia);
    return line;
  }
  function renumberMedia(){
    let i=0;
    $$('.media-line', mediaHost).forEach(l=>{
      l.dataset.idx = ++i;
      l.querySelector('input[name^="front_media_label_"]')?.setAttribute('name','front_media_label_'+i);
      l.querySelector('input[name^="front_media_url_"]')?.setAttribute('name','front_media_url_'+i);
      l.querySelector('input[name^="front_media_pos_"]')?.setAttribute('name','front_media_pos_'+i);
      const rb = l.querySelector('[data-kind="media"]'); if (rb) { rb.dataset.idx=i; }
    });
  }
  function addMedia(){
    const idx = ($$('.media-line', mediaHost).length||0)+1;
    mediaHost.appendChild(buildMedia(idx));
  }
  btnAddMedia?.addEventListener('click', addMedia);
  addMedia(); // inicia com 1

  /* ---------- CARD 2 — Copy VSL Regras ---------- */
  document.querySelector('[data-open-rules="vsl"]')?.addEventListener('click', (e)=>{
    openRules({
      target: e.currentTarget,
      type: 'vsl',
      title: 'Regras da Copy da VSL',
      state: e.currentTarget.dataset.rules ? JSON.parse(e.currentTarget.dataset.rules) : {}
    });
  });

  /* ---------- CARD 3 — CTA ---------- */
  const segYes = document.querySelector('[data-cta-enable="yes"]');
  const segNo  = document.querySelector('[data-cta-enable="no"]');
  const ctaFields = $('#ctaFields');

  function setCtaEnabled(on){
    [segYes, segNo].forEach(b=>b.classList.remove('is-active'));
    (on ? segYes : segNo).classList.add('is-active');
    ctaFields.style.opacity = on ? '1' : '.55';
    $$('input,textarea,button', ctaFields).forEach(el=>{
      if (el.hasAttribute('data-open-rules')) return; // botão regras continua clicável
      el.disabled = !on;
    });
  }
  segYes?.addEventListener('click', ()=>setCtaEnabled(true));
  segNo?.addEventListener('click', ()=>setCtaEnabled(false));
  setCtaEnabled(true);

  document.querySelector('[data-open-rules="cta"]')?.addEventListener('click', (e)=>{
    openRules({
      target: e.currentTarget,
      type: 'cta',
      title: 'Regras do CTA',
      state: e.currentTarget.dataset.rules ? JSON.parse(e.currentTarget.dataset.rules) : {}
    });
  });

  /* ---------- CARD 4 — Planos ---------- */
  const plansHost = $('#frontPlansList');
  const btnAddPlan = $('#btnAddPlan');

  function buildPlan(idx){
    const line = document.createElement('div');
    line.className='plan-line'; line.dataset.idx=idx;

    const handle = makeDrag();
    const no = document.createElement('span'); no.className='idx'; no.textContent = idx;

    const name = document.createElement('input');
    name.className='inp'; name.name='front_plan_name_'+idx; name.placeholder='Nome do plano (Ex.: Mensal VIP)';

    const value = document.createElement('input');
    value.className='inp'; value.name='front_plan_value_'+idx; value.placeholder='R$ 29,90';

    const rulesBtn = document.createElement('button');
    rulesBtn.type='button'; rulesBtn.className='ghost xs'; rulesBtn.textContent='Regras'; rulesBtn.dataset.kind='plan'; rulesBtn.dataset.idx=idx;

    const del = makeTrash();

    rulesBtn.addEventListener('click', ()=>{
      openRules({
        target: rulesBtn,
        type: 'plan',
        idx,
        title: 'Regras — Plano ' + idx,
        state: rulesBtn.dataset.rules ? JSON.parse(rulesBtn.dataset.rules) : {}
      });
    });
    del.addEventListener('click', ()=>{ line.remove(); renumberPlans(); });

    line.appendChild(handle);
    line.appendChild(no);
    line.appendChild(name);
    line.appendChild(value);
    line.appendChild(rulesBtn);
    line.appendChild(del);

    initDrag(plansHost, line, handle, renumberPlans);
    return line;
  }
  function renumberPlans(){
    let i=0;
    $$('.plan-line', plansHost).forEach(l=>{
      l.dataset.idx = ++i;
      l.querySelector('.idx').textContent = i;
      l.querySelector('input[name^="front_plan_name_"]')?.setAttribute('name','front_plan_name_'+i);
      l.querySelector('input[name^="front_plan_value_"]')?.setAttribute('name','front_plan_value_'+i);
      const rb = l.querySelector('[data-kind="plan"]'); if (rb) { rb.dataset.idx=i; }
    });
  }
  function addPlan(){
    const idx = ($$('.plan-line', plansHost).length||0)+1;
    plansHost.appendChild(buildPlan(idx));
  }
  btnAddPlan?.addEventListener('click', addPlan);
  addPlan(); // inicia com 1

  /* ---------- Regras: copy antes dos planos ---------- */
  document.querySelector('[data-open-rules="plansIntro"]')?.addEventListener('click', (e)=>{
    openRules({
      target: e.currentTarget,
      type: 'plansIntro',
      title: 'Regras — Copy antes dos planos',
      state: e.currentTarget.dataset.rules ? JSON.parse(e.currentTarget.dataset.rules) : {}
    });
  });

})();
</script>
