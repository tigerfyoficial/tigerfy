<!-- ===== MODAL: Gerenciar Etapas da Oferta (estilo "Criar nova oferta") ===== -->
<div class="tf-steps-overlay" id="stepsUnifiedModal" hidden>
  <div class="tf-steps-dialog steps-card" role="dialog" aria-modal="true">
    <!-- Cabeçalho -->
    <div class="steps-head">
      <div class="steps-head-titles">
        <h3>Gerenciar Etapas da Oferta</h3>
        <p class="steps-sub">
          Crie, selecione e organize as etapas desta oferta. As alterações só são aplicadas ao clicar em <strong>Salvar mudanças</strong>.
        </p>
      </div>
      <button type="button" class="steps-close" id="btnCloseStepsUnified" aria-label="Fechar">
        <!-- X centralizado -->
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Barra de ação superior -->
    <div class="steps-toolbar">
      <button type="button" class="btn-primary small" id="btnAddStepUnified">＋ Nova etapa</button>
      <span class="steps-hint">Clique em <strong>Salvar mudanças</strong> para aplicar.</span>
    </div>

    <!-- Lista -->
    <div class="steps-body">
      <ul class="steps-list" id="tfStepsUnifiedList" aria-label="Lista de Etapas"></ul>
    </div>

    <!-- Rodapé -->
    <div class="steps-actions">
      <button type="button" class="btn-secondary" id="btnCancelStepsUnified">Cancelar</button>
      <button type="button" class="btn-primary" id="btnSaveStepsUnified">Salvar mudanças</button>
    </div>
  </div>
</div>

<style>
  /* ===== Base do modal: replica o card da tela "Criar nova oferta" ===== */
  .tf-steps-overlay[hidden]{ display:none !important; }
  .tf-steps-overlay{
    position:fixed; inset:0; z-index:3000;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.55);
    backdrop-filter: blur(6px);
  }
  .tf-steps-dialog.steps-card{
    width:min(760px, calc(100vw - 40px));
    max-height:min(78vh, 760px);
    overflow:hidden;
    background:rgba(0,0,0,0.78);
    border:1px solid rgba(255,204,0,0.16);
    border-radius:20px;
    box-shadow:0 0 40px rgba(0,0,0,0.6);
    display:flex; flex-direction:column;
    transform: translateY(6px) scale(.99);
    animation: stepsIn .18s ease-out forwards;
  }
  @keyframes stepsIn { to { transform: translateY(0) scale(1); } }

  .steps-head{
    position:relative;
    padding:22px 22px 8px 22px;
    display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
  }
  .steps-head h3{
    margin:0; font-size:1.35rem; color:#ffcc00; letter-spacing:.2px;
  }
  .steps-sub{ margin:6px 0 0 0; color:#c9c9c9; font-size:.92rem; }
  .steps-close{
    display:flex; align-items:center; justify-content:center;
    width:36px; height:36px; border-radius:12px; cursor:pointer;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06); color:#eee;
    transition: background .2s, border-color .2s, transform .12s;
  }
  .steps-close:hover{ background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.22); }
  .steps-close:active{ transform: scale(.98); }

  .steps-toolbar{
    padding:8px 22px 4px 22px;
    display:flex; align-items:center; gap:12px; justify-content:space-between;
  }
  .steps-hint{ color:#c9c9c9; font-size:.85rem; }

  .steps-body{ padding:12px 16px 8px 16px; }
  .steps-list{
    list-style:none; margin:0; padding:0;
    display:flex; flex-direction:column; gap:10px;
    max-height:52vh; overflow:auto;
  }

  /* ===== Linha/card da etapa (inspirado no bloco de "Tipo de Bot") ===== */
  .step-item{
    display:grid;
    grid-template-columns: 34px 46px 1fr auto auto;
    align-items:center; gap:10px;
    padding:12px 12px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:14px;
    transition: border-color .2s, background .2s, box-shadow .2s, transform .12s;
  }
  .step-item:hover{
    border-color:rgba(255,204,0,0.35);
    background:rgba(255,255,255,0.08);
  }
  .step-item.current{
    border-color:#ffcc00;
    box-shadow:0 0 18px rgba(255,204,0,0.35);
  }

  /* Handle de drag (6 pontinhos) */
  .step-drag{
    display:flex; align-items:center; justify-content:center;
    width:30px; height:30px; border-radius:10px;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    cursor:grab; user-select:none;
  }
  .step-drag:active{ cursor:grabbing; }
  .dots6{
    display:grid; grid-template-columns: repeat(2, 4px); grid-auto-rows:4px; gap:4px;
  }
  .dots6 span{
    width:4px; height:4px; border-radius:50%;
    background:rgba(255,255,255,0.75);
  }

  .step-no{
    display:flex; align-items:center; justify-content:center;
    width:40px; height:30px; border-radius:999px;
    background:rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.16);
    color:#fff; font-weight:800;
  }

  .tf-step-name{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.06);
    color:#fff; font-size:.95rem; outline:none;
    transition:border-color .2s, box-shadow .2s;
  }
  .tf-step-name:focus{
    border-color:#ffcc00;
    box-shadow:0 0 0 2px rgba(255,204,0,0.28);
  }

  .step-actions{
    display:flex; align-items:center; gap:8px;
  }
  .btn-primary, .btn-secondary, .btn-danger, .btn-ghost{
    border:none; border-radius:10px; padding:9px 14px;
    font-weight:600; cursor:pointer; font-size:.92rem;
    display:inline-flex; align-items:center; justify-content:center;
    transition: filter .2s, opacity .2s, transform .12s, background .2s, border-color .2s, box-shadow .2s;
    text-decoration:none;
  }
  .btn-primary{
    background:linear-gradient(90deg,#ffcc00,#d4a100);
    color:#1a1300; box-shadow:0 0 16px rgba(255,204,0,0.35);
  }
  .btn-primary.small{ padding:8px 12px; font-size:.9rem; }
  .btn-primary:hover{ filter:brightness(1.03); }

  .btn-secondary{
    background:rgba(255,255,255,0.12); color:#fff;
  }
  .btn-secondary:hover{ background:rgba(255,255,255,0.18); }

  .btn-ghost{
    background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.14);
  }
  .btn-ghost:hover{ background:rgba(255,255,255,0.12); }

  .btn-danger{
    background:linear-gradient(90deg,#470000,#2a0000); color:#ffdada;
    border:1px solid rgba(255, 80, 80, .35);
  }
  .btn-danger:hover{ filter:brightness(1.05); }

  .badge-current{
    padding:6px 10px; border-radius:999px;
    background:linear-gradient(90deg,#ffcc00,#d4a100);
    color:#1a1300; font-weight:800; font-size:.78rem;
    border:1px solid rgba(255,204,0,0.35);
  }

  .steps-actions{
    padding:14px 16px 18px 16px;
    display:flex; justify-content:flex-end; gap:10px;
    border-top:1px solid rgba(255,255,255,0.12);
  }

  /* Drag UX */
  .step-item.dragging{ opacity:.7; transform: scale(.998); }
  .step-item.drag-over{ outline:2px dashed rgba(255,204,0,0.45); outline-offset:2px; }

  @media (max-width: 720px){
    .step-item{ grid-template-columns: 30px 40px 1fr auto; }
    .step-actions .btn-ghost{ padding:8px 10px; }
    .badge-current{ display:none; } /* reduz ruído no mobile */
  }
</style>

<script>
(function(){
  // Reaproveita variáveis existentes no escopo da página:
  var offer = (typeof offer !== 'undefined') ? offer : null;
  var steps = (typeof steps !== 'undefined') ? steps : [];
  var currentStep = (typeof currentStep !== 'undefined') ? currentStep : null;

  var modal    = document.getElementById('stepsUnifiedModal');
  var btnClose = document.getElementById('btnCloseStepsUnified');
  var btnCancel= document.getElementById('btnCancelStepsUnified');
  var btnSave  = document.getElementById('btnSaveStepsUnified');
  var btnAdd   = document.getElementById('btnAddStepUnified');
  var listEl   = document.getElementById('tfStepsUnifiedList');

  /* ---------- Abertura / Fechamento ---------- */
  function openStepsModal(){ renderListUnified(); modal.removeAttribute('hidden'); }
  function closeStepsModal(){ modal.setAttribute('hidden',''); }
  if (btnClose) btnClose.addEventListener('click', closeStepsModal);
  if (btnCancel)btnCancel.addEventListener('click', closeStepsModal);
  if (modal){ modal.addEventListener('click', function(e){ if (e.target === modal) closeStepsModal(); }); }

  // Se já existe um botão com id="tabEtapas" em outro lugar, reaproveite:
  var tabEtapas = document.getElementById('tabEtapas');
  if (tabEtapas){ tabEtapas.addEventListener('click', function(ev){ ev.preventDefault(); openStepsModal(); }); }

  /* ---------- Renderização da lista ---------- */
  function renderListUnified(){
    listEl.innerHTML = '';
    var ordered = steps.slice().sort(function(a,b){ return (a.stepNo||0)-(b.stepNo||0); });
    ordered.forEach(function(s, idx){
      addRowUnified({
        id: s.id,
        name: s.name,
        stepNo: s.stepNo || (idx+1),
        isCurrent: currentStep && currentStep.id === s.id
      });
    });
    attachDnD(); // ativa drag & drop após montar
  }

  function addRowUnified(opts){
    var li = document.createElement('li');
    li.className = 'step-item';
    if (opts.id) li.dataset.id = opts.id; else li.dataset.new = '1';

    // handle drag (visual) + ícones 6-pontinhos
    var handle = document.createElement('div');
    handle.className = 'step-drag'; handle.setAttribute('data-handle','1');
    var dots = document.createElement('div'); dots.className = 'dots6';
    for (var i=0;i<6;i++){ dots.appendChild(document.createElement('span')); }
    handle.appendChild(dots);

    // número da etapa
    var no = document.createElement('div'); no.className='step-no';
    no.textContent = opts.stepNo || (listEl.children.length + 1);

    // input nome
    var input = document.createElement('input');
    input.className='tf-step-name';
    input.type='text'; input.placeholder='Nova etapa';
    input.value = opts.name || ''; input.dataset.oldName = opts.name || '';

    // ações: Selecionar + Excluir + badge Atual (o radio fica oculto para compatibilidade)
    var actions = document.createElement('div'); actions.className='step-actions';

    // radio oculto (compatível com a lógica existente de "etapa atual")
    var radio = document.createElement('input');
    radio.type='radio'; radio.name='tfStepCurrent'; radio.hidden = true;
    radio.checked = !!opts.isCurrent;

    var selectBtn = document.createElement('button');
    selectBtn.type='button'; selectBtn.className='btn-ghost'; selectBtn.textContent='Selecionar';
    selectBtn.addEventListener('click', function(){
      // marca como atual (radio) e atualiza visual
      Array.from(listEl.querySelectorAll('input[type="radio"][name="tfStepCurrent"]'))
        .forEach(function(r){ r.checked = false; });
      radio.checked = true;
      updateCurrentVisual();
    });

    var delBtn = document.createElement('button');
    delBtn.type='button'; delBtn.className='btn-danger'; delBtn.textContent='Excluir';
    if (opts.stepNo === 1 && opts.id) delBtn.disabled = true; // (proteção opcional da 1ª etapa persistida)
    delBtn.addEventListener('click', function(){ confirmDeleteUnified(li, input.value || 'Etapa'); });

    var badge = document.createElement('span');
    badge.className='badge-current'; badge.textContent='Atual';
    if (!radio.checked) badge.style.display='none';

    actions.appendChild(selectBtn);
    actions.appendChild(delBtn);
    actions.appendChild(badge);

    // monta a linha
    li.appendChild(handle);
    li.appendChild(no);
    li.appendChild(input);
    li.appendChild(actions);
    li.appendChild(radio); // mantém no DOM para o salvamento

    listEl.appendChild(li);
  }

  function updateCurrentVisual(){
    Array.from(listEl.children).forEach(function(li){
      var r = li.querySelector('input[type="radio"][name="tfStepCurrent"]');
      var badge = li.querySelector('.badge-current');
      if (r && r.checked){
        li.classList.add('current');
        if (badge) badge.style.display='inline-flex';
      } else{
        li.classList.remove('current');
        if (badge) badge.style.display='none';
      }
    });
  }

  function recomputeNosUnified(){
    Array.from(listEl.children).forEach(function(li, idx){
      var no = li.querySelector('.step-no'); if (no) no.textContent = idx + 1;
    });
  }

  if (btnAdd){
    btnAdd.addEventListener('click', function(){
      addRowUnified({ name:'', stepNo: listEl.children.length + 1, isCurrent:false });
      attachDnD(); // reativa drag
      recomputeNosUnified();
    });
  }

  /* ---------- Confirmação de exclusão (reutiliza overlay) ---------- */
  function confirmDeleteUnified(li, displayName){
    var overlay = document.createElement('div'); overlay.className='tf-steps-overlay'; overlay.style.zIndex='4001';
    var box = document.createElement('div'); box.className='tf-steps-dialog steps-card'; box.style.maxWidth='460px';
    box.innerHTML =
      '<div class="steps-head"><div class="steps-head-titles"><h3>Excluir etapa?</h3></div></div>' +
      '<div class="steps-body" style="padding: 0 18px 8px 18px;"><p style="color:#eaeaea;margin:0 0 6px 0;">Tem certeza que deseja excluir <strong>'+ (displayName||'Etapa') +'</strong>? Essa ação não pode ser desfeita.</p></div>' +
      '<div class="steps-actions">' +
        '<button type="button" class="btn-secondary" id="cxCancel">Cancelar</button>' +
        '<button type="button" class="btn-danger" id="cxDelete">Excluir etapa</button>' +
      '</div>';
    overlay.appendChild(box); document.body.appendChild(overlay);

    function close(){ overlay.remove(); }
    overlay.addEventListener('click', function(e){ if (e.target === overlay) close(); });
    box.querySelector('#cxCancel').addEventListener('click', close);
    box.querySelector('#cxDelete').addEventListener('click', async function(){
      if (!li.dataset.id){ li.remove(); recomputeNosUnified(); updateCurrentVisual(); close(); return; }
      try{
        const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(li.dataset.id)}`, { method:'DELETE' });
        const js = await r.json(); if (!js || !js.ok) throw new Error('delete_failed');
        var removedId = li.dataset.id; li.remove(); recomputeNosUnified(); updateCurrentVisual();
        steps = steps.filter(function(s){ return s.id !== removedId; });
        if (currentStep && currentStep.id === removedId) { currentStep = null; }
      }catch(e){ console.error(e); }
      finally{ close(); }
    });
  }

  /* ---------- DRAG & DROP por handle ---------- */
  function attachDnD(){
    Array.from(listEl.children).forEach(function(li){
      li.setAttribute('draggable','true');

      li.addEventListener('dragstart', function(e){
        // só inicia se arrastar pelo handle
        if (!e.target.closest('[data-handle="1"]')) { e.preventDefault(); return; }
        li.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'drag'); // necessário para Firefox
      });

      li.addEventListener('dragend', function(){
        li.classList.remove('dragging');
        Array.from(listEl.children).forEach(el => el.classList.remove('drag-over'));
        recomputeNosUnified();
      });
    });

    listEl.addEventListener('dragover', function(e){
      e.preventDefault();
      const dragging = listEl.querySelector('.dragging');
      if (!dragging) return;
      const afterElement = getDragAfterElement(listEl, e.clientY);
      Array.from(listEl.children).forEach(el => el.classList.remove('drag-over'));
      if (afterElement == null) {
        listEl.appendChild(dragging);
      } else {
        listEl.insertBefore(dragging, afterElement);
        afterElement.classList.add('drag-over');
      }
    });
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.step-item:not(.dragging)')];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  /* ---------- Salvamento (mantém sua lógica) ---------- */
  var saveModalBtn = document.getElementById('btnSaveStepsUnified');
  if (saveModalBtn){
    saveModalBtn.addEventListener('click', async function(){
      saveModalBtn.disabled=true; saveModalBtn.textContent='Salvando…';
      try{
        // 1) Criar novas
        var newNames = [];
        Array.from(listEl.children).forEach(function(li){
          if (!li.dataset.id){
            var nm = (li.querySelector('.tf-step-name')?.value || '').trim();
            if (nm) newNames.push(nm);
          }
        });
        if (newNames.length){
          const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/batch`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ names: newNames })
          });
          const js = await r.json(); if (!js || !js.ok) throw new Error('batch_failed');
          let idx=0;
          Array.from(listEl.children).forEach(function(li){
            if (!li.dataset.id){
              li.dataset.id = js.steps[idx].id;
              steps.push(js.steps[idx]); idx++;
            }
          });
        }

        // 2) Renomear alteradas
        for (const li of Array.from(listEl.children)){
          const id = li.dataset.id; if (!id) continue;
          const input = li.querySelector('.tf-step-name');
          const oldName = input?.dataset.oldName || '';
          const newName = (input?.value || '').trim();
          if (newName && newName !== oldName){
            const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/${encodeURIComponent(id)}/rename`, {
              method:'PATCH', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ name: newName })
            });
            const js = await r.json(); if (!js || !js.ok) throw new Error('rename_failed');
            input.dataset.oldName = newName;
            var s = steps.find(x => x.id === id); if (s) s.name = newName;
            if (currentStep && currentStep.id === id){ currentStep.name = newName; }
          }
        }

        // 3) Reordenar (ordem = DOM atual pós-drag)
        var order = Array.from(listEl.children).map(function(li){ return li.dataset.id; }).filter(Boolean);
        if (order.length){
          const r = await fetch(`/ofertas/${encodeURIComponent(offer.id)}/etapas/reorder`, {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ order })
          });
          const js = await r.json(); if (!js || !js.ok) throw new Error('reorder_failed');
          order.forEach(function(id, idx){ var s = steps.find(x => x.id === id); if (s) s.stepNo = idx + 1; });
        }

        // 4) Etapa atual (via radio oculto marcado pelo botão "Selecionar")
        let selectedId = null;
        for (const li of Array.from(listEl.children)){
          const radio = li.querySelector('input[type="radio"][name="tfStepCurrent"]');
          if (radio && radio.checked) { selectedId = li.dataset.id || null; break; }
        }

        // feedback + fechar
        closeStepsModal();

        // Redireciona com/sem etapa
        if (selectedId){
          window.location.href = `/ofertas/painel/${offer.id}?stepId=${encodeURIComponent(selectedId)}`;
        } else {
          window.location.href = `/ofertas/painel/${offer.id}`;
        }
      }catch(e){
        console.error(e);
      }finally{
        saveModalBtn.disabled=false; saveModalBtn.textContent='Salvar mudanças';
      }
    });
  }

  // Atualiza visual "Atual" sempre que abrir / alterar algo
  const obs = new MutationObserver(updateCurrentVisual);
  obs.observe(listEl, { childList:true, subtree:true });
})();
</script>
