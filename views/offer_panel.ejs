<%- include('partials/visual_hottrack') %>

<div class="tiger-offer-panel">

  <!-- Breadcrumb (clicável via script) -->
  <nav id="tfBreadcrumb" class="tf-breadcrumb"></nav>

  <!-- Título + Etapa atual + Criar etapa / Salvar -->
  <div class="tf-title-row">
    <div class="tf-title-left">
      <h1 class="tf-offer-title"><%= (offer && offer.name) ? offer.name : 'Nome da Oferta' %></h1>

      <div class="tf-step-inline">
        <span class="tf-step-chip">
          Etapa: <%= (currentStep && currentStep.name) ? currentStep.name : 'Etapa 1' %>
        </span>
        <button id="btnCreateStep" type="button" class="tf-btn tf-btn-ghost">Criar etapa</button>
      </div>
    </div>

    <div class="tf-title-right">
      <button id="btnSaveAll" type="button" class="tf-btn tf-btn-primary">Salvar Alterações</button>
    </div>
  </div>

  <!-- Abas principais -->
  <div class="tf-tabs tf-tabs-main">
    <button class="tab active" data-tab="principal" type="button" aria-selected="true">
      <!-- dashboard/layout -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="7" height="7" rx="2"></rect>
        <rect x="14" y="3" width="7" height="7" rx="2"></rect>
        <rect x="14" y="14" width="7" height="7" rx="2"></rect>
        <rect x="3" y="14" width="7" height="7" rx="2"></rect>
      </svg>
      <span>Principal</span>
    </button>

    <button class="tab" data-tab="contingencia" type="button" aria-selected="false">
      <!-- shield/bot -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 2l7 4v5c0 5-3.5 9-7 11-3.5-2-7-6-7-11V6l7-4z"></path>
        <circle cx="12" cy="12" r="2"></circle>
      </svg>
      <span>Contingência de Bots</span>
    </button>

    <button class="tab" data-tab="traqueamento" type="button" aria-selected="false">
      <!-- target -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="8"></circle>
        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
        <circle cx="12" cy="12" r="2"></circle>
      </svg>
      <span>Traqueamento</span>
    </button>

    <button class="tab" data-tab="relatorios" type="button" aria-selected="false">
      <!-- chart line -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 3v18h18"></path>
        <path d="M7 15l4-4 3 3 5-6"></path>
      </svg>
      <span>Fluxo de Relatórios</span>
    </button>
  </div>

  <!-- Abas secundárias (só quando Principal) -->
  <div id="subtabs-principal" class="tf-tabs tf-tabs-sub" style="display:flex;">
    <button class="tab active" data-sub="front" type="button" aria-selected="true">
      <!-- chat/message -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
      </svg>
      <span>Front</span>
    </button>

    <button class="tab disabled" data-sub="orderbump" type="button" aria-disabled="true">
      <!-- tag plus -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
        <path d="M7 7h6"></path>
        <path d="M10 4v6"></path>
      </svg>
      <span>OrderBump (em breve)</span>
    </button>

    <button class="tab disabled" data-sub="upsell" type="button" aria-disabled="true">
      <!-- arrow up -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 19V5"></path>
        <path d="M5 12l7-7 7 7"></path>
      </svg>
      <span>Upsell (em breve)</span>
    </button>

    <button class="tab disabled" data-sub="downsell" type="button" aria-disabled="true">
      <!-- arrow down -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 5v14"></path>
        <path d="M19 12l-7 7-7-7"></path>
      </svg>
      <span>Downsell (em breve)</span>
    </button>

    <button class="tab" data-sub="pix" type="button" aria-selected="false">
      <!-- payment/qr -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="7" height="7" rx="1.5"></rect>
        <rect x="14" y="3" width="7" height="7" rx="1.5"></rect>
        <rect x="3" y="14" width="7" height="7" rx="1.5"></rect>
        <path d="M17 14v7M14 17h7"></path>
      </svg>
      <span>Mensagem PIX</span>
    </button>

    <button class="tab disabled" data-sub="disparos" type="button" aria-disabled="true">
      <!-- paper plane -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M22 2L11 13"></path>
        <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
      </svg>
      <span>Disparos (em breve)</span>
    </button>
  </div>

  <!-- Área de conteúdo (vazia por enquanto; apenas estrutura de navegação nesta etapa) -->
  <div class="tf-content">
    <div class="tf-content-card">
      <!-- Conteúdo dos cards será adicionado depois -->
    </div>
  </div>
</div>

<!-- Modal: Nova Etapa -->
<div id="stepModal" class="tf-modal" hidden>
  <div class="tf-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="stepModalTitle">
    <div class="tf-modal-header">
      <h3 id="stepModalTitle" class="tf-modal-title">Nova etapa</h3>
      <button id="btnCloseModal" type="button" class="tf-modal-close" aria-label="Fechar">×</button>
    </div>

    <div class="tf-modal-body">
      <label for="inpStepName" class="tf-label">Nome da etapa</label>
      <input id="inpStepName" type="text" class="tf-input"
             placeholder="Etapa 2 • Upsell Bot de Taxa • Funil Pós-Compra" />

      <div class="tf-divider"></div>

      <div class="tf-radio-group">
        <label class="tf-radio">
          <input type="radio" name="dupMode" value="0" checked>
          <span>Criar etapa do zero</span>
        </label>

        <label class="tf-radio">
          <input type="radio" name="dupMode" value="1">
          <span>Duplicar configurações da etapa atual (sem relatórios)</span>
        </label>
      </div>
    </div>

    <div class="tf-modal-footer">
      <button id="btnCancelStep" type="button" class="tf-btn tf-btn-ghost">Cancelar</button>
      <button id="btnConfirmStep" type="button" class="tf-btn tf-btn-primary">Criar etapa</button>
    </div>
  </div>
</div>

<!-- Toast host (discreto, premium) -->
<div id="tfToastHost" style="position:fixed; top:18px; left:0; right:0; display:flex; justify-content:center; pointer-events:none; z-index:1200;"></div>

<script>
(function(){
  var offer = <%- JSON.stringify(offer || null) %>;
  var steps = <%- JSON.stringify(steps || []) %>;
  var currentStep = <%- JSON.stringify(currentStep || null) %>;

  /* ---------- Tabs principais ---------- */
  var mainTabs = document.querySelectorAll('.tf-tabs-main .tab');
  var subTabsWrap = document.getElementById('subtabs-principal');
  mainTabs.forEach(function(btn){
    btn.addEventListener('click', function(){
      mainTabs.forEach(function(b){ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');
      var isPrincipal = btn.dataset.tab === 'principal';
      if(subTabsWrap){ subTabsWrap.style.display = isPrincipal ? 'flex' : 'none'; }
    });
  });
  if(subTabsWrap){ subTabsWrap.style.display = 'flex'; }

  /* ---------- Breadcrumb clicável ---------- */
  function escapeHtml(s){ return (s || "").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function buildBreadcrumb(){
    var bc = document.getElementById('tfBreadcrumb');
    if (!bc) return;
    var offerName = (offer && offer.name) ? offer.name : 'Nome da Oferta';
    var offerHref = offer ? ("/ofertas/painel/" + offer.id) : "/ofertas";
    var parts = [];
    parts.push('<a href="/ofertas">Minhas Ofertas</a>');
    parts.push('<span>›</span>');
    parts.push('<a href="'+ offerHref +'">'+ escapeHtml(offerName) +'</a>');
    if (currentStep && currentStep.id){
      parts.push('<span>›</span>');
      parts.push('<a href="'+ offerHref + '?stepId=' + encodeURIComponent(currentStep.id) +'">Etapa: '+ escapeHtml(currentStep.name) +'</a>');
    }
    bc.innerHTML = parts.join('');
  }
  buildBreadcrumb();

  /* ---------- Modal "Criar etapa" (abre só no clique) ---------- */
  var modal = document.getElementById('stepModal');
  var openBtn = document.getElementById('btnCreateStep');
  var closeBtn = document.getElementById('btnCloseModal');
  var cancelBtn = document.getElementById('btnCancelStep');
  var confirmBtn = document.getElementById('btnConfirmStep');
  var nameInput = document.getElementById('inpStepName');

  if (modal) modal.setAttribute('hidden','');

  function escToClose(e){ if (e.key === 'Escape') closeModal(); }
  function openModal(){
    if (!modal) return;
    var nextNo = 1;
    if (Array.isArray(steps) && steps.length){
      var max = Math.max.apply(null, steps.map(s => Number(s.stepNo || 0)));
      nextNo = isNaN(max) ? 1 : (max + 1);
    }
    if (nameInput) nameInput.value = 'Etapa ' + nextNo;
    modal.removeAttribute('hidden');
    nameInput && nameInput.focus();
    document.addEventListener('keydown', escToClose);
  }
  function closeModal(){
    if (!modal) return;
    modal.setAttribute('hidden','');
    document.removeEventListener('keydown', escToClose);
  }
  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
  if (modal){
    modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
  }

  if (confirmBtn){
    confirmBtn.addEventListener('click', async function(){
      var dupValue = document.querySelector('input[name="dupMode"]:checked')?.value || '0';
      var stepName = (nameInput?.value || '').trim();
      if (!stepName){
        var n = 1;
        if (Array.isArray(steps) && steps.length){
          var max = Math.max.apply(null, steps.map(s => Number(s.stepNo || 0)));
          n = isNaN(max) ? 1 : (max + 1);
        }
        stepName = 'Etapa ' + n;
      }

      try {
        const resp = await fetch('/ofertas/' + encodeURIComponent(offer.id) + '/etapas', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            name: stepName,
            duplicate: dupValue === '1',
            fromStepId: (dupValue === '1' && currentStep && currentStep.id) ? currentStep.id : null
          })
        });
        const js = await resp.json();
        if (!js || !js.ok) throw new Error('Falha ao criar etapa');

        // Redireciona para a nova etapa (uuid exclusivo)
        window.location.href = '/ofertas/painel/' + offer.id + '?stepId=' + encodeURIComponent(js.step.id);
      } catch (e) {
        console.error(e);
        showToast("Não foi possível criar a etapa. Tente novamente.", "error");
      }
    });
  }

  /* ---------- Botão "Salvar Alterações" com feedback premium ---------- */
  var btnSave = document.getElementById('btnSaveAll');
  function setBtnLoading(b){
    if (!btnSave) return;
    if (b){
      btnSave.dataset.label = btnSave.textContent;
      btnSave.textContent = 'Salvando…';
      btnSave.disabled = true;
    }else{
      if (btnSave.dataset.label) btnSave.textContent = btnSave.dataset.label;
      btnSave.disabled = false;
    }
  }

  if (btnSave){
    btnSave.addEventListener('click', async function(){
      if (!currentStep || !currentStep.id) return;

      // Aqui futuramente vamos coletar settings reais. Por ora, persistência mínima:
      const payload = {
        name: currentStep.name,
        settings: Object.assign({}, currentStep.settings || {}, {
          savedAt: new Date().toISOString()
        })
      };

      try {
        setBtnLoading(true);
        const resp = await fetch('/ofertas/' + encodeURIComponent(offer.id) + '/etapas/' + encodeURIComponent(currentStep.id) + '/save', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const js = await resp.json();
        if (!js || !js.ok) throw new Error('save_failed');

        currentStep = js.step || currentStep;

        showToast('Configurações da ' + (currentStep.name || 'Etapa') + ' salvas com sucesso.', 'success');
        btnSave.textContent = 'Salvo!';
        setTimeout(() => setBtnLoading(false), 900);
      } catch (e) {
        console.error(e);
        setBtnLoading(false);
        showToast('Não foi possível salvar. Tente novamente.', 'error');
      }
    });
  }

  /* ---------- Toast minimalista ---------- */
  function showToast(msg, type){
    var host = document.getElementById('tfToastHost');
    if (!host) return;
    var node = document.createElement('div');
    node.textContent = msg;
    node.style.pointerEvents = 'auto';
    node.style.maxWidth = '720px';
    node.style.padding = '10px 14px';
    node.style.margin = '0 12px';
    node.style.borderRadius = '12px';
    node.style.border = '1px solid rgba(255,255,255,0.14)';
    node.style.backdropFilter = 'blur(6px)';
    node.style.fontWeight = '600';
    node.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';
    node.style.transition = 'opacity .2s ease';
    node.style.opacity = '0';

    if (type === 'success'){
      node.style.background = 'linear-gradient(180deg, rgba(60, 220, 130, 0.15), rgba(255,255,255,0.05))';
      node.style.color = '#e9ffee';
    } else if (type === 'error'){
      node.style.background = 'linear-gradient(180deg, rgba(255, 80, 80, 0.18), rgba(255,255,255,0.05))';
      node.style.color = '#ffe9e9';
    } else {
      node.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04))';
      node.style.color = '#f1f1f1';
    }

    host.appendChild(node);
    requestAnimationFrame(() => { node.style.opacity = '1'; });
    setTimeout(() => {
      node.style.opacity = '0';
      setTimeout(() => { host.removeChild(node); }, 220);
    }, 1800);
  }
})();
</script>
