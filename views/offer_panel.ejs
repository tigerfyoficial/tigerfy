<%- include('partials/visual_hottrack') %>

<div class="tf-offer-panel">
  <!-- Breadcrumb -->
  <nav class="tf-breadcrumb" id="tfBreadcrumb"></nav>

  <!-- Header -->
  <header class="tf-header">
    <div class="tf-header-left">
      <h1 class="tf-offer-title" id="offerTitle"><%= offer?.name || 'Nome da Oferta' %></h1>

      <!-- Chip de etapa + dropdown -->
      <div class="tf-step-inline">
        <button type="button" id="tfStepChip" class="tf-step-chip tf-step-chip--click">
          Etapa: <strong id="tfStepName"><%= (currentStep && currentStep.name) ? currentStep.name : 'Etapa 1' %></strong>
          <span class="tf-caret" aria-hidden="true">‚ñæ</span>
        </button>
        <button type="button" id="btnCreateStep" class="tf-btn tf-btn-small">Criar etapa</button>

        <!-- Dropdown de etapas -->
        <div id="tfStepDropdown" class="tf-step-dropdown" hidden></div>
      </div>
    </div>

    <div class="tf-header-right">
      <button type="button" class="tf-btn tf-btn-primary" id="btnSaveAll">Salvar Altera√ß√µes</button>
    </div>
  </header>

  <!-- Abas principais -->
  <div class="tf-tabs">
    <button class="tab active" data-tab="principal">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="3" width="7" height="7" rx="2"></rect><rect x="14" y="14" width="7" height="7" rx="2"></rect><rect x="3" y="14" width="7" height="7" rx="2"></rect></svg>
      Principal
    </button>
    <button class="tab" data-tab="contingencia">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path></svg>
      Conting√™ncia de Bots
    </button>
    <button class="tab" data-tab="tracking">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15A1.65 1.65 0 0 0 21 13.35 8 8 0 0 0 12 4a8 8 0 0 0-8 9.35A1.65 1.65 0 0 0 5.6 15"></path></svg>
      Traqueamento
    </button>
    <button class="tab" data-tab="relatorios">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M19 17V7"></path><path d="M13 17V3"></path><path d="M7 17v-7"></path></svg>
      Fluxo de Relat√≥rios
    </button>
  </div>

  <!-- Subtabs -->
  <div class="tf-subtabs" id="subtabs-principal">
    <button class="subtab active" data-subtab="front">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h8"></path><path d="M17 8h.01"></path><path d="M19 4v6h6"></path></svg>
      Front
    </button>
    <button class="subtab" data-subtab="orderbump" disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M6 6h15l-1.5 9h-12z"></path><path d="M6 6l-1-3H2"></path><circle cx="9" cy="20" r="1"></circle><circle cx="18" cy="20" r="1"></circle><path d="M12 10h4"></path></svg>
      OrderBump (em breve)
    </button>
    <button class="subtab" data-subtab="upsell" disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"></path></svg>
      Upsell (em breve)
    </button>
    <button class="subtab" data-subtab="downsell" disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7l-6 6-4-4-8 8"></path></svg>
      Downsell (em breve)
    </button>
    <button class="subtab" data-subtab="pix">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
      Mensagem PIX
    </button>
    <button class="subtab" data-subtab="disparos" disabled>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
      Disparos (em breve)
    </button>
  </div>

  <section class="tf-content-placeholder"></section>
</div>

<!-- Modal "Nova etapa" (simplificado) -->
<div class="tf-modal-backdrop" id="stepModal" hidden>
  <div class="tf-modal tf-modal-animate">
    <div class="tf-modal-head">
      <h3>Nova etapa</h3>
      <button type="button" class="tf-modal-close" id="btnCloseModal" aria-label="Fechar">‚úï</button>
    </div>

    <div class="tf-modal-body">
      <div class="tf-field">
        <label for="inpStepName">Nome da etapa</label>
        <input type="text" id="inpStepName" placeholder="Ex.: Etapa 2" />
      </div>
    </div>

    <div class="tf-modal-actions">
      <button type="button" class="tf-btn" id="btnCancelStep">Cancelar</button>
      <button type="button" class="tf-btn tf-btn-primary" id="btnConfirmStep">Criar etapa</button>
    </div>
  </div>
</div>

<style>
  :root{
    --bg:#0b0b0b; --panel:rgba(255,255,255,0.04); --panel-strong:rgba(255,255,255,0.06);
    --border:rgba(255,255,255,0.12); --muted:#b8b8b8; --text:#ffffff;
    --accent:#ffcc00; --accent-dim:#d4a100; --shadow:0 8px 24px rgba(0,0,0,0.45);
    --radius:14px;
  }

  .tf-offer-panel{ color:var(--text); padding:60px 80px 100px 130px; max-width:1200px; margin:0 auto; }
  .tf-breadcrumb{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem; margin-bottom:10px; }
  .tf-breadcrumb a{ color:var(--muted); text-decoration:none; }
  .tf-breadcrumb a:hover{ color:#e0e0e0; }

  .tf-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:18px; }
  .tf-header-left{ display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
  .tf-offer-title{ margin:0; font-size:1.75rem; letter-spacing:.3px; background:linear-gradient(90deg,#fff,#d8d8d8); -webkit-background-clip:text; background-clip:text; color:transparent; }

  .tf-step-inline{ position:relative; display:flex; align-items:center; gap:8px; }
  .tf-step-chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px;
    background:var(--panel); border:1px solid var(--border); font-size:.9rem; color:#ddd;
  }
  .tf-step-chip--click{ cursor:pointer; transition:.2s; }
  .tf-step-chip--click:hover{ background:rgba(255,255,255,0.08); }
  .tf-caret{ opacity:.85; transform:translateY(1px); }

  /* Dropdown das etapas (visual claro + hover/ativo) */
  .tf-step-dropdown{
    position:absolute; top:36px; left:0; min-width:240px; max-height:320px; overflow:auto;
    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border:1px solid var(--border); border-radius:12px; box-shadow:0 14px 42px rgba(0,0,0,0.55);
    padding:6px; z-index:1100; backdrop-filter:blur(6px);
  }
  .tf-step-item{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px; border-radius:10px; font-weight:600; color:#eaeaea;
    transition:background .15s ease, transform .08s ease;
  }
  .tf-step-item:hover{ background:rgba(255,255,255,0.08); }
  .tf-step-item.active{ background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.18); }
  .tf-step-item .lbl{ display:flex; align-items:center; gap:8px; }
  .tf-step-item .pill{ font-size:.72rem; padding:3px 6px; border-radius:6px; color:#171300; background:linear-gradient(90deg,var(--accent),var(--accent-dim)); font-weight:800; letter-spacing:.3px; }
  .tf-step-del{
    appearance:none; background:transparent; border:0; color:#ffb3b3; cursor:pointer; font-weight:800;
    padding:2px 6px; border-radius:8px; transition:.15s;
  }
  .tf-step-del:hover{ color:#ffd5d5; background:rgba(255,0,0,.08); }

  .tf-btn{ appearance:none; border:1px solid var(--border); background:var(--panel-strong); color:#eee; padding:9px 14px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:var(--shadow); transition:.2s ease; }
  .tf-btn:hover{ border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.08); }
  .tf-btn:active{ transform:translateY(1px); }
  .tf-btn-small{ padding:7px 10px; font-size:.85rem; border-radius:999px; }
  .tf-btn-primary{ background:linear-gradient(90deg,var(--accent),var(--accent-dim)); color:#171300; border:1px solid rgba(255,204,0,0.35); box-shadow:0 6px 22px rgba(255,204,0,0.25); }
  .tf-btn-primary:hover{ filter:brightness(1.02); }

  .tf-tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:16px 0 10px 0; justify-content:center; }
  .tf-tabs .tab{ display:inline-flex; align-items:center; gap:8px; padding:9px 14px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dedede; font-weight:600; font-size:.92rem; cursor:pointer; transition:.2s; }
  .tf-tabs .tab:hover{ background:rgba(255,255,255,0.07); }
  .tf-tabs .tab.active{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.22); color:#fff; }

  .tf-subtabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:18px; }
  .tf-subtabs .subtab{ display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:#dcdcdc; font-weight:600; font-size:.9rem; cursor:pointer; transition:.2s; }
  .tf-subtabs .subtab[disabled]{ opacity:.45; cursor:not-allowed; }
  .tf-subtabs .subtab:not([disabled]):hover{ background:rgba(255,255,255,0.07); }
  .tf-subtabs .subtab.active{ background:rgba(255,255,255,0.10); border-color:rgba(255,255,255,0.22); color:#fff; }

  .tf-content-placeholder{ min-height:360px; border:1px dashed rgba(255,255,255,0.12); border-radius:var(--radius); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow:var(--shadow); }

  /* Modal + anima√ß√£o leve */
  .tf-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; padding:20px; z-index:1000; }
  .tf-modal-backdrop[hidden]{ display:none !important; }
  .tf-modal{ width:100%; max-width:560px; background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.045)); border:1px solid var(--border); border-radius:16px; box-shadow:0 14px 42px rgba(0,0,0,0.55); backdrop-filter: blur(6px); }
  .tf-modal-animate{ animation: tfModalIn .18s ease-out; transform-origin: 50% 45%; }
  @keyframes tfModalIn{ from{ opacity:0; transform:scale(.98); } to{ opacity:1; transform:scale(1); } }
  .tf-modal-head{ display:flex; align-items:center; justify-content:space-between; padding:16px 16px 10px 16px; border-bottom:1px solid rgba(255,255,255,0.09); }
  .tf-modal-head h3{ margin:0; font-size:1.06rem; color:#fff; letter-spacing:.2px; }
  .tf-modal-close{ background:transparent; border:0; color:#ccc; cursor:pointer; font-size:16px; padding:4px; }
  .tf-modal-close:hover{ color:#fff; }
  .tf-modal-body{ padding:16px; display:flex; flex-direction:column; gap:14px; }
  .tf-field label{ display:block; font-weight:700; margin-bottom:6px; color:#efefef; font-size:.95rem; letter-spacing:.2px; }
  .tf-field input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.07); color:#fff; border:1px solid rgba(255,255,255,0.18); outline:none; font-size:.98rem; }
  .tf-field input[type="text"]::placeholder{ color:#bfbfbf; }
  .tf-field input[type="text"]:focus{ border-color:rgba(255,204,0,0.6); box-shadow:0 0 0 2px rgba(255,204,0,0.20); }
  .tf-modal-actions{ display:flex; align-items:center; justify-content:flex-end; gap:10px; padding:12px 16px 16px 16px; border-top:1px solid rgba(255,255,255,0.09); }

  /* Bot√£o "3D" ap√≥s salvar (efeito r√°pido e discreto) */
  @keyframes tfSavedPulse {
    0%   { transform: perspective(600px) translateZ(0); box-shadow: 0 6px 22px rgba(255,204,0,0.25); }
    40%  { transform: perspective(600px) translateZ(6px); box-shadow: 0 10px 30px rgba(255,204,0,0.45); }
    100% { transform: perspective(600px) translateZ(0); box-shadow: 0 6px 22px rgba(255,204,0,0.25); }
  }

  @media (max-width: 980px){
    .tf-offer-panel{ padding:40px 18px 80px 18px; }
    .tf-header{ flex-direction:column; align-items:flex-start; gap:10px; }
  }
</style>

<script>
(function(){
  var offer = <%- JSON.stringify(offer || null) %>;
  var steps = <%- JSON.stringify(steps || []) %>;
  var currentStep = <%- JSON.stringify(currentStep || null) %>;

  /* breadcrumb */
  function escapeHtml(s){ return (s || "").replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  (function buildBreadcrumb(){
    var bc = document.getElementById('tfBreadcrumb'); if (!bc) return;
    var offerName = (offer && offer.name) ? offer.name : 'Nome da Oferta';
    var offerHref = offer ? ("/ofertas/painel/" + offer.id) : "/ofertas";
    var items = [];
    items.push('<a href="/ofertas">Minhas Ofertas</a>');
    items.push('<span>‚Ä∫</span>');
    items.push('<a href="'+ offerHref +'">'+ escapeHtml(offerName) +'</a>');
    if (currentStep && currentStep.id) {
      items.push('<span>‚Ä∫</span>');
      var stepUrl = offerHref + "?stepId=" + encodeURIComponent(currentStep.id);
      items.push('<a href="'+ stepUrl +'">'+ escapeHtml(currentStep.name || ('Etapa ' + (currentStep.stepNo||''))) +'</a>');
    }
    bc.innerHTML = items.join('');
  })();

  /* chip texto da etapa atual */
  try {
    var chipTxt = document.getElementById('tfStepName');
    if (chipTxt && currentStep) chipTxt.textContent = currentStep.name || ('Etapa ' + (currentStep.stepNo || ''));
  } catch(_) {}

  /* tabs principais */
  var mainTabs = document.querySelectorAll('.tf-tabs .tab');
  var subTabsWrap = document.getElementById('subtabs-principal');
  mainTabs.forEach(function(btn){
    btn.addEventListener('click', function(){
      mainTabs.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      var isPrincipal = btn.dataset.tab === 'principal';
      if (subTabsWrap) subTabsWrap.style.display = isPrincipal ? 'flex' : 'none';
    });
  });
  if (subTabsWrap) subTabsWrap.style.display = 'flex';

  /* Toast premium (topo) */
  function showToast(type, text){
    var wrap = document.createElement('div');
    wrap.style.position='fixed'; wrap.style.top='22px'; wrap.style.left='50%'; wrap.style.transform='translateX(-50%)';
    wrap.style.zIndex='3000';

    var card = document.createElement('div');
    card.style.padding='10px 14px'; card.style.borderRadius='10px';
    card.style.border='1px solid rgba(255,204,0,0.35)';
    card.style.boxShadow='0 10px 30px rgba(0,0,0,0.45)';
    card.style.background = (type==='error')
      ? 'linear-gradient(90deg,#2a0000,#3a0000)'
      : 'linear-gradient(90deg,#ffcc00,#d4a100)';
    card.style.color = (type==='error') ? '#ffd5d5' : '#171300';
    card.style.fontWeight='800'; card.style.letterSpacing='.3px';
    card.textContent = text || (type==='error' ? 'Falhou' : 'Salvo!');
    wrap.appendChild(card);
    document.body.appendChild(wrap);
    setTimeout(function(){ wrap.remove(); }, 1400);
  }

  /* Bot√£o salvar: estados + efeito 3D no sucesso */
  var saveBtn = document.getElementById('btnSaveAll');
  function setButtonLoading(btn, isLoading){
    if (!btn) return;
    if (isLoading){
      btn.disabled = true;
      if (!btn.dataset._txt) btn.dataset._txt = btn.textContent;
      btn.textContent = 'Salvando‚Ä¶';
      btn.style.filter='brightness(1.02)';
      btn.style.boxShadow='0 6px 22px rgba(255,204,0,0.35)';
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset._txt || 'Salvar Altera√ß√µes';
      btn.style.filter=''; btn.style.boxShadow='';
    }
  }
  function flashSaved(btn){
    if (!btn) return;
    const old = btn.textContent;
    btn.textContent = 'Salvo!';
    btn.style.animation = 'tfSavedPulse .55s ease-out';
    setTimeout(function(){
      btn.style.animation = '';
      btn.textContent = btn.dataset._txt || 'Salvar Altera√ß√µes';
    }, 900);
  }

  if (saveBtn){
    saveBtn.addEventListener('click', async function(){
      var draftSettings = (window.tfDraftSettings && typeof window.tfDraftSettings === 'object')
        ? window.tfDraftSettings
        : {};
      try{
        setButtonLoading(saveBtn, true);
        const r = await fetch('/ofertas/' + encodeURIComponent(offer.id) + '/etapas/' + encodeURIComponent(currentStep.id) + '/save', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ settings: draftSettings })
        });
        const js = await r.json();
        if (!js || !js.ok) throw new Error('save_failed');
        flashSaved(saveBtn);
        showToast('success','Etapa salva com sucesso.');
      }catch(e){
        console.error(e);
        showToast('error','N√£o foi poss√≠vel salvar. Tente novamente.');
      }finally{
        setButtonLoading(saveBtn, false);
      }
    });
  }

  /* Modal criar etapa (simples) */
  var stepModal = document.getElementById('stepModal');
  var openBtn = document.getElementById('btnCreateStep');
  var closeBtn = document.getElementById('btnCloseModal');
  var cancelBtn = document.getElementById('btnCancelStep');
  var confirmBtn = document.getElementById('btnConfirmStep');
  var nameInput = document.getElementById('inpStepName');

  function escToClose(e){ if(e.key==='Escape') closeModal(); }
  function openModal(){
    if(!stepModal) return;
    var nextNo = 1;
    if (Array.isArray(steps) && steps.length){
      nextNo = Math.max.apply(null, steps.map(function(s){return Number(s.stepNo||0)})) + 1;
    }
    if (nameInput) nameInput.value = 'Etapa ' + nextNo;
    stepModal.removeAttribute('hidden'); nameInput && nameInput.focus();
    document.addEventListener('keydown', escToClose);
  }
  function closeModal(){ if(stepModal){ stepModal.setAttribute('hidden',''); document.removeEventListener('keydown',escToClose); } }

  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
  if (stepModal){ stepModal.addEventListener('click', function(e){ if (e.target === stepModal) closeModal(); }); }

  if (confirmBtn){
    confirmBtn.addEventListener('click', async function(){
      var stepName = (nameInput?.value || '').trim() || 'Etapa';
      try {
        const r = await fetch('/ofertas/' + encodeURIComponent(offer.id) + '/etapas', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: stepName, duplicate: false })
        });
        const js = await r.json();
        if (!js || !js.ok) throw new Error('create_failed');
        window.location.href = '/ofertas/painel/' + offer.id + '?stepId=' + encodeURIComponent(js.step.id);
      } catch(e){
        console.error(e);
        showToast('error','N√£o foi poss√≠vel criar a etapa.');
      }
    });
  }

  /* Dropdown de etapas (UX clara + excluir) */
  var chip = document.getElementById('tfStepChip');
  var dd = document.getElementById('tfStepDropdown');

  function renderDropdown(){
    if (!dd) return;
    dd.innerHTML = '';
    (steps || []).forEach(function(s){
      var item = document.createElement('div');
      item.className = 'tf-step-item' + ((currentStep && s.id === currentStep.id) ? ' active' : '');
      item.dataset.id = s.id;

      var lbl = document.createElement('div');
      lbl.className = 'lbl';
      lbl.textContent = s.name || ('Etapa ' + (s.stepNo || ''));

      if (currentStep && s.id === currentStep.id){
        var pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = 'Atual';
        lbl.appendChild(pill);
      }

      var del = document.createElement('button');
      del.className = 'tf-step-del';
      del.type = 'button';
      del.textContent = 'üóë'; // discreto; mant√©m estilo minimalista
      del.title = 'Excluir etapa';

      del.addEventListener('click', async function(ev){
        ev.stopPropagation();
        // protege Etapa 1 no cliente tamb√©m
        if ((s.stepNo || 0) === 1){
          showToast('error','A Etapa 1 n√£o pode ser exclu√≠da.');
          return;
        }
        try{
          const r = await fetch('/ofertas/' + encodeURIComponent(offer.id) + '/etapas/' + encodeURIComponent(s.id), { method:'DELETE' });
          const js = await r.json();
          if (!js || !js.ok) throw new Error('delete_failed');
          // atualiza steps na mem√≥ria
          steps = js.steps || [];
          // se deletou a atual, redireciona para a primeira da lista
          if (currentStep && currentStep.id === s.id){
            var next = steps[0];
            if (next) {
              window.location.href = '/ofertas/painel/' + offer.id + '?stepId=' + encodeURIComponent(next.id);
            } else {
              window.location.href = '/ofertas/painel/' + offer.id;
            }
            return;
          }
          renderDropdown();
          showToast('success','Etapa exclu√≠da.');
        }catch(e){
          console.error(e);
          showToast('error','N√£o foi poss√≠vel excluir a etapa.');
        }
      });

      item.appendChild(lbl);
      item.appendChild(del);

      item.addEventListener('click', function(){
        if (s.id === (currentStep && currentStep.id)) { dd.hidden = true; return; }
        window.location.href = '/ofertas/painel/' + offer.id + '?stepId=' + encodeURIComponent(s.id);
      });

      dd.appendChild(item);
    });
  }

  if (chip){
    chip.addEventListener('click', function(){
      if (dd.hidden){
        renderDropdown();
        dd.hidden = false;
        document.addEventListener('click', outsideClose, { once:true });
      } else {
        dd.hidden = true;
      }
    });
  }
  function outsideClose(ev){
    if (!dd.contains(ev.target) && ev.target !== chip) dd.hidden = true;
  }
})();
</script>
