<%- include('partials/visual_hottrack') %>

<div class="fx-wrap">
  <!-- Cabeçalho enxuto (igual Flexion: título + contexto) -->
  <div class="fx-head">
    <div>
      <h1>Gerenciar Mensagens e Funis</h1>
      <p class="muted">Oferta: <strong class="gold"><%= offer.name %></strong> · ID: <%= offer.id %></p>
    </div>
    <a href="/ofertas" class="btn ghost">Voltar</a>
  </div>

  <!-- ===== GRID FLEXION: ESQUERDA (CARD ÚNICO) + DIREITA (PLANOS & BOTÕES) ===== -->
  <div class="fx-grid">
    <!-- =================== COLUNA ESQUERDA: CARD ÚNICO =================== -->
    <section class="fx-left">
      <article class="card card-lg">
        <!-- Título + subtítulo da seção -->
        <header class="card-header">
          <div class="title">
            <div class="ic"></div>
            <h3>Mensagem Principal (/start)</h3>
          </div>
          <p class="muted s">
            Esta é a mensagem inicial que o usuário recebe ao interagir com o bot pela primeira vez.
            Se o CTA estiver ativo, a mensagem de oferta será exibida com um botão.
          </p>
        </header>

        <!-- Campo de texto grande (o maior elemento) -->
        <div class="field">
          <label>Conteúdo da Mensagem</label>
          <textarea id="frontCopy" placeholder="Digite sua mensagem de boas-vindas. Use tags como [[nome]] se quiser."></textarea>
        </div>

        <!-- Mídias atuais + inserir mídia (Telegram) -->
        <div class="media-row">
          <div class="field grow">
            <label>Mídias atuais</label>
            <ul id="mediaList" class="media-list"><!-- Itens adicionados via JS --></ul>
          </div>
          <div class="media-actions">
            <button class="btn ghost" id="btnAddMedia">Inserir mídia (Telegram)</button>
          </div>
        </div>

        <hr class="sep">

        <!-- CTA dentro do MESMO card (toggle à direita do título) -->
        <div class="cta-block">
          <div class="cta-head">
            <h4>Botão de Ação (CTA)</h4>
            <label class="switch">
              <input id="ctaOn" type="checkbox">
              <span></span>
            </label>
          </div>

          <div class="field">
            <label>Texto da Chamada (opcional)</label>
            <input id="ctaHeadline" type="text" placeholder="Ex.: Cansado de perder tempo? Clique abaixo para garantir sua vaga agora mesmo!">
          </div>

          <div class="field">
            <label>Texto do Botão</label>
            <input id="ctaText" type="text" placeholder="QUERO MINHA VAGA AGORA">
          </div>
        </div>

        <!-- Salvar Alterações (sempre no final, dentro do card) -->
        <div class="actions">
          <button class="btn primary" id="btnSaveFront">Salvar Alterações</button>
        </div>
      </article>
    </section>

    <!-- =================== COLUNA DIREITA: PLANOS & BOTÕES =================== -->
    <aside class="fx-right">
      <article class="card">
        <div class="card-header row-between">
          <h3>Planos &amp; Botões</h3>
          <div class="row gap8">
            <button class="btn ghost" id="btnCreateRedirect">Criar Redirect</button>
            <button class="btn primary" id="btnAddPlan">+ Criar Plano</button>
          </div>
        </div>

        <!-- Lista de planos (mini cards compactos como na Flexion) -->
        <div id="plansList" class="plans-list">
          <!-- Mini-card de plano (gerado via JS) -->
          <!--
          Estrutura:
          .plan-item
            .plan-h (nome + id à direita)
            .plan-meta (valor | duração)
            .plan-extra (entregável)
            .plan-actions (Editar/Excluir/Salvar)
          -->
        </div>
      </article>
    </aside>
  </div>
</div>

<style>
  :root{
    --bg:#0a0a0a; --panel:#0f0f0f; --line:rgba(255,255,255,.10);
    --text:#f2f2f2; --muted:#a6a6a6; --gold:#ffcc00; --gold2:#d1a200;
    --ring:rgba(255,204,0,.22); --shadow:0 18px 60px rgba(0,0,0,.55); --glow:0 0 38px rgba(255,204,0,.06);
  }
  .fx-wrap{max-width:1180px;margin:0 auto;padding:42px 18px 80px;color:var(--text)}
  .fx-head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px}
  .fx-head h1{margin:0 0 4px;font-size:1.9rem;color:#f7e8b0}
  .muted{color:var(--muted)} .muted.s{font-size:.92rem}
  .gold{color:#f7e8b0}

  .fx-grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media (max-width:1060px){ .fx-grid{grid-template-columns:1fr} }

  .card{
    background:radial-gradient(900px 240px at -15% -30%, rgba(255,204,0,.05), transparent 48%), var(--panel);
    border:1px solid var(--line); border-radius:16px; padding:16px;
    box-shadow:var(--shadow),var(--glow);
  }
  .card-lg{padding:18px 16px 16px}
  .card-header{margin-bottom:12px}
  .card-header .title{display:flex;align-items:center;gap:10px}
  .card-header h3{margin:0;color:#f7e8b0;font-size:1.06rem}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  .row{display:flex;align-items:center} .gap8{gap:8px}

  .field{margin-bottom:10px}
  .field label{display:block;margin:0 0 6px 2px;font-size:.88rem;color:#e9e9e9}
  .field input,.field textarea{
    width:100%;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);
    color:#fff;padding:10px 12px;outline:none
  }
  .field textarea{min-height:160px;resize:vertical}
  .field input:focus,.field textarea:focus{border-color:var(--gold);box-shadow:0 0 0 2px var(--ring)}

  .media-row{display:flex;gap:12px;align-items:flex-end}
  .media-row .grow{flex:1}
  .media-list{display:flex;flex-direction:column;gap:8px;margin:0;padding:0;list-style:none}
  .media-item{display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
  .media-item a{color:#ddd;text-decoration:none}
  .media-actions{display:flex;align-items:center}

  .sep{border:0;border-top:1px solid var(--line);margin:14px 0}

  .cta-block{margin-top:8px}
  .cta-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cta-head h4{margin:0;color:#f7e8b0;font-size:1rem}

  .actions{display:flex;justify-content:flex-end;margin-top:12px}

  .btn{border:1px solid var(--line);background:transparent;color:#eaeaea;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.2)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
  .btn.primary{border:none;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#1a1300;font-weight:700;box-shadow:0 0 12px rgba(255,204,0,.35)}

  /* Switch minimalista (toggle) */
  .switch{position:relative;display:inline-block;width:46px;height:26px}
  .switch input{display:none}
  .switch span{position:absolute;inset:0;background:#2b2b2b;border:1px solid var(--line);border-radius:999px;transition:.2s}
  .switch span:after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#cfcfcf;border-radius:50%;transition:.2s}
  .switch input:checked+span{background:var(--gold)}
  .switch input:checked+span:after{left:23px;background:#1a1300}

  /* Planos (mini cards) — coluna direita */
  .plans-list{display:flex;flex-direction:column;gap:10px}
  .plan-item{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);padding:10px}
  .plan-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .plan-name{font-weight:600}
  .plan-id{color:#bdbdbd;font-size:.86rem}
  .plan-meta{color:#d5d5d5;font-size:.9rem;margin-bottom:8px}
  .plan-extra{display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center;margin-bottom:8px}
  .plan-actions{display:flex;gap:8px;justify-content:flex-end}
  .plan-actions .btn{padding:8px 10px;border-radius:10px}
</style>

<script>
  // ====== Mídias (lista simples) ======
  const mediaList = document.getElementById('mediaList');
  document.getElementById('btnAddMedia')?.addEventListener('click', () => {
    const url = prompt('Cole o link da mídia do Telegram:');
    if(!url) return;
    const li = document.createElement('li');
    li.className = 'media-item';
    li.innerHTML = `
      <a href="${url}" target="_blank" rel="noopener">${url}</a>
      <button class="btn ghost btnDelMedia">Excluir</button>
    `;
    mediaList.appendChild(li);
  });
  mediaList?.addEventListener('click', e => {
    if(e.target.classList.contains('btnDelMedia')) e.target.closest('.media-item')?.remove();
  });

  // ====== Planos (mini-cards na direita) ======
  const plansList = document.getElementById('plansList');
  const btnAddPlan = document.getElementById('btnAddPlan');

  function addPlanCard(data = {}) {
    const id = data.id || ('novo-' + Math.random().toString(36).slice(2, 8));
    const wrapper = document.createElement('div');
    wrapper.className = 'plan-item';
    wrapper.innerHTML = `
      <div class="plan-h">
        <div class="plan-name">${data.name || 'NOVO PLANO'}</div>
        <div class="plan-id">ID: ${id}</div>
      </div>
      <div class="plan-meta">
        Valor: <input type="text" class="p-price" value="${data.price || ''}" placeholder="R$"> ·
        Duração: <input type="number" class="p-days" value="${data.days || 30}" min="1" style="width:86px"> dias
      </div>
      <div class="plan-extra">
        <input class="p-url" type="url" placeholder="Entregável (após pagamento) — https://..." value="${data.url || ''}">
        <button class="btn primary btnSavePlan">Salvar</button>
      </div>
      <div class="plan-actions">
        <button class="btn ghost btnEditPlan">Editar</button>
        <button class="btn ghost btnDelPlan">Excluir</button>
      </div>
    `;
    plansList.appendChild(wrapper);
  }

  btnAddPlan?.addEventListener('click', () => addPlanCard());

  plansList?.addEventListener('click', (e) => {
    const item = e.target.closest('.plan-item');
    if(!item) return;

    if(e.target.classList.contains('btnDelPlan')) {
      item.remove();
    }
    if(e.target.classList.contains('btnEditPlan')) {
      const name = prompt('Nome do plano:', item.querySelector('.plan-name').textContent.trim());
      if(name) item.querySelector('.plan-name').textContent = name;
    }
    if(e.target.classList.contains('btnSavePlan')) {
      // placeholder — aqui você persistiria via fetch
      e.target.textContent = 'Salvo ✓';
      setTimeout(()=> e.target.textContent = 'Salvar', 900);
    }
  });

  // Seed mínimo para demonstrar proporção (remova se já vier do backend)
  if(!plansList.children.length){
    addPlanCard({ id: '5129', name: 'MENSAL', price: 'R$ 11,90', days: 30 });
    addPlanCard({ id: '5130', name: 'MENSAL +BANIDOS', price: 'R$ 15,90', days: 30 });
    addPlanCard({ id: '5131', name: 'VITALÍCIO +15 GRUPOS', price: 'R$ 18,90', days: 99999999 });
  }

  // ====== Salvar FRONT (placeholder – mesmo comportamento visual da Flexion) ======
  document.getElementById('btnSaveFront')?.addEventListener('click', () => {
    // Validações mínimas sem poluir a UI
    const copy = document.getElementById('frontCopy').value.trim();
    if(!copy) { alert('Preencha a mensagem principal.'); return; }

    const btn = document.getElementById('btnSaveFront');
    btn.disabled = true; const t = btn.textContent;
    btn.textContent = 'Salvo ✓';
    setTimeout(() => { btn.disabled = false; btn.textContent = t; }, 900);
  });

  // Redirect (placeholder)
  document.getElementById('btnCreateRedirect')?.addEventListener('click', () => {
    alert('Redirect: tela/flow será aberto em Tracking depois.');
  });
</script>
