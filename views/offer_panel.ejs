<%- include('partials/visual_hottrack') %>

<div class="tf-wrap">
  <!-- Header -->
  <div class="tf-head">
    <div>
      <h1>Gerenciar Mensagens & Funis</h1>
      <div class="tf-breadcrumb muted">Minhas Ofertas &rsaquo; <span class="gold"><%= offer.name %></span></div>
    </div>
    <a class="btn ghost" href="/ofertas">Voltar</a>
  </div>

  <!-- Abas SUPERIORES (sempre visíveis) -->
  <nav class="tf-tabs" role="tablist" aria-label="Categorias">
    <button class="tab is-active" data-tab="principal">Principal</button>
    <button class="tab" data-tab="tracking">Tracking</button>
    <button class="tab" data-tab="cloaker">Cloaker</button>
  </nav>

  <!-- ============================ PRINCIPAL ============================ -->
  <section class="tab-panel" id="principal" aria-labelledby="Principal" role="tabpanel">
    <!-- Abas internas (sempre visíveis) -->
    <nav class="tf-subtabs" role="tablist" aria-label="Seções da oferta">
      <button class="subtab is-active" data-subtab="front">Front</button>
      <button class="subtab" data-subtab="bump" disabled>OrderBump (em breve)</button>
      <button class="subtab" data-subtab="upsell" disabled>Upsell (em breve)</button>
      <button class="subtab" data-subtab="downsell" disabled>Downsell (em breve)</button>
      <button class="subtab" data-subtab="follow" disabled>Disparo (em breve)</button>
      <button class="subtab" data-subtab="pix">Mensagem Pix</button>
    </nav>

    <!-- ====== GRID 2 COLUNAS (Flexion) ====== -->
    <div class="tf-grid">
      <!-- COLUNA ESQUERDA — CARD ÚNICO (FRONT) -->
      <section class="tf-left">
        <article class="card card-lg subpanel" id="sub-front" role="region">
          <header class="card-header">
            <h3 class="card-title">Mensagem Principal (/start)</h3>
            <p class="muted s">Texto inicial que o usuário recebe. Se o CTA estiver ativo, um botão é exibido ao final.</p>
          </header>

          <!-- Copy -->
          <div class="field">
            <label>Conteúdo da mensagem</label>
            <textarea id="frontCopy" placeholder="Escreva a mensagem de boas-vindas…"></textarea>
          </div>

          <!-- Mídias -->
          <div class="row media-row">
            <div class="field grow">
              <label>Mídias atuais</label>
              <ul id="mediaList" class="media-list"><!-- preenchido via JS --></ul>
            </div>
            <button class="btn ghost" id="btnAddMedia" type="button">Inserir mídia (Telegram)</button>
          </div>

          <hr class="sep">

          <!-- CTA -->
          <div class="cta-head">
            <h4>Botão de Ação (CTA)</h4>
            <label class="switch">
              <input id="ctaOn" type="checkbox">
              <span></span>
            </label>
          </div>

          <div class="field">
            <label>Texto da Chamada (opcional)</label>
            <input id="ctaHeadline" type="text" placeholder="Ex.: Garanta sua vaga agora mesmo.">
          </div>

          <div class="field">
            <label>Texto do Botão</label>
            <input id="ctaText" type="text" placeholder="QUERO MINHA VAGA">
          </div>

          <div class="actions">
            <button class="btn primary" id="btnSaveFront" type="button">Salvar alterações</button>
          </div>
        </article>

        <!-- COLUNA ESQUERDA — CARD ÚNICO (MENSAGEM PIX) -->
        <article class="card card-lg subpanel is-hidden" id="sub-pix" role="region" aria-hidden="true">
          <header class="card-header">
            <h3 class="card-title">Mensagem do Pix</h3>
            <p class="muted s">Mensagem enviada na etapa de pagamento. Suporta variáveis: <code>[[pix]]</code>, <code>[[valor]]</code>, <code>[[nome]]</code>.</p>
          </header>

          <div class="field">
            <label>Mensagem do Pix</label>
            <textarea id="pixCopy" placeholder="Ex.: Para concluir o pagamento, use o código [[pix]] (valor [[valor]])."></textarea>
          </div>

          <div class="row media-row">
            <div class="field grow">
              <label>Mídias atuais</label>
              <ul id="pixMediaList" class="media-list"></ul>
            </div>
            <button class="btn ghost" id="btnAddPixMedia" type="button">Inserir mídia (Telegram)</button>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnSavePix" type="button">Salvar alterações</button>
          </div>
        </article>

        <!-- Subpainéis “em breve” (placeholders elegantes) -->
        <article class="card card-lg subpanel is-hidden" id="sub-bump" role="region" aria-hidden="true">
          <header class="card-header">
            <h3 class="card-title">OrderBump</h3>
            <p class="muted s">Disponível em breve. Estrutura minimalista no padrão TigerFy.</p>
          </header>
        </article>

        <article class="card card-lg subpanel is-hidden" id="sub-upsell" role="region" aria-hidden="true">
          <header class="card-header">
            <h3 class="card-title">Upsell</h3>
            <p class="muted s">Disponível em breve.</p>
          </header>
        </article>

        <article class="card card-lg subpanel is-hidden" id="sub-downsell" role="region" aria-hidden="true">
          <header class="card-header">
            <h3 class="card-title">Downsell</h3>
            <p class="muted s">Disponível em breve.</p>
          </header>
        </article>

        <article class="card card-lg subpanel is-hidden" id="sub-follow" role="region" aria-hidden="true">
          <header class="card-header">
            <h3 class="card-title">Disparo / Follow-up</h3>
            <p class="muted s">Disponível em breve.</p>
          </header>
        </article>
      </section>

      <!-- COLUNA DIREITA — PLANOS & BOTÕES -->
      <aside class="tf-right">
        <article class="card">
          <div class="card-header row-between">
            <h3 class="card-title">Planos & Botões</h3>
            <div class="row gap8">
              <button class="btn ghost" id="btnCreateRedirect" type="button">Criar Redirect</button>
              <button class="btn primary" id="btnAddPlan" type="button">+ Criar Plano</button>
            </div>
          </div>

          <div id="plansList" class="plans-list"><!-- mini-cards via JS --></div>
        </article>
      </aside>
    </div>
  </section>

  <!-- ============================ TRACKING ============================ -->
  <section class="tab-panel is-hidden" id="tracking" role="tabpanel" aria-hidden="true">
    <div class="tf-single">
      <article class="card card-lg">
        <header class="card-header">
          <h3 class="card-title">Tracking</h3>
          <p class="muted s">Selecione o método de rastreamento. Campos aparecem somente quando necessário.</p>
        </header>

        <div class="field">
          <label>Método</label>
          <div class="radios">
            <label class="radio"><input type="radio" name="trk" value="fb"> <span></span> Facebook Pixel</label>
            <label class="radio"><input type="radio" name="trk" value="utm_fb"> <span></span> UTMify + Facebook Pixel</label>
            <label class="radio"><input type="radio" name="trk" value="utm_utm"> <span></span> UTMify + UTMify Pixel</label>
          </div>
        </div>

        <div class="grid-2">
          <div class="field trk trk-fb is-hidden">
            <label>Facebook Pixel ID</label>
            <input type="text" placeholder="ex.: 1234567890">
          </div>
          <div class="field trk trk-utm is-hidden">
            <label>UTMify Token</label>
            <input type="text" placeholder="ex.: utm_xxxxxxxxx">
          </div>
          <div class="field trk trk-utm is-hidden">
            <label>UTMify Pixel ID</label>
            <input type="text" placeholder="ex.: utm_pixel_abc">
          </div>
        </div>

        <hr class="sep">

        <header class="card-header">
          <h4 class="card-title">Redirecionador (Bots)</h4>
          <p class="muted s">Cadastre quantos bots quiser. Ative até 2 simultaneamente.</p>
        </header>

        <div class="redir-actions">
          <button class="btn primary" id="btnAddBot" type="button">+ Cadastrar Bot</button>
        </div>

        <div id="botsList" class="mini-list"><!-- mini-cards via JS --></div>

        <div class="actions">
          <button class="btn primary" type="button" id="btnSaveTracking">Salvar Tracking</button>
        </div>
      </article>
    </div>
  </section>

  <!-- ============================ CLOAKER ============================ -->
  <section class="tab-panel is-hidden" id="cloaker" role="tabpanel" aria-hidden="true">
    <div class="tf-single">
      <article class="card card-lg">
        <header class="card-header row-between">
          <div>
            <h3 class="card-title">Cloaker Anti-Clone</h3>
            <p class="muted s">Impeça clonagem automática adicionando caracteres aleatórios quando houver cópia das mensagens.</p>
          </div>
          <label class="switch">
            <input id="cloakerOn" type="checkbox">
            <span></span>
          </label>
        </header>
        <div class="actions">
          <button class="btn primary" type="button" id="btnSaveCloaker">Salvar</button>
        </div>
      </article>
    </div>
  </section>
</div>

<!-- ============================ ESTILO ============================ -->
<style>
  :root{
    --bg:#0a0a0a; --panel:#0f0f10; --line:rgba(255,255,255,.10);
    --text:#f1f1f1; --muted:#a7a7a7; --gold:#f0d47a; --gold2:#c8ac62;
    --ring:rgba(240,212,122,.22); --shadow:0 22px 60px rgba(0,0,0,.55);
  }
  .tf-wrap{max-width:1180px;margin:0 auto;padding:42px 18px 80px;color:var(--text)}
  .tf-head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:18px}
  .tf-head h1{margin:0 0 4px;font-size:1.9rem;color:#f6eac2}
  .tf-breadcrumb{font-size:.92rem}
  .gold{color:#f6eac2} .muted{color:var(--muted)} .muted.s{font-size:.92rem}

  /* Tabs */
  .tf-tabs,.tf-subtabs{display:flex;gap:8px;margin:6px 0 16px}
  .tab,.subtab{
    border:1px solid var(--line); background:rgba(255,255,255,.03);
    color:#ddd; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:.95rem
  }
  .tab.is-active,.subtab.is-active{border-color:rgba(255,255,255,.18); color:#12100b; background:linear-gradient(90deg,var(--gold),var(--gold2))}
  .tab[disabled],.subtab[disabled]{opacity:.45; cursor:not-allowed}

  /* Grid 2 cols */
  .tf-grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media(max-width:1060px){.tf-grid{grid-template-columns:1fr}}

  /* Cards */
  .card{
    background:var(--panel);
    border:1px solid var(--line); border-radius:16px; padding:16px;
    box-shadow:var(--shadow);
  }
  .card-lg{padding:18px 16px 16px}
  .card-header{margin-bottom:12px}
  .card-title{margin:0 0 2px;font-size:1.06rem;color:#f6eac2}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  .row{display:flex;align-items:center} .gap8{gap:8px}

  /* Fields */
  .field{margin-bottom:10px}
  .field label{display:block;margin:0 0 6px 2px;font-size:.88rem;color:#e9e9e9}
  .field input,.field textarea{
    width:100%;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);
    color:#fff;padding:10px 12px;outline:none
  }
  .field textarea{min-height:160px;resize:vertical}
  .field input:focus,.field textarea:focus{border-color:var(--gold);box-shadow:0 0 0 2px var(--ring)}

  /* Media list */
  .media-row{gap:12px}
  .grow{flex:1}
  .media-list{display:flex;flex-direction:column;gap:8px;margin:0;padding:0;list-style:none}
  .media-item{display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
  .media-item a{color:#ddd;text-decoration:none}

  .sep{border:0;border-top:1px solid var(--line);margin:14px 0}
  .cta-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h4{margin:0;color:#f6eac2;font-size:1rem}

  /* Buttons */
  .btn{border:1px solid var(--line);background:transparent;color:#eaeaea;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.2)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.14)}
  .btn.primary{border:none;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#141008;font-weight:700}
  .actions{display:flex;justify-content:flex-end;margin-top:12px}

  /* Switch */
  .switch{position:relative;display:inline-block;width:46px;height:26px}
  .switch input{display:none}
  .switch span{position:absolute;inset:0;background:#262626;border:1px solid var(--line);border-radius:999px;transition:.2s}
  .switch span:after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#cfcfcf;border-radius:50%;transition:.2s}
  .switch input:checked+span{background:var(--gold)}
  .switch input:checked+span:after{left:23px;background:#1a1300}

  /* Plans (right column) */
  .plans-list{display:flex;flex-direction:column;gap:10px}
  .plan-item{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);padding:10px}
  .plan-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .plan-name{font-weight:600}
  .plan-id{color:#bdbdbd;font-size:.86rem}
  .plan-meta{color:#d5d5d5;font-size:.9rem;margin-bottom:8px}
  .plan-extra{display:grid;grid-template-columns:1fr 110px;gap:8px;align-items:center;margin-bottom:8px}
  .plan-actions{display:flex;gap:8px;justify-content:flex-end}
  .plan-actions .btn{padding:8px 10px;border-radius:10px}

  /* Tracking */
  .tf-single{max-width:920px;margin:0 auto}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:860px){.grid-2{grid-template-columns:1fr}}
  .radios{display:flex;gap:14px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:8px}
  .radio input{accent-color:#b49b4a}
  .trk.is-hidden{display:none}
  .redir-actions{display:flex;justify-content:flex-end;margin-bottom:10px}

  /* Mini list (bots) */
  .mini-list{display:flex;flex-direction:column;gap:10px}
  .mini-item{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px;padding:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
  .mini-item .switch{margin:auto}
  .mini-item .btn{padding:8px 10px;border-radius:10px}

  /* Tab visibility */
  .tab-panel.is-hidden,.subpanel.is-hidden{display:none}
</style>

<!-- ============================ SCRIPT ============================ -->
<script>
  // ------- Tabs superiores -------
  const topTabs = document.querySelectorAll('.tf-tabs .tab');
  const panels = document.querySelectorAll('.tab-panel');
  topTabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      topTabs.forEach(b=>b.classList.remove('is-active'));
      panels.forEach(p=>p.classList.add('is-hidden'));
      btn.classList.add('is-active');
      document.getElementById(btn.dataset.tab).classList.remove('is-hidden');
    })
  });

  // ------- Subtabs (Principal) -------
  const subTabs = document.querySelectorAll('.tf-subtabs .subtab');
  const subPanels = document.querySelectorAll('.subpanel');
  subTabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      if(btn.disabled) return;
      subTabs.forEach(b=>b.classList.remove('is-active'));
      subPanels.forEach(p=>p.classList.add('is-hidden'));
      btn.classList.add('is-active');
      document.getElementById('sub-'+btn.dataset.subtab).classList.remove('is-hidden');
    })
  });

  // ------- Mídias (Front/Pix) -------
  function wireMedia(btnId, listId){
    const addBtn = document.getElementById(btnId);
    const list = document.getElementById(listId);
    addBtn?.addEventListener('click', ()=>{
      const url = prompt('Cole o link público da mídia do Telegram:');
      if(!url) return;
      const li = document.createElement('li');
      li.className = 'media-item';
      li.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${url}</a>
                      <button class="btn ghost btnDel">Excluir</button>`;
      list.appendChild(li);
    });
    list?.addEventListener('click', e=>{
      if(e.target.classList.contains('btnDel')) e.target.closest('.media-item')?.remove();
    });
  }
  wireMedia('btnAddMedia','mediaList');
  wireMedia('btnAddPixMedia','pixMediaList');

  // ------- Planos (mini cards da direita) -------
  const plansList = document.getElementById('plansList');
  document.getElementById('btnAddPlan')?.addEventListener('click', ()=> addPlanCard());

  function addPlanCard(data={}){
    const id = data.id || ('novo-'+Math.random().toString(36).slice(2,8));
    const el = document.createElement('div');
    el.className='plan-item';
    el.innerHTML = `
      <div class="plan-h">
        <div class="plan-name">${data.name || 'NOVO PLANO'}</div>
        <div class="plan-id">ID: ${id}</div>
      </div>
      <div class="plan-meta">
        Valor: <input class="p-price" type="text" value="${data.price||''}" placeholder="R$"> ·
        Duração: <input class="p-days" type="number" min="1" value="${data.days||30}" style="width:86px"> dias
      </div>
      <div class="plan-extra">
        <input class="p-url" type="url" placeholder="Entregável (após pagamento) — https://..." value="${data.url||''}">
        <button class="btn primary btnSavePlan" type="button">Salvar</button>
      </div>
      <div class="plan-actions">
        <button class="btn ghost btnEditPlan" type="button">Editar</button>
        <button class="btn ghost btnDelPlan" type="button">Excluir</button>
      </div>`;
    plansList.appendChild(el);
  }
  plansList?.addEventListener('click', e=>{
    const item = e.target.closest('.plan-item'); if(!item) return;
    if(e.target.classList.contains('btnDelPlan')) item.remove();
    if(e.target.classList.contains('btnEditPlan')){
      const name = prompt('Nome do plano:', item.querySelector('.plan-name').textContent.trim());
      if(name) item.querySelector('.plan-name').textContent = name;
    }
    if(e.target.classList.contains('btnSavePlan')){
      e.target.textContent='Salvo ✓';
      setTimeout(()=> e.target.textContent='Salvar', 900);
    }
  });
  // Mock inicial (apague se vier do backend)
  if(!plansList.children.length){
    addPlanCard({ id:'5129', name:'MENSAL', price:'R$ 11,90', days:30 });
    addPlanCard({ id:'5130', name:'MENSAL +BANIDOS', price:'R$ 15,90', days:30 });
    addPlanCard({ id:'5131', name:'VITALÍCIO +15 GRUPOS', price:'R$ 18,90', days:99999999 });
  }

  // ------- Tracking: radios revelam campos -------
  const radios = document.querySelectorAll('input[name="trk"]');
  const trkFb = document.querySelectorAll('.trk-fb');
  const trkUtm = document.querySelectorAll('.trk-utm');
  function toggleTrk(v){
    trkFb.forEach(x=>x.classList.toggle('is-hidden', v!=='fb' && v!=='utm_fb'));
    trkUtm.forEach(x=>x.classList.toggle('is-hidden', v==='fb'));
  }
  radios.forEach(r=>r.addEventListener('change', e=>toggleTrk(e.target.value)));

  // ------- Redirecionador (bots) -------
  const botsList = document.getElementById('botsList');
  document.getElementById('btnAddBot')?.addEventListener('click', ()=> addBotCard());
  function addBotCard(data={}){
    const wrap = document.createElement('div');
    wrap.className='mini-item';
    wrap.innerHTML = `
      <input class="b-user" type="text" placeholder="username do bot (sem @)" value="${data.username||''}">
      <input class="b-token" type="text" placeholder="token do bot" value="${data.token||''}">
      <label class="switch"><input type="checkbox" ${data.active?'checked':''}><span></span></label>
      <button class="btn ghost btnDelBot" type="button">Excluir</button>`;
    botsList.appendChild(wrap);
  }
  botsList?.addEventListener('click', e=>{
    if(e.target.classList.contains('btnDelBot')) e.target.closest('.mini-item')?.remove();
  });

  // ------- Botões “Salvar” (placeholders visuais) -------
  function flash(btn){
    btn.disabled=true; const t=btn.textContent; btn.textContent='Salvo ✓';
    setTimeout(()=>{btn.disabled=false; btn.textContent=t}, 900);
  }
  document.getElementById('btnSaveFront')?.addEventListener('click', e=>flash(e.target));
  document.getElementById('btnSavePix')?.addEventListener('click', e=>flash(e.target));
  document.getElementById('btnSaveTracking')?.addEventListener('click', e=>flash(e.target));
  document.getElementById('btnSaveCloaker')?.addEventListener('click', e=>flash(e.target));
</script>
