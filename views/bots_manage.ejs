<%- include('partials/visual_hottrack') %>

<div class="tiger-manage">
  <div class="manage-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Gerencie bots, tokens e traqueamento de forma simples e organizada.</p>
    </div>
    <a href="/bots/create" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="manage-layout">
    <!-- LISTA DE OFERTAS -->
    <div class="offer-list">
      <% if (!offers || offers.length === 0) { %>
        <div class="empty-state">
          <h3>Nenhuma oferta criada ainda.</h3>
          <p>Crie sua primeira oferta e conecte um bot Telegram em poucos segundos.</p>
          <a href="/bots/create" class="btn-primary small">Criar oferta</a>
        </div>
      <% } else { %>
        <% offers.forEach(function(offer){ %>
          <a
            href="/bots/manage?id=<%= offer._id %>"
            class="offer-row <%= selectedOffer && String(selectedOffer._id) === String(offer._id) ? 'active' : '' %>"
          >
            <div class="offer-row-main">
              <h3><%= offer.name %></h3>
              <span class="offer-id">ID: <%= offer._id.toString().slice(-6) %></span>
            </div>

            <div class="offer-row-tags">
              <span class="tag">
                <% if (offer.botType === 'bot_padrao') { %>
                  Bot padrão
                <% } else if (offer.botType === 'bot_fluxo_wiin') { %>
                  Bot fluxo (Wiinbot)
                <% } else { %>
                  Bot fluxo (Manychat)
                <% } %>
              </span>

              <span class="tag">
                <% if (offer.trackingType === 'fb_pixel') { %>
                  Facebook Pixel nativo
                <% } else if (offer.trackingType === 'utmify_utmify_pixel') { %>
                  UTMify + UTMify Pixel
                <% } else if (offer.trackingType === 'utmify_fb_pixel') { %>
                  UTMify + Pixel FB
                <% } else { %>
                  Track próprio
                <% } %>
              </span>

              <span class="status <%= offer.status %>">
                <% if (offer.status === 'ativo') { %>Ativo<% } %>
                <% if (offer.status === 'incompleto') { %>Incompleto<% } %>
                <% if (offer.status === 'erro') { %>Erro<% } %>
              </span>
            </div>

            <span class="chevron">›</span>
          </a>
        <% }) %>
      <% } %>
    </div>

    <!-- PAINEL DA OFERTA SELECIONADA -->
    <div class="offer-detail">
      <% if (!selectedOffer) { %>
        <div class="detail-empty">
          <h2>Selecione uma oferta</h2>
          <p>Escolha uma oferta na coluna da esquerda para conectar um bot e configurar a automação.</p>
        </div>
      <% } else { %>
        <div class="detail-header">
          <div>
            <h2><%= selectedOffer.name %></h2>
            <p>ID: <%= selectedOffer._id %></p>
          </div>
          <span class="status <%= selectedOffer.status %> big">
            <% if (selectedOffer.status === 'ativo') { %>Bot conectado<% } %>
            <% if (selectedOffer.status === 'incompleto') { %>Bot não conectado<% } %>
            <% if (selectedOffer.status === 'erro') { %>Erro no bot<% } %>
          </span>
        </div>

        <!-- Card principal: token do bot -->
        <div class="detail-card">
          <h3>Bot Telegram dessa oferta</h3>
          <p class="card-helper">
            Conecte o bot que será usado para automatizar toda a jornada dessa oferta.
          </p>

          <form action="/bots/<%= selectedOffer._id %>/token" method="POST" class="bot-form">
            <div class="field-group">
              <label for="telegramUsername">Username do Bot</label>
              <input
                type="text"
                id="telegramUsername"
                name="telegramUsername"
                placeholder="@seubot_exemplo_bot"
                value="<%= selectedOffer.telegramUsername || '' %>"
              />
            </div>

            <div class="field-group">
              <label for="botToken">Token do Bot <span>*</span></label>
              <input
                type="text"
                id="botToken"
                name="botToken"
                placeholder="Ex: 123456789:AAEJx2m9JQb8___________"
                value="<%= selectedOffer.botToken || '' %>"
                required
              />
              <p class="small-helper">
                Você encontra esse token falando com o <b>@BotFather</b> no Telegram.
              </p>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">Salvar e conectar bot</button>
            </div>
          </form>
        </div>

        <!-- Cards extras minimalistas -->
        <div class="detail-grid">
          <div class="mini-card">
            <h4>Tipo de Bot</h4>
            <p>
              <% if (selectedOffer.botType === 'bot_padrao') { %>
                Bot padrão — fluxo clássico.
              <% } else if (selectedOffer.botType === 'bot_fluxo_wiin') { %>
                Bot fluxo estilo antiga Wiinbot (em breve).
              <% } else { %>
                Bot fluxo estilo Manychat (em breve).
              <% } %>
            </p>
          </div>

          <div class="mini-card">
            <h4>Traqueamento</h4>
            <p>
              <% if (selectedOffer.trackingType === 'fb_pixel') { %>
                Facebook Pixel nativo.
              <% } else if (selectedOffer.trackingType === 'utmify_utmify_pixel') { %>
                UTMify + UTMify Pixel.
              <% } else if (selectedOffer.trackingType === 'utmify_fb_pixel') { %>
                UTMify + Pixel Facebook.
              <% } else { %>
                Track próprio configurado manualmente.
              <% } %>
            </p>
          </div>

          <div class="mini-card">
            <h4>Status</h4>
            <p>
              <% if (selectedOffer.status === 'ativo') { %>
                Bot conectado e pronto para rodar as automações.
              <% } else if (selectedOffer.status === 'incompleto') { %>
                Conecte um token de bot para ativar essa oferta.
              <% } else { %>
                Verifique o token ou as permissões do bot.
              <% } %>
            </p>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<style>
  .tiger-manage{
    padding:60px 80px 100px 130px;
    transform:scale(0.9) translateX(-38px);
    transform-origin:top center;
    max-width:calc(100vw - 120px);
    margin:0 auto;
    color:#fff;
  }

  .manage-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:24px;
  }
  .manage-header h1{
    margin:0 0 6px;
    font-size:2rem;
    color:#ffcc00;
  }
  .manage-header p{
    margin:0;
    color:#b4b4b4;
    font-size:.95rem;
  }

  .manage-layout{
    display:grid;
    grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
    gap:22px;
  }

  .offer-list{
    background:rgba(0,0,0,0.7);
    border-radius:18px;
    padding:14px 10px;
    border:1px solid rgba(255,204,0,0.12);
    max-height:70vh;
    overflow-y:auto;
  }

  .offer-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:10px 10px;
    border-radius:12px;
    text-decoration:none;
    color:#fff;
    margin-bottom:6px;
    background:rgba(255,255,255,0.02);
    border:1px solid transparent;
    transition:.2s;
  }
  .offer-row:hover{
    border-color:rgba(255,204,0,0.3);
    background:rgba(255,255,255,0.05);
  }
  .offer-row.active{
    border-color:#ffcc00;
    background:radial-gradient(circle at top left,#fff4b0,#ffcc00 45%,#8a5a16 100%);
    color:#1a1300;
    box-shadow:0 0 16px rgba(255,204,0,0.4);
  }
  .offer-row-main h3{
    margin:0;
    font-size:.95rem;
  }
  .offer-row-main .offer-id{
    font-size:.75rem;
    color:#999;
  }
  .offer-row.active .offer-id{
    color:#453400;
  }

  .offer-row-tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
    justify-content:flex-end;
    flex:1;
  }
  .tag{
    font-size:.75rem;
    padding:3px 7px;
    border-radius:999px;
    background:rgba(255,255,255,0.07);
  }
  .offer-row.active .tag{
    background:rgba(0,0,0,0.08);
  }
  .status{
    font-size:.75rem;
    padding:3px 7px;
    border-radius:999px;
  }
  .status.ativo{
    background:rgba(0,255,120,0.16);
    color:#4fff9a;
  }
  .status.incompleto{
    background:rgba(255,196,0,0.16);
    color:#ffdd66;
  }
  .status.erro{
    background:rgba(255,0,76,0.16);
    color:#ff6b9e;
  }
  .status.big{
    font-size:.8rem;
  }
  .chevron{
    font-size:1.4rem;
    opacity:.5;
  }

  .empty-state{
    text-align:center;
    padding:30px 16px;
  }
  .empty-state h3{
    margin:0 0 8px;
  }
  .empty-state p{
    margin:0 0 14px;
    color:#b4b4b4;
    font-size:.9rem;
  }
  .btn-primary.small{
    padding:8px 16px;
    font-size:.85rem;
  }

  .offer-detail{
    background:rgba(0,0,0,0.7);
    border-radius:18px;
    padding:18px 18px 20px;
    border:1px solid rgba(255,204,0,0.12);
    min-height:320px;
  }

  .detail-empty{
    text-align:center;
    padding:40px 16px;
  }
  .detail-empty h2{
    margin:0 0 8px;
  }
  .detail-empty p{
    margin:0;
    color:#b4b4b4;
    font-size:.9rem;
  }

  .detail-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:18px;
  }
  .detail-header h2{
    margin:0 0 4px;
    font-size:1.25rem;
  }
  .detail-header p{
    margin:0;
    font-size:.8rem;
    color:#8f8f8f;
  }

  .detail-card{
    background:rgba(255,255,255,0.03);
    border-radius:14px;
    padding:16px 14px 14px;
    margin-bottom:16px;
  }
  .detail-card h3{
    margin:0 0 6px;
    font-size:1rem;
  }
  .card-helper{
    margin:0 0 10px;
    font-size:.85rem;
    color:#b4b4b4;
  }

  .bot-form .field-group{
    margin-bottom:14px;
  }
  .bot-form label{
    display:block;
    font-size:.85rem;
    margin-bottom:5px;
  }
  .bot-form label span{
    color:#ffcc00;
  }
  .bot-form input{
    width:100%;
    padding:9px 10px;
    border-radius:9px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.16);
    color:#fff;
    font-size:.9rem;
  }
  .bot-form input:focus{
    outline:none;
    border-color:#ffcc00;
    box-shadow:0 0 0 1px rgba(255,204,0,0.2);
  }
  .bot-form .small-helper{
    margin:4px 0 0;
    font-size:.78rem;
    color:#9a9a9a;
  }

  .detail-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
  }
  .mini-card{
    background:rgba(255,255,255,0.03);
    border-radius:12px;
    padding:10px 11px;
  }
  .mini-card h4{
    margin:0 0 4px;
    font-size:.85rem;
    color:#ffcc00;
  }
  .mini-card p{
    margin:0;
    font-size:.8rem;
    color:#c0c0c0;
  }

  .btn-primary{
    border:none;
    border-radius:10px;
    padding:10px 20px;
    font-weight:600;
    cursor:pointer;
    text-decoration:none;
    background:linear-gradient(90deg,#ffcc00,#d4a100);
    color:#1a1300;
    box-shadow:0 0 12px rgba(255,204,0,0.4);
    font-size:.9rem;
  }
</style>
