<%- include('partials/visual_hottrack') %>

<div class="tiger-offers-list">
  <div class="list-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Lista simples e objetiva das suas ofertas. Clique para abrir o painel premium da oferta.</p>
    </div>
    <a href="/ofertas/criar" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="list-grid" id="offersGrid">
    <% if (!offers || offers.length === 0) { %>
      <div class="empty">
        <h3>Você ainda não tem ofertas</h3>
        <p>Crie sua primeira oferta para começar.</p>
        <a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>
      </div>
    <% } else { %>
      <% offers.forEach(function(o){ const botsCount = (o.botsCount ?? 0); %>
        <a
          class="offer-card"
          href="/ofertas/painel/<%= o._id %>"
          id="offer-card-<%= o._id %>"
          data-offer-id="<%= o._id %>"
          data-offer-name="<%= o.name %>"
          data-bot-type="<%= o.botType %>"
          data-tracking-type="<%= o.trackingType %>"
          data-bots-count="<%= botsCount %>"
        >
          <div class="card-top">
            <h3 class="offer-name" data-offer-id="<%= o._id %>"><%= o.name %></h3>
            <span class="status <%= o.status %>">
              <% if (o.status === 'ativo') { %>Ativo<% } %>
              <% if (o.status === 'incompleto') { %>Incompleto<% } %>
              <% if (o.status === 'erro') { %>Erro<% } %>
            </span>
          </div>

          <div class="meta">
            <span>ID: <%= String(o._id).slice(-6) %></span>
            <span> | </span>
            <span>Bots: <%= botsCount %></span>
            <span> | </span>
            <span>Tipo:
              <% if (o.botType === 'bot_padrao') { %>Padrão<% }
                 else if (o.botType === 'bot_fluxo_wiin') { %>Fluxo<% }
                 else { %>Fluxo<% } %>
            </span>

            <!-- Botão de ações (…) — inline, sem quebrar layout -->
            <button
              type="button"
              class="offer-actions-inline"
              title="Gerenciar oferta"
              aria-label="Gerenciar oferta"
              data-id="<%= o._id %>"
              data-name="<%= o.name %>"
              data-bots="<%= botsCount %>"
              data-bottype="<%= o.botType %>"
              data-tracktype="<%= o.trackingType %>"
              onclick="event.preventDefault(); event.stopPropagation(); openManageOfferModal(this);"
            >
              <span class="dots">•••</span>
            </button>
          </div>

          <span class="go">›</span>
        </a>
      <% }) %>
    <% } %>
  </div>
</div>

<!-- ===== Toasts TigerFy (discretos) ===== -->
<div id="tf-toasts" class="tf-toasts"></div>

<!-- ===== Modal: Gerenciar Oferta ===== -->
<div class="modal-gerenciar-oferta" id="manageOfferModal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeManageOfferModal()"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="manageOfferTitle">
    <div class="modal-header">
      <h3 id="manageOfferTitle">Gerenciar Oferta</h3>
      <button class="modal-close" type="button" aria-label="Fechar" onclick="closeManageOfferModal()">
        <span>×</span>
      </button>
    </div>

    <div class="modal-body">
      <!-- Resumo -->
      <section class="modal-section">
        <h4>Resumo da Oferta</h4>
        <div class="resume-lines">
          <div><strong>Nome atual:</strong> <span id="resumeName">—</span></div>
          <div><strong>ID:</strong> <span id="resumeId">—</span></div>
          <div><strong>Quantidade de bots vinculados:</strong> <span id="resumeBots">0</span></div>
          <div><strong>Tipo de Bot:</strong> <span id="resumeBotType">—</span></div>
        </div>
      </section>

      <!-- Renomear -->
      <section class="modal-section">
        <h4>Renomear Oferta</h4>
        <label for="newOfferName" class="label">Novo nome da oferta</label>
        <input id="newOfferName" type="text" class="input" placeholder="Ex: Mundo VIP 2.0, Oferta Principal, etc..." />
        <div class="actions-row">
          <button class="btn-primary" type="button" onclick="submitRename()">Salvar novo nome</button>
          <small id="renameError" class="error-msg" style="display:none;"></small>
        </div>
      </section>

      <!-- Duplicar -->
      <section class="modal-section">
        <h4>Duplicar Oferta</h4>
        <p class="muted">Crie uma cópia desta oferta com um novo ID, preservando configurações principais.</p>
        <button class="btn-primary" type="button" onclick="submitDuplicate()">Duplicar oferta</button>
        <small id="duplicateError" class="error-msg" style="display:none;"></small>
      </section>

      <!-- Excluir -->
      <section class="modal-section danger-zone">
        <h4>Excluir Oferta</h4>
        <p class="warning">Cuidado: esta ação é permanente.</p>
        <button class="btn-danger" type="button" onclick="submitDelete()">Excluir oferta</button>
        <small id="deleteError" class="error-msg" style="display:none;"></small>
      </section>
    </div>
  </div>
</div>

<style>
  .tiger-offers-list{
    padding:60px 80px 100px 130px;
    max-width:calc(100vw - 120px);
    margin:0 auto;
    color:#fff;
  }
  .list-header{
    display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;
  }
  .list-header h1{ margin:0 0 6px; font-size:2rem; color:#ffcc00; }
  .list-header p{ margin:0; color:#b4b4b4; font-size:.95rem; }

  .list-grid{
    display:grid; gap:12px;
    grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  }
  .offer-card{
    position:relative;
    display:block; text-decoration:none; color:#fff;
    background:rgba(0,0,0,0.70);
    border:1px solid rgba(255,204,0,0.12);
    border-radius:16px; padding:14px;
    transition:.2s;
  }
  .offer-card:hover{ border-color:#ffcc00; box-shadow:0 0 16px rgba(255,204,0,0.3); }
  .card-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .card-top h3{ margin:0; font-size:1rem; }
  .status{ font-size:.75rem; padding:3px 7px; border-radius:999px; }
  .status.ativo{ background:rgba(0,255,120,0.16); color:#4fff9a; }
  .status.incompleto{ background:rgba(255,196,0,0.16); color:#ffdd66; }
  .status.erro{ background:rgba(255,0,76,0.16); color:#ff6b9e; }

  .meta{
    display:flex; align-items:center; gap:10px;
    flex-wrap:nowrap; white-space:nowrap;
    margin-top:8px;
    font-size:.78rem; color:#c9c9c9;
    padding-right:42px; /* reserva espaço para a seta › */
  }

  /* Setinha fixa, sem quebrar */
  .offer-card .go{
    position:absolute; right:12px; top:50%;
    transform:translateY(-50%);
    opacity:.6; font-size:1.4rem;
  }

  .empty{ text-align:center; padding:30px 16px; background:rgba(0,0,0,0.70); border:1px solid rgba(255,204,0,0.12); border-radius:16px; }
  .btn-primary.small{ padding:8px 16px; font-size:.85rem; }
  .btn-primary{
    border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer; text-decoration:none;
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#1a1300; box-shadow:0 0 12px rgba(255,204,0,0.4); font-size:.95rem;
  }

  /* --- Botão (…) inline e centralizado --- */
  .offer-actions-inline{
    margin-left:12px;
    margin-right:10px;             /* ajuste fino na borda direita */
    width:28px; height:28px;
    border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,204,0,0.08);
    border:1px solid rgba(255,204,0,0.18);
    color:#ffcc00; cursor:pointer;
    transition: box-shadow .16s ease, transform .08s ease, background .16s ease, border-color .16s ease;
    flex:0 0 auto;
  }
  .offer-actions-inline:hover{
    background:rgba(255,204,0,0.14);
    border-color:rgba(255,204,0,0.35);
    box-shadow:0 0 10px rgba(255,204,0,0.25);
  }
  .offer-actions-inline .dots{
    display:block; line-height:0;
    transform:translateY(-0.5px);  /* micro-compensação ótica */
    letter-spacing:2px; font-size:14px;
    pointer-events:none;
  }

  /* ===== Modal Gerenciar Oferta ===== */
  .modal-gerenciar-oferta{ position:fixed; inset:0; display:none; z-index:9999; }
  .modal-gerenciar-oferta[aria-hidden="false"]{ display:block; }
  .modal-backdrop{
    position:absolute; inset:0;
    backdrop-filter: blur(6px);
    background:rgba(0,0,0,0.45);
  }
  .modal-card{
    position:absolute; inset:0; margin:auto; width:min(680px, calc(100vw - 48px));
    height:auto; max-height:calc(100vh - 48px); overflow:auto;
    background:rgba(10,10,10,0.92);
    border:1px solid rgba(255,204,0,0.15);
    border-radius:18px; box-shadow:0 0 18px rgba(255,204,0,0.22);
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 16px 10px 16px; border-bottom:1px solid rgba(255,204,0,0.10);
  }
  .modal-header h3{ margin:0; color:#ffcc00; }
  .modal-close{
    width:32px; height:32px; border-radius:999px; border:1px solid rgba(255,204,0,0.25);
    background:rgba(255,204,0,0.08); color:#ffcc00; cursor:pointer;
    display:flex; align-items:center; justify-content:center; /* CENTRALIZADO */
  }
  .modal-close span{ display:block; font-size:20px; line-height:1; transform:translateY(-0.5px); }
  .modal-body{ padding:14px; display:grid; gap:16px; }
  .modal-section h4{ margin:0 0 8px; }
  .resume-lines{ color:#cfcfcf; display:grid; gap:6px; }
  .label{ display:block; font-size:.85rem; color:#c9c9c9; margin-bottom:6px; }
  .input{
    width:100%; background:#111; color:#fff; border:1px solid rgba(255,204,0,0.16);
    border-radius:10px; padding:10px 12px; outline:none;
  }
  .actions-row{ display:flex; align-items:center; gap:10px; margin-top:8px; }
  .muted{ color:#b4b4b4; margin:0 0 8px; }
  .danger-zone{ border-top:1px dashed rgba(255,0,76,0.25); padding-top:10px; }
  .warning{ color:#ff6b9e; margin:0 0 8px; }
  .btn-danger{
    background:linear-gradient(90deg,#ff3b6b,#cc2a50); color:#fff; border:none; border-radius:10px;
    padding:10px 18px; font-weight:600; cursor:pointer; box-shadow:0 0 12px rgba(255,59,107,.25);
  }
  .error-msg{ color:#ff6b9e; }

  /* ===== Toasts ===== */
  .tf-toasts{ position:fixed; top:18px; right:18px; display:grid; gap:8px; z-index:10000; }
  .tf-toast{
    background:rgba(15,15,15,.95); color:#fff; border:1px solid rgba(255,204,0,.15);
    border-radius:12px; padding:10px 12px; box-shadow:0 0 14px rgba(255,204,0,.18);
    transform:translateY(-6px); opacity:0; animation:toast-in .18s ease forwards;
  }
  .tf-toast.success{ border-color:rgba(0,255,120,.25); box-shadow:0 0 14px rgba(0,255,120,.18); }
  .tf-toast.error{ border-color:rgba(255,59,107,.35); box-shadow:0 0 14px rgba(255,59,107,.22); }
  @keyframes toast-in{ to{ transform:translateY(0); opacity:1; } }
</style>

<script>
  let CURRENT_OFFER = null;

  function qs(id){ return document.getElementById(id); }
  function toast(msg, type='success'){
    const box = document.getElementById('tf-toasts');
    const el = document.createElement('div');
    el.className = 'tf-toast ' + (type==='error' ? 'error':'success');
    el.textContent = msg;
    box.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 2200);
    setTimeout(()=>{ el.remove(); }, 2600);
  }

  function openManageOfferModal(btn){
    const id = btn.dataset.id;
    const name = btn.dataset.name || '—';
    const bots = btn.dataset.bots || '0';
    const botType = mapBotType(btn.dataset.bottype);
    CURRENT_OFFER = { id, name };

    // preenche resumo
    qs('resumeName').textContent = name;
    qs('resumeId').textContent = id;
    qs('resumeBots').textContent = bots;
    qs('resumeBotType').textContent = botType;

    // input renomear
    qs('newOfferName').value = name;
    qs('renameError').style.display='none';
    qs('duplicateError').style.display='none';
    qs('deleteError').style.display='none';

    // abre modal
    qs('manageOfferModal').setAttribute('aria-hidden', 'false');
  }
  function closeManageOfferModal(){
    qs('manageOfferModal').setAttribute('aria-hidden', 'true');
    CURRENT_OFFER = null;
  }

  function mapBotType(t){
    if(t === 'bot_padrao') return 'Padrão';
    if(t === 'bot_fluxo_wiin') return 'Fluxo';
    return 'Fluxo';
  }

  async function submitRename(){
    const err = qs('renameError');
    err.style.display='none';
    if(!CURRENT_OFFER) return;

    const novoNome = (qs('newOfferName').value || '').trim();
    if(!novoNome){ err.textContent='Informe um nome válido.'; err.style.display='inline'; return; }

    try{
      const res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/renomear`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ novoNome })
      });
      const j = await res.json();
      if(!j || j.ok !== true) throw new Error(j?.error || 'Falha ao renomear');

      // atualiza nome no card da lista
      const nameEls = document.querySelectorAll(`.offer-name[data-offer-id="${CURRENT_OFFER.id}"]`);
      nameEls.forEach(el => el.textContent = novoNome);

      toast('Oferta renomeada com sucesso.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível renomear. Tente novamente.';
      err.style.display='inline';
    }
  }

  async function submitDuplicate(){
    const err = qs('duplicateError');
    err.style.display='none';
    if(!CURRENT_OFFER) return;

    try{
      const res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/duplicar`, {
        method: 'POST'
      });
      const j = await res.json();
      if(!j || j.ok !== true || !j.offer){ throw new Error(j?.error || 'Falha ao duplicar'); }

      // inserir novo card na grade (render mínimo)
      const o = j.offer;
      const botsCount = o.botsCount ?? 0;
      const botLabel = mapBotType(o.bot_type || o.botType);

      const card = document.createElement('a');
      card.className = 'offer-card';
      card.href = `/ofertas/painel/${o.id}`;
      card.id = `offer-card-${o.id}`;
      card.dataset.offerId = o.id;
      card.dataset.offerName = o.name;
      card.dataset.botType = o.bot_type || o.botType;
      card.dataset.trackingType = o.tracking_type || o.trackingType;
      card.dataset.botsCount = botsCount;

      card.innerHTML = `
        <div class="card-top">
          <h3 class="offer-name" data-offer-id="${o.id}">${o.name}</h3>
          <span class="status ${o.status || 'incompleto'}">${(o.status==='ativo'?'Ativo':(o.status==='erro'?'Erro':'Incompleto'))}</span>
        </div>
        <div class="meta">
          <span>ID: ${String(o.id).slice(-6)}</span><span> | </span>
          <span>Bots: ${botsCount}</span><span> | </span>
          <span>Tipo: ${botLabel}</span>
          <button type="button" class="offer-actions-inline"
            title="Gerenciar oferta" aria-label="Gerenciar oferta"
            data-id="${o.id}" data-name="${o.name}" data-bots="${botsCount}"
            data-bottype="${o.bot_type || o.botType}" data-tracktype="${o.tracking_type || o.trackingType}"
            onclick="event.preventDefault(); event.stopPropagation(); openManageOfferModal(this);">
            <span class="dots">•••</span>
          </button>
        </div>
        <span class="go">›</span>
      `;

      document.getElementById('offersGrid').prepend(card);
      toast('Oferta duplicada.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível duplicar. Tente novamente.';
      err.style.display='inline';
    }
  }

  async function submitDelete(){
    const err = qs('deleteError');
    err.style.display='none';
    if(!CURRENT_OFFER) return;

    if(!confirm('Tem certeza que deseja excluir esta oferta? Esta ação é permanente.')) return;

    try{
      // tenta DELETE; se não existir, tenta POST /excluir
      let res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}`, { method:'DELETE' });
      if(res.status === 404){
        res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/excluir`, { method:'POST' });
      }
      const j = await res.json();
      if(!j || j.ok !== true){ throw new Error(j?.error || 'Falha ao excluir'); }

      // remove card da lista
      const card = document.getElementById(`offer-card-${CURRENT_OFFER.id}`);
      if(card) card.remove();

      toast('Oferta excluída.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível excluir. Tente novamente.';
      err.style.display='inline';
    }
  }
</script>
