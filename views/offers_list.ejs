<%- include('partials/visual_hottrack') %>

<div class="tiger-offers-list">
  <div class="list-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Lista simples e objetiva das suas ofertas. Clique para abrir o painel premium da oferta.</p>
    </div>
    <a href="/ofertas/criar" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="list-grid" id="offersGrid">
    <% if (!offers || offers.length === 0) { %>
      <div class="empty" id="emptyState">
        <h3>Você ainda não tem ofertas</h3>
        <p>Crie sua primeira oferta para começar.</p>
        <a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>
      </div>
    <% } else { %>
      <% offers.forEach(function(o){
           const oid = o._id || o.id;
           const idShort = String(oid).slice(0,8);
           const botCount = (typeof o.botCount === 'number') ? o.botCount
                           : (typeof o.botsCount === 'number') ? o.botsCount : 0;
           const botLabel = (o.botType === 'bot_padrao') ? 'Padrão'
                           : (o.botType && o.botType.startsWith('bot_fluxo')) ? 'Fluxo'
                           : 'Padrão';
      %>
        <a
          class="offer-card"
          href="/ofertas/painel/<%= oid %>"
          data-offer-id="<%= oid %>"
          data-offer-name="<%- o.name %>"
          data-offer-bot-count="<%= botCount %>"
          data-offer-bot-type-label="<%= botLabel %>"
        >
          <div class="card-top">
            <h3 class="offer-title"><%- o.name %></h3>
            <span class="status <%= o.status %>">
              <% if (o.status === 'ativo') { %>Ativo<% } %>
              <% if (o.status === 'incompleto') { %>Incompleto<% } %>
              <% if (o.status === 'erro') { %>Erro<% } %>
            </span>
          </div>

          <!-- Mini-resumo: ID | Bots | Tipo  +  botão (…) ao lado -->
          <div class="meta meta-line">
            <span class="meta-text">
              ID: <%= idShort %> &nbsp;|&nbsp; Bots: <%= botCount %> &nbsp;|&nbsp; Tipo: <%= botLabel %>
            </span>
            <button
              type="button"
              class="offer-actions-inline"
              title="Gerenciar"
              onclick="event.preventDefault(); event.stopPropagation(); window.tfOpenOfferManager(this);"
            >
              <!-- ícone minimalista TigerFy -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <circle cx="5" cy="12" r="2"></circle>
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="19" cy="12" r="2"></circle>
              </svg>
            </button>
          </div>

          <span class="go">›</span>
        </a>
      <% }) %>
    <% } %>
  </div>
</div>

// Renomear oferta
router.post("/ofertas/:id/renomear", authGuard, async (req, res) => {
  try {
    const owner = req.session.userId;
    const { id } = req.params;
    const { novoNome } = req.body || {};
    if (!novoNome || !String(novoNome).trim()) {
      return res.status(400).json({ ok: false, error: "invalid_name" });
    }

    // Confirma que a oferta é do usuário
    const { data: exists, error: getErr } = await supabase
      .from("offers")
      .select("id, owner")
      .eq("id", id)
      .eq("owner", owner)
      .single();
    if (getErr || !exists) return res.status(404).json({ ok: false, error: "not_found" });

    const { data, error } = await supabase
      .from("offers")
      .update({ name: String(novoNome).trim() })
      .eq("id", id)
      .eq("owner", owner)
      .select("id, name")
      .single();

    if (error) return res.status(500).json({ ok: false, error: error.message });
    return res.json({ ok: true, offer: data });
  } catch (err) {
    console.error("rename error:", err);
    return res.status(500).json({ ok: false, error: "server_error" });
  }
});

// Excluir oferta (remove etapas antes se não houver ON DELETE CASCADE)
router.post("/ofertas/:id/excluir", authGuard, async (req, res) => {
  try {
    const owner = req.session.userId;
    const { id } = req.params;

    const { data: exists, error: getErr } = await supabase
      .from("offers")
      .select("id, owner")
      .eq("id", id)
      .eq("owner", owner)
      .single();
    if (getErr || !exists) return res.status(404).json({ ok: false, error: "not_found" });

    // Apaga etapas relacionadas (seguro para ausência de CASCADE)
    await supabase.from("offer_steps").delete().eq("offer_id", id);

    const { error } = await supabase
      .from("offers")
      .delete()
      .eq("id", id)
      .eq("owner", owner);

    if (error) return res.status(500).json({ ok: false, error: error.message });
    return res.json({ ok: true });
  } catch (err) {
    console.error("delete offer error:", err);
    return res.status(500).json({ ok: false, error: "server_error" });
  }
});

// Duplicar oferta
router.post("/ofertas/:id/duplicar", authGuard, async (req, res) => {
  try {
    const owner = req.session.userId;
    const { id } = req.params;

    // Carrega original
    const { data: orig, error: getErr } = await supabase
      .from("offers")
      .select("id, owner, name, bot_type, tracking_type, status, telegram_username, bot_token")
      .eq("id", id)
      .eq("owner", owner)
      .single();

    if (getErr || !orig) return res.status(404).json({ ok: false, error: "not_found" });

    const payload = {
      owner: orig.owner,
      name: `${orig.name} (cópia)`,
      bot_type: orig.bot_type || "bot_padrao",
      tracking_type: orig.tracking_type || "fb_pixel",
      status: orig.status || "incompleto",
      telegram_username: orig.telegram_username || null,
      bot_token: orig.bot_token || null
    };

    const { data: created, error: insErr } = await supabase
      .from("offers")
      .insert([payload])
      .select("id, owner, name, bot_type, tracking_type, status, telegram_username, bot_token")
      .single();

    if (insErr) return res.status(500).json({ ok: false, error: insErr.message });

    // (Opcional futuro: duplicar offer_steps, configs, etc.)

    return res.json({ ok: true, offer: created });
  } catch (err) {
    console.error("duplicate offer error:", err);
    return res.status(500).json({ ok: false, error: "server_error" });
  }
});

