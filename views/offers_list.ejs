<%- include('partials/visual_hottrack') %>

<div class="tiger-offers-list">
  <div class="list-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Lista simples e objetiva das suas ofertas. Clique para abrir o painel premium da oferta.</p>
    </div>
    <a href="/ofertas/criar" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="list-grid" id="offersGrid">
    <% if (!offers || offers.length === 0) { %>
      <div class="empty">
        <h3>Você ainda não tem ofertas</h3>
        <p>Crie sua primeira oferta para começar.</p>
        <a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>
      </div>
    <% } else { %>
      <% offers.forEach(function(o){ const botsCount = (o.botsCount ?? 0); %>
        <a
          class="offer-card"
          href="/ofertas/painel/<%= o._id %>"
          id="offer-card-<%= o._id %>"
          data-offer-id="<%= o._id %>"
          data-offer-name="<%= o.name %>"
          data-bot-type="<%= o.botType %>"
          data-tracking-type="<%= o.trackingType %>"
          data-bots-count="<%= botsCount %>"
        >
          <div class="card-top">
            <h3 class="offer-name" data-offer-id="<%= o._id %>"><%= o.name %></h3>
            <span class="status <%= o.status %>">
              <% if (o.status === 'ativo') { %>Ativo<% } %>
              <% if (o.status === 'incompleto') { %>Incompleto<% } %>
              <% if (o.status === 'erro') { %>Erro<% } %>
            </span>
          </div>

          <div class="meta">
            <span>ID: <%= String(o._id).slice(-6) %></span>
            <span> | </span>
            <span>Bots: <%= botsCount %></span>
            <span> | </span>
            <span>Tipo:
              <% if (o.botType === 'bot_padrao') { %>Padrão<% }
                 else if (o.botType === 'bot_fluxo_wiin') { %>Fluxo<% }
                 else { %>Fluxo<% } %>
            </span>

            <!-- Botão de ações (…) (inline, minimalista) -->
            <button
              type="button"
              class="offer-actions-inline"
              title="Gerenciar oferta"
              aria-label="Gerenciar oferta"
              data-id="<%= o._id %>"
              data-name="<%= o.name %>"
              data-bots="<%= botsCount %>"
              data-bottype="<%= o.botType %>"
              data-tracktype="<%= o.trackingType %>"
              onclick="event.preventDefault(); event.stopPropagation(); openManageOfferModal(this);"
            >
              <span class="dots">•••</span>
            </button>
          </div>

          <span class="go">›</span>
        </a>
      <% }) %>
    <% } %>
  </div>
</div>

<!-- Toasts -->
<div id="tf-toasts" class="tf-toasts"></div>

 /* ================================
     MODAL MINIMALISTA (override)
     — mantêm visual da tela “Criar oferta”
     — alta especificidade pra garantir efeito
     ================================ */
  .modal-gerenciar-oferta{ position:fixed; inset:0; display:none; z-index:9999; }
  .modal-gerenciar-oferta[aria-hidden="false"]{ display:block; }
  .modal-gerenciar-oferta .modal-backdrop{
    position:absolute; inset:0; backdrop-filter: blur(6px); background:rgba(0,0,0,0.45) !important;
  }
  .modal-gerenciar-oferta .modal-card{
    position:absolute; inset:0; margin:auto;
    width:min(640px, calc(100vw - 48px));
    background:rgba(0,0,0,0.78) !important;
    border:1px solid rgba(255,204,0,0.16) !important;
    border-radius:16px !important;
    box-shadow:0 0 40px rgba(0,0,0,0.60) !important;
    color:#fff;
    display:flex; flex-direction:column;
    overflow:hidden;   /* remove “barrigão” */
  }
  .modal-gerenciar-oferta .m-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 16px 10px 16px; border-bottom:1px solid rgba(255,204,0,0.10);
  }
  .modal-gerenciar-oferta .m-titles h3{ margin:0; color:#ffcc00; font-size:1.08rem; }
  .modal-gerenciar-oferta .m-sub{ margin:4px 0 0; color:#b4b4b4; font-size:.92rem; }

  /* X 100% centralizado */
  .modal-gerenciar-oferta .m-close{
    width:28px; height:28px; border-radius:999px;
    border:1px solid rgba(255,204,0,0.22);
    background:rgba(255,204,0,0.08);
    color:#ffcc00; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    line-height:0; padding:0;
  }
  .modal-gerenciar-oferta .m-close span{ display:block; font-size:18px; line-height:1; transform:translateY(-0.5px); }

  .modal-gerenciar-oferta .m-body{ padding:14px 16px 16px; display:grid; gap:14px; }
  .modal-gerenciar-oferta .m-section h4{ margin:0 0 8px; font-size:.98rem; }
  .modal-gerenciar-oferta .m-resume{ display:grid; gap:6px; color:#d6d6d6; font-size:.95rem; }

  .modal-gerenciar-oferta .m-label{ display:block; font-size:.95rem; font-weight:600; margin-bottom:6px; }
  .modal-gerenciar-oferta .m-label span{ color:#ffcc00; }
  .modal-gerenciar-oferta .m-input{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.06);
    color:#fff; outline:none; font-size:.95rem;
    transition:border-color .2s, box-shadow .2s;
  }
  .modal-gerenciar-oferta .m-input::placeholder{ color:rgba(255,255,255,0.65); }
  .modal-gerenciar-oferta .m-input:focus{
    border-color:#ffcc00; box-shadow:0 0 0 2px rgba(255,204,0,0.28);
  }

  .modal-gerenciar-oferta .m-actions{ display:flex; align-items:center; gap:10px; margin-top:10px; }
  .modal-gerenciar-oferta .m-sep{ height:1px; background:rgba(255,255,255,0.08); margin:2px 0; }

  .modal-gerenciar-oferta .btn-gold{
    border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer;
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#1a1300; box-shadow:0 0 12px rgba(255,204,0,0.35);
  }
  .modal-gerenciar-oferta .btn-gold.slim{ padding:8px 18px; }

  .modal-gerenciar-oferta .btn-danger{
    border:none; border-radius:10px; padding:9px 18px; font-weight:600; cursor:pointer;
    background:linear-gradient(90deg,#ff3b6b,#cc2a50); color:#fff; box-shadow:0 0 12px rgba(255,59,107,.22);
  }
  .modal-gerenciar-oferta .m-muted{ color:#b4b4b4; margin:0 0 6px; }
  .modal-gerenciar-oferta .m-warning{ color:#ff6b9e; margin:0 0 6px; }

  @media (max-width: 980px){
    .modal-gerenciar-oferta .modal-card{ width:calc(100vw - 24px); }
  }
</style>

<script>
  let CURRENT_OFFER = null;

  function qs(id){ return document.getElementById(id); }
  function toast(msg, type='success'){
    const box = document.getElementById('tf-toasts');
    const el = document.createElement('div');
    el.className = 'tf-toast ' + (type==='error' ? 'error':'success');
    el.textContent = msg;
    box.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 2200);
    setTimeout(()=>{ el.remove(); }, 2600);
  }

  function openManageOfferModal(btn){
    const id = btn.dataset.id;
    const name = btn.dataset.name || '—';
    const bots = btn.dataset.bots || '0';
    const botType = mapBotType(btn.dataset.bottype);
    CURRENT_OFFER = { id, name };

    qs('resumeName').textContent = name;
    qs('resumeId').textContent = id;
    qs('resumeBots').textContent = bots;
    qs('resumeBotType').textContent = botType;

    qs('newOfferName').value = name;
    qs('renameError').style.display='none';
    qs('duplicateError').style.display='none';
    qs('deleteError').style.display='none';

    qs('manageOfferModal').setAttribute('aria-hidden', 'false');
  }
  function closeManageOfferModal(){
    qs('manageOfferModal').setAttribute('aria-hidden', 'true');
    CURRENT_OFFER = null;
  }

  function mapBotType(t){
    if(t === 'bot_padrao') return 'Padrão';
    if(t === 'bot_fluxo_wiin') return 'Fluxo';
    return 'Fluxo';
  }

  async function submitRename(){
    const err = qs('renameError'); err.style.display='none';
    if(!CURRENT_OFFER) return;

    const novoNome = (qs('newOfferName').value || '').trim();
    if(!novoNome){ err.textContent='Informe um nome válido.'; err.style.display='inline'; return; }

    try{
      const res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/renomear`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ novoNome })
      });
      const j = await res.json();
      if(!j || j.ok !== true) throw new Error(j?.error || 'Falha ao renomear');

      document.querySelectorAll(`.offer-name[data-offer-id="${CURRENT_OFFER.id}"]`)
        .forEach(el => el.textContent = novoNome);

      toast('Oferta renomeada com sucesso.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível renomear. Tente novamente.';
      err.style.display='inline';
    }
  }

  async function submitDuplicate(){
    const err = qs('duplicateError'); err.style.display='none';
    if(!CURRENT_OFFER) return;

    try{
      const res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/duplicar`, { method: 'POST' });
      const j = await res.json();
      if(!j || j.ok !== true || !j.offer){ throw new Error(j?.error || 'Falha ao duplicar'); }

      const o = j.offer;
      const botsCount = o.botsCount ?? 0;
      const botLabel = mapBotType(o.bot_type || o.botType);

      const card = document.createElement('a');
      card.className = 'offer-card';
      card.href = `/ofertas/painel/${o.id}`;
      card.id = `offer-card-${o.id}`;
      card.dataset.offerId = o.id;
      card.dataset.offerName = o.name;
      card.dataset.botType = o.bot_type || o.botType;
      card.dataset.trackingType = o.tracking_type || o.trackingType;
      card.dataset.botsCount = botsCount;

      card.innerHTML = `
        <div class="card-top">
          <h3 class="offer-name" data-offer-id="${o.id}">${o.name}</h3>
          <span class="status ${o.status || 'incompleto'}">${(o.status==='ativo'?'Ativo':(o.status==='erro'?'Erro':'Incompleto'))}</span>
        </div>
        <div class="meta">
          <span>ID: ${String(o.id).slice(-6)}</span><span> | </span>
          <span>Bots: ${botsCount}</span><span> | </span>
          <span>Tipo: ${botLabel}</span>
          <button type="button" class="offer-actions-inline"
            title="Gerenciar oferta" aria-label="Gerenciar oferta"
            data-id="${o.id}" data-name="${o.name}" data-bots="${botsCount}"
            data-bottype="${o.bot_type || o.botType}" data-tracktype="${o.tracking_type || o.trackingType}"
            onclick="event.preventDefault(); event.stopPropagation(); openManageOfferModal(this);">
            <span class="dots">•••</span>
          </button>
        </div>
        <span class="go">›</span>
      `;
      document.getElementById('offersGrid').prepend(card);

      toast('Oferta duplicada.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível duplicar. Tente novamente.';
      err.style.display='inline';
    }
  }

  async function submitDelete(){
    const err = qs('deleteError'); err.style.display='none';
    if(!CURRENT_OFFER) return;

    if(!confirm('Tem certeza que deseja excluir esta oferta? Esta ação é permanente.')) return;

    try{
      let res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}`, { method:'DELETE' });
      if(res.status === 404){
        res = await fetch(`/ofertas/${encodeURIComponent(CURRENT_OFFER.id)}/excluir`, { method:'POST' });
      }
      const j = await res.json();
      if(!j || j.ok !== true){ throw new Error(j?.error || 'Falha ao excluir'); }

      const card = document.getElementById(`offer-card-${CURRENT_OFFER.id}`);
      if(card) card.remove();

      toast('Oferta excluída.');
      closeManageOfferModal();
    }catch(e){
      err.textContent='Não foi possível excluir. Tente novamente.';
      err.style.display='inline';
    }
  }
</script>
