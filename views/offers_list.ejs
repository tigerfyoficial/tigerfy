<%- include('partials/visual_hottrack') %>

<div class="tiger-offers-list">
  <div class="list-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Lista simples e objetiva das suas ofertas. Clique para abrir o painel premium da oferta.</p>
    </div>
    <a href="/ofertas/criar" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="list-grid">
    <% if (!offers || offers.length === 0) { %>
      <div class="empty">
        <h3>Você ainda não tem ofertas</h3>
        <p>Crie sua primeira oferta para começar.</p>
        <a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>
      </div>
    <% } else { %>
      <% offers.forEach(function(o){ %>
        <a class="offer-card" href="/ofertas/painel/<%= o._id %>" data-offer-id="<%= o._id %>">
          <div class="card-top">
            <h3 class="offer-name"><%= o.name %></h3>

            <!-- Botão … minimalista (ícone pequeno, sem animação de movimento) -->
            <button
              type="button"
              class="offer-actions-inline"
              title="Ações"
              aria-label="Ações da oferta"
              data-offer-id="<%= o._id %>"
              data-offer-name="<%- o.name %>"
              data-offer-type="<%- o.botType %>"
              data-offer-bots="<%- (typeof o.botsCount !== 'undefined' ? o.botsCount : 0) %>"
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <circle cx="12" cy="5" r="2"></circle>
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="12" cy="19" r="2"></circle>
              </svg>
            </button>
          </div>

          <div class="meta">
            <span>ID: <%= String(o._id).slice(-6) %></span>
            <span> | </span>
            <span>Bots: <%= (typeof o.botsCount !== 'undefined' ? o.botsCount : 0) %></span>
            <span> | </span>
            <span>Tipo: 
              <% if (o.botType === 'bot_padrao') { %>Padrão<% } else if (o.botType === 'bot_fluxo_wiin') { %>Fluxo (Wiinbot)<% } else if (o.botType === 'bot_fluxo_manychat') { %>Fluxo (Manychat)<% } else { %>Padrão<% } %>
            </span>
          </div>

          <span class="go">›</span>
        </a>
      <% }) %>
    <% } %>
  </div>
</div>

<!-- Mini menu de ações (já existente no projeto) -->
<div id="offer-actions-menu" class="offer-actions-menu" hidden>
  <button type="button" data-action="rename">Renomear oferta</button>
  <button type="button" data-action="duplicate">Duplicar oferta</button>
  <button type="button" data-action="delete" class="danger">Excluir oferta</button>
</div>

<style>
  .tiger-offers-list{
    padding:60px 80px 100px 130px;
    max-width:calc(100vw - 120px);
    margin:0 auto;
    color:#fff;
  }
  .list-header{
    display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;
  }
  .list-header h1{ margin:0 0 6px; font-size:2rem; color:#ffcc00; }
  .list-header p{ margin:0; color:#b4b4b4; font-size:.95rem; }

  .list-grid{
    display:grid; gap:12px;
    grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  }
  .offer-card{
    position:relative;
    display:block; text-decoration:none; color:#fff;
    background:rgba(0,0,0,0.70);
    border:1px solid rgba(255,204,0,0.12);
    border-radius:16px; padding:14px;
    transition:.2s;
  }
  .offer-card:hover{ border-color:#ffcc00; box-shadow:0 0 16px rgba(255,204,0,0.3); }
  .card-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .card-top .offer-name{ margin:0; font-size:1rem; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

  .meta{
    display:flex; gap:0; flex-wrap:wrap; margin-top:8px;
    font-size:.78rem; color:#c9c9c9;
  }
  .go{ position:absolute; right:12px; bottom:10px; opacity:.6; font-size:1.4rem; }
  .empty{ text-align:center; padding:30px 16px; background:rgba(0,0,0,0.70); border:1px solid rgba(255,204,0,0.12); border-radius:16px; }
  .btn-primary.small{ padding:8px 16px; font-size:.85rem; }
  .btn-primary{
    border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer; text-decoration:none;
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#1a1300; box-shadow:0 0 12px rgba(255,204,0,0.4); font-size:.95rem;
  }

  /* ===== Botão … minimalista (sem movimento) ===== */
  .offer-actions-inline{
    margin-left:8px;
    flex:0 0 28px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:28px; height:28px;
    border:0; border-radius:999px;
    background:transparent;
    color:rgba(255,255,255,.78);
    opacity:.9;
    cursor:pointer;
    transition: opacity .12s ease, background-color .12s ease, box-shadow .12s ease;
  }
  .offer-actions-inline:hover{
    opacity:1;
    background:rgba(255,255,255,.07);
    box-shadow:0 0 0 1px rgba(255,204,0,.18) inset;
  }
  .offer-actions-inline:focus-visible{
    outline:none;
    box-shadow:0 0 0 2px rgba(255,204,0,.28);
  }
  .offer-actions-inline svg{
    display:block; width:14px; height:14px; pointer-events:none;
  }
  /* blindagem contra qualquer regra global que mova o botão */
  .offer-card .offer-actions-inline,
  .offer-card .offer-actions-inline:hover{
    transform:none !important;
    top:auto; bottom:auto;
  }

  /* ===== Mini menu flutuante das ações ===== */
  .offer-actions-menu{
    position:fixed; z-index:9999;
    min-width:200px;
    background:rgba(0,0,0,.84);
    backdrop-filter: blur(8px);
    border:1px solid rgba(255,204,0,.14);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.45), 0 0 18px rgba(255,204,0,.10) inset;
    padding:6px;
  }
  .offer-actions-menu button{
    width:100%; text-align:left;
    background:transparent; color:#e9e9e9;
    border:0; border-radius:10px;
    padding:10px 12px; font-size:.92rem;
    cursor:pointer;
    transition: background-color .12s ease, color .12s ease;
  }
  .offer-actions-menu button:hover{
    background:rgba(255,255,255,.06);
    color:#fff;
  }
  .offer-actions-menu button.danger:hover{
    background:rgba(255,0,76,.10); color:#ff6b9e;
  }
</style>

<script>
(function(){
  const grid = document.querySelector('.list-grid');
  const menu = document.getElementById('offer-actions-menu');
  let current = { id:null, name:null, el:null };

  // abre menu ancorado ao botão
  function openMenu(btn){
    const rect = btn.getBoundingClientRect();
    current = {
      id: btn.dataset.offerId,
      name: btn.dataset.offerName,
      el: btn.closest('.offer-card')
    };
    menu.hidden = false;
    // posiciona ao lado do botão
    const top = rect.bottom + 6;
    const left = Math.min(window.innerWidth - menu.offsetWidth - 12, rect.right - menu.offsetWidth + 28);
    menu.style.top = top + 'px';
    menu.style.left = Math.max(12, left) + 'px';
  }
  function closeMenu(){ menu.hidden = true; }

  // evitar que o clique no botão dispare o link do card
  grid?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.offer-actions-inline');
    if(!btn) return;
    e.preventDefault();
    e.stopPropagation();
    openMenu(btn);
  });

  // clique nos itens do menu
  menu?.addEventListener('click', async (e)=>{
    const item = e.target.closest('button[data-action]');
    if(!item) return;
    const action = item.dataset.action;
    if(!current.id) return;

    try{
      if(action === 'rename'){
        const novo = prompt('Novo nome da oferta:', current.name || '');
        if(!novo || !novo.trim()) return;
        const res = await fetch(`/ofertas/${current.id}/renomear`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ novoNome: novo.trim() })
        });
        if(!res.ok) throw new Error('Falha ao renomear');
        // atualiza no card sem recarregar
        const h3 = current.el.querySelector('.offer-name');
        if(h3) h3.textContent = novo.trim();
      }

      if(action === 'duplicate'){
        const res = await fetch(`/ofertas/${current.id}/duplicar`, { method:'POST' });
        if(!res.ok) throw new Error('Falha ao duplicar');
        // por simplicidade, recarrega para aparecer o novo card preservando layout
        location.reload();
      }

      if(action === 'delete'){
        if(!confirm('Tem certeza que deseja excluir esta oferta? Esta ação é permanente.')) return;
        const res = await fetch(`/ofertas/${current.id}`, { method:'DELETE' });
        if(!res.ok) throw new Error('Falha ao excluir');
        // remove card da lista
        current.el?.remove();
      }
    } catch(err){
      console.error(err);
      alert('Ocorreu um erro. Tente novamente.');
    } finally{
      closeMenu();
    }
  });

  // fecha menu em qualquer clique fora ou ESC
  document.addEventListener('click', (e)=>{
    if(menu.hidden) return;
    if(!e.target.closest('#offer-actions-menu') && !e.target.closest('.offer-actions-inline')) closeMenu();
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') closeMenu();
  });
})();
</script>
