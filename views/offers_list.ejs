<%- include('partials/visual_hottrack') %>

<div class="tiger-offers-list">
  <div class="list-header">
    <div>
      <h1>Minhas Ofertas</h1>
      <p>Lista simples e objetiva das suas ofertas. Clique para abrir o painel premium da oferta.</p>
    </div>
    <a href="/ofertas/criar" class="btn-primary">Criar nova oferta</a>
  </div>

  <div class="list-grid" id="offersGrid">
    <% if (!offers || offers.length === 0) { %>
      <div class="empty" id="emptyState">
        <h3>Você ainda não tem ofertas</h3>
        <p>Crie sua primeira oferta para começar.</p>
        <a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>
      </div>
    <% } else { %>
      <% offers.forEach(function(o){ 
           const botLabel = (o.botType === 'bot_padrao') 
             ? 'Padrão' 
             : (o.botType === 'bot_fluxo_wiin' ? 'Fluxo' : 'Fluxo');
           const idShort = String(o._id).slice(0,8); // exibe os 8 primeiros chars
           const botCount = (typeof o.botCount === 'number') 
                            ? o.botCount 
                            : ((typeof o.botsCount === 'number') ? o.botsCount : 0);
      %>
        <a 
          class="offer-card" 
          href="/ofertas/painel/<%= o._id %>"
          data-offer-id="<%= o._id %>"
          data-offer-name="<%- o.name %>"
          data-offer-bot-type-label="<%= botLabel %>"
          data-offer-bot-count="<%= botCount %>"
        >
          <div class="card-top">
            <h3 class="offer-title"><%- o.name %></h3>
            <span class="status <%= o.status %>">
              <% if (o.status === 'ativo') { %>Ativo<% } %>
              <% if (o.status === 'incompleto') { %>Incompleto<% } %>
              <% if (o.status === 'erro') { %>Erro<% } %>
            </span>
          </div>

          <!-- Mini-resumo único: ID | Bots | Tipo -->
          <div class="meta meta-single">
            ID: <%= idShort %> &nbsp;|&nbsp; Bots: <%= botCount %> &nbsp;|&nbsp; Tipo: <%= botLabel %>
          </div>

          <!-- Botão de ações “•••” FIXO no canto direito do card (fora da linha de infos) -->
          <button type="button" class="offer-actions" title="Gerenciar"
                  onclick="event.preventDefault(); event.stopPropagation(); window.tfOpenOfferManager(this);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <circle cx="5" cy="12" r="2"></circle>
              <circle cx="12" cy="12" r="2"></circle>
              <circle cx="19" cy="12" r="2"></circle>
            </svg>
          </button>

          <span class="go">›</span>
        </a>
      <% }) %>
    <% } %>
  </div>
</div>

<style>
  .tiger-offers-list{
    padding:60px 80px 100px 130px;
    max-width:calc(100vw - 120px);
    margin:0 auto;
    color:#fff;
  }
  .list-header{
    display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;
  }
  .list-header h1{ margin:0 0 6px; font-size:2rem; color:#ffcc00; }
  .list-header p{ margin:0; color:#b4b4b4; font-size:.95rem; }

  .list-grid{
    display:grid; gap:12px;
    grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
  }
  .offer-card{
    position:relative;
    display:block; text-decoration:none; color:#fff;
    background:rgba(0,0,0,0.70);
    border:1px solid rgba(255,204,0,0.12);
    border-radius:16px; padding:14px;
    transition:.2s;
  }
  .offer-card:hover{ border-color:#ffcc00; box-shadow:0 0 16px rgba(255,204,0,0.3); }
  .card-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .card-top h3{ margin:0; font-size:1rem; }
  .status{ font-size:.75rem; padding:3px 7px; border-radius:999px; }
  .status.ativo{ background:rgba(0,255,120,0.16); color:#4fff9a; }
  .status.incompleto{ background:rgba(255,196,0,0.16); color:#ffdd66; }
  .status.erro{ background:rgba(255,0,76,0.16); color:#ff6b9e; }

  .meta{
    display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;
    font-size:.78rem; color:#c9c9c9;
  }
  /* linha única de resumo (ID | Bots | Tipo) */
  .meta.meta-single{ gap:0; }

  .go{ position:absolute; right:12px; bottom:10px; opacity:.6; font-size:1.4rem; }

  .empty{ text-align:center; padding:30px 16px; background:rgba(0,0,0,0.70); border:1px solid rgba(255,204,0,0.12); border-radius:16px; }
  .btn-primary.small{ padding:8px 16px; font-size:.85rem; }
  .btn-primary{
    border:none; border-radius:10px; padding:10px 22px; font-weight:600; cursor:pointer; text-decoration:none;
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#1a1300; box-shadow:0 0 12px rgba(255,204,0,0.4); font-size:.95rem;
  }

  /* Botão “•••” fixo no canto direito superior do card (fora da linha de infos) */
  .offer-actions{
    position:absolute; top:10px; right:36px; /* mantém o › no canto inferior */
    display:inline-flex; align-items:center; justify-content:center;
    height:28px; min-width:28px; padding:0 8px; gap:4px;
    border-radius:999px;
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.14);
    color:#fff; cursor:pointer;
    transition: box-shadow .16s ease, transform .08s ease, background .16s ease, border-color .16s ease;
  }
  .offer-actions:hover{
    background:rgba(255,255,255,0.08);
    border-color:rgba(255,204,0,0.35);
    box-shadow:0 0 0 2px rgba(255,204,0,0.2), 0 10px 24px rgba(0,0,0,0.45);
  }
  .offer-actions:active{ transform:translateY(1px); }

  /* ------- Modal “Gerenciar Oferta” (mantém tema) ------- */
  .modal-offer-backdrop[hidden]{ display:none !important; }
  .modal-offer-backdrop{
    position:fixed; inset:0; z-index:3000;
    background:rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center;
  }
  .modal-offer{
    width:min(640px, 92vw);
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.14);
    background:
      radial-gradient(1200px 240px at 50% -80px, rgba(255,204,0,0.08), transparent),
      linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.045));
    box-shadow:0 20px 50px rgba(0,0,0,0.55);
    transform: translateY(8px) scale(.985);
    opacity:0;
    transition: transform .16s ease, opacity .16s ease;
  }
  .modal-offer.show{ transform: translateY(0) scale(1); opacity:1; }

  .modal-offer-head{
    display:flex; align-items:center; justify-content:space-between; padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,0.1);
  }
  .modal-offer-head h3{ margin:0; font-size:1.1rem; color:#fff; letter-spacing:.3px; }
  .modal-offer-head p{ margin:6px 0 0; font-size:.85rem; color:#cfcfcf; }

  /* X centralizado visualmente sem mudar tamanho */
  .modal-offer-close{
    appearance:none;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    color:#fff; height:30px; width:30px; border-radius:10px; cursor:pointer; transition:.16s ease;
    display:flex; align-items:center; justify-content:center; line-height:1;
  }
  .modal-offer-close:hover{ background:rgba(255,255,255,0.08); }

  .modal-offer-body{ padding:14px 16px 6px; display:flex; flex-direction:column; gap:14px; }
  .section{
    padding:12px; border-radius:14px; 
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
    border:1px solid rgba(255,255,255,0.14);
  }
  .section h4{ margin:0 0 8px; font-size:.98rem; color:#fff; }
  .section .row{ display:flex; gap:8px; flex-wrap:wrap; font-size:.92rem; color:#dcdcdc; }
  .section .row .label{ color:#fff; font-weight:700; }

  .input{
    width:100%; padding:10px 12px; border-radius:10px;
    background: rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.16);
  }
  .input:focus{
    border-color: rgba(255,204,0,0.6); box-shadow: 0 0 0 2px rgba(255,204,0,0.20); outline: none;
  }
  .modal-offer-actions{ display:flex; justify-content:flex-end; gap:10px; padding:0 16px 16px; }

  .btn{ 
    appearance:none; border:1px solid rgba(255,255,255,0.14); background:rgba(255,255,255,0.06);
    color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.16s ease;
  }
  .btn:hover{ background:rgba(255,255,255,0.08); }
  .btn-primary{
    background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300; border:1px solid rgba(255,204,0,0.35);
    box-shadow:0 6px 22px rgba(255,204,0,0.25);
  }
  .btn-danger{
    border-color: rgba(255, 75, 75, .35); background: linear-gradient(90deg, #3a0000, #2a0000); color: #ffdada;
  }

  .danger-box{
    margin-top:8px; padding:10px; border-radius:10px;
    background: linear-gradient(180deg, rgba(255,0,0,0.06), rgba(255,0,0,0.04));
    border:1px solid rgba(255,0,0,0.18); color:#ffbaba; font-size:.9rem;
  }

  /* Toast premium (reuso) */
  .tf-toast-host{ position:fixed; top:20px; right:20px; z-index:4000; display:flex; flex-direction:column; gap:10px; }
  .tf-toast{
    padding:10px 14px; border-radius:12px; border:1px solid rgba(255,204,0,0.35);
    box-shadow:0 10px 30px rgba(0,0,0,0.45);
    font-weight:800; letter-spacing:.3px; 
    transform:translateY(-6px) scale(.98); opacity:0;
    transition: transform .16s ease, opacity .16s ease;
  }
  .tf-toast.success{ background:linear-gradient(90deg,#ffcc00,#d4a100); color:#171300; }
  .tf-toast.error{ background:linear-gradient(90deg,#3a0000,#2a0000); color:#ffd5d5; border-color:rgba(255,120,120,0.35); }
  .tf-toast.show{ transform:translateY(0) scale(1); opacity:1; }
</style>

<!-- Modal Gerenciar Oferta (mantido, com X centralizado e campos revisados) -->
<div class="modal-offer-backdrop" id="offerManager" hidden>
  <div class="modal-offer" id="offerManagerBox" role="dialog" aria-modal="true" aria-labelledby="offerManagerTitle">
    <div class="modal-offer-head">
      <div>
        <h3 id="offerManagerTitle">Gerenciar Oferta</h3>
        <p>Veja o resumo desta oferta e gerencie as ações rápidas.</p>
      </div>
      <button class="modal-offer-close" id="btnOfferManagerClose" aria-label="Fechar">✕</button>
    </div>

    <div class="modal-offer-body">
      <!-- Resumo -->
      <div class="section" id="secResumo">
        <h4>Resumo da Oferta</h4>
        <div class="row"><span class="label">Nome atual:</span> <span id="rsNome">—</span></div>
        <div class="row"><span class="label">ID:</span> <span id="rsId">—</span></div>
        <div class="row"><span class="label">Quantidade de bots vinculados:</span> <span id="rsBots">—</span></div>
        <div class="row"><span class="label">Tipo de Bot:</span> <span id="rsTipo">—</span></div>
      </div>

      <!-- Renomear -->
      <div class="section">
        <h4>Renomear Oferta</h4>
        <label for="novoNome" class="sr-only" style="position:absolute;left:-9999px">Novo nome da oferta</label>
        <input id="novoNome" class="input" type="text" placeholder="Ex: Mundo VIP 2.0, Oferta Principal, etc..." />
        <div class="modal-offer-actions" style="padding:10px 0 0">
          <button class="btn btn-primary" id="btnSalvarNome">Salvar novo nome</button>
        </div>
      </div>

      <!-- Excluir -->
      <div class="section">
        <h4>Excluir Oferta</h4>
        <div class="danger-box">Cuidado: esta ação é permanente.</div>
        <div class="modal-offer-actions" style="padding:10px 0 0; justify-content:flex-start">
          <button class="btn btn-danger" id="btnExcluir">Excluir oferta</button>
        </div>
      </div>
    </div>

    <div class="modal-offer-actions">
      <button class="btn" id="btnFecharModal">Fechar</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- Toast premium ---------- */
  function showToast(type, text){
    var host = document.querySelector('.tf-toast-host');
    if (!host){ host = document.createElement('div'); host.className='tf-toast-host'; document.body.appendChild(host); }
    var t = document.createElement('div');
    t.className = 'tf-toast ' + (type==='error' ? 'error' : 'success');
    t.textContent = text || (type==='error' ? 'Falha' : 'Sucesso');
    host.appendChild(t);
    requestAnimationFrame(function(){ t.classList.add('show'); });
    setTimeout(function(){
      t.classList.remove('show');
      setTimeout(function(){ t.remove(); }, 160);
    }, 2300);
  }

  /* ---------- Modal refs ---------- */
  var backdrop   = document.getElementById('offerManager');
  var box        = document.getElementById('offerManagerBox');
  var btnClose   = document.getElementById('btnOfferManagerClose');
  var btnFechar  = document.getElementById('btnFecharModal');

  var rsNome = document.getElementById('rsNome');
  var rsId   = document.getElementById('rsId');
  var rsBots = document.getElementById('rsBots');
  var rsTipo = document.getElementById('rsTipo');

  var inputNome = document.getElementById('novoNome');
  var btnSalvarNome = document.getElementById('btnSalvarNome');

  var btnExcluir = document.getElementById('btnExcluir');

  var offersGrid = document.getElementById('offersGrid');
  var emptyState = document.getElementById('emptyState');

  var state = { offerId: null, anchorEl: null };

  function openModal(){ 
    if (!backdrop || !box) return;
    backdrop.removeAttribute('hidden');
    requestAnimationFrame(function(){ box.classList.add('show'); });
  }
  function closeModal(){
    if (!backdrop || !box) return;
    box.classList.remove('show');
    setTimeout(function(){ backdrop.setAttribute('hidden',''); }, 140);
  }

  if (btnClose) btnClose.addEventListener('click', closeModal);
  if (btnFechar) btnFechar.addEventListener('click', closeModal);
  if (backdrop){
    backdrop.addEventListener('click', function(e){ if (e.target === backdrop) closeModal(); });
  }

  /* ---------- Abrir modal a partir do card ---------- */
  window.tfOpenOfferManager = function(btn){
    var card = btn.closest('.offer-card');
    if (!card) return;

    var id   = card.getAttribute('data-offer-id') || '';
    var name = card.getAttribute('data-offer-name') || '';
    var tipoLabel = card.getAttribute('data-offer-bot-type-label') || '';
    var botCount = card.getAttribute('data-offer-bot-count');
    botCount = (botCount === null || botCount === '') ? '0' : botCount;

    state.offerId = id;
    state.anchorEl = card;

    rsNome.textContent = name || '—';
    rsId.textContent   = id || '—';
    rsBots.textContent = botCount;
    rsTipo.textContent = tipoLabel || '—';

    inputNome.value = name || '';
    openModal();
  };

  /* ---------- Renomear oferta ---------- */
  async function renameOffer(id, novoNome){
    const res = await fetch('/ofertas/' + encodeURIComponent(id) + '/renomear', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ novoNome })
    });
    if (!res.ok) throw new Error('rename_failed');
    const js = await res.json().catch(()=>({ ok:true }));
    if (js && js.ok === false) throw new Error('rename_failed');
    return js;
  }

  btnSalvarNome && btnSalvarNome.addEventListener('click', async function(){
    if (!state.offerId) return;
    const newName = (inputNome.value || '').trim();
    if (!newName){ inputNome.focus(); return; }

    btnSalvarNome.disabled = true; 
    const prevLabel = btnSalvarNome.textContent; 
    btnSalvarNome.textContent = 'Salvando…';

    try{
      await renameOffer(state.offerId, newName);

      // Atualiza o card (título e data-attrs)
      if (state.anchorEl){
        const titleEl = state.anchorEl.querySelector('.offer-title');
        if (titleEl) titleEl.textContent = newName;
        state.anchorEl.setAttribute('data-offer-name', newName);
      }
      rsNome.textContent = newName;

      showToast('success','Nome da oferta atualizado.');
      closeModal();
    }catch(e){
      console.error(e);
      showToast('error','Não foi possível renomear.');
    }finally{
      btnSalvarNome.disabled = false; 
      btnSalvarNome.textContent = prevLabel;
    }
  });

  /* ---------- Excluir oferta (confirmação) ---------- */
  async function deleteOffer(id){
    // Tenta DELETE /ofertas/:id e fallback POST /ofertas/:id/excluir
    const try1 = await fetch('/ofertas/' + encodeURIComponent(id), { method:'DELETE' });
    if (try1.ok) return;
    const try2 = await fetch('/ofertas/' + encodeURIComponent(id) + '/excluir', { method:'POST' });
    if (!try2.ok) throw new Error('delete_failed');
  }

  btnExcluir && btnExcluir.addEventListener('click', async function(){
    if (!state.offerId) return;
    const ok = window.confirm('Tem certeza que deseja excluir esta oferta? Esta ação é permanente.');
    if (!ok) return;

    btnExcluir.disabled = true;
    try{
      await deleteOffer(state.offerId);

      // Remove card da grid
      if (state.anchorEl){ state.anchorEl.remove(); }

      // Se ficou vazio, mostra vazio
      if (offersGrid && offersGrid.querySelectorAll('.offer-card').length === 0){
        if (!emptyState){
          const div = document.createElement('div');
          div.className = 'empty';
          div.innerHTML = '<h3>Você ainda não tem ofertas</h3><p>Crie sua primeira oferta para começar.</p><a href="/ofertas/criar" class="btn-primary small">Criar oferta</a>';
          offersGrid.appendChild(div);
        } else {
          emptyState.removeAttribute('hidden');
        }
      }

      showToast('success','Oferta excluída com sucesso.');
      closeModal();
    }catch(e){
      console.error(e);
      showToast('error','Não foi possível excluir.');
    }finally{
      btnExcluir.disabled = false;
    }
  });
})();
</script>
